---
title: "Data Collection Notes - Ethiopia"
author: ""
output:
  html_document: default

always_allow_html: yes
  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
#load relevant libraries
library(knitr)
library(tidyverse)
library(haven)
library(plotly)
library(naniar)
library(crosstalk)
library(leaflet)
library(Hmisc)
library(kableExtra)
library(DT)
library(mice)
library(stargazer)
library(gt)
library(wbstats)
library(geosphere)
library(rpart)       # performing regression trees
library(rpart.plot)  # plotting regression trees
library(randomForest)
library(caret)
library(modelr)
#Load the data

#read in school level file with sampling information
#currentDate<-c("2019-07-22")
#sample_frame_name <- paste("C:/Users/WB469649/WBG/Ezequiel Molina - Dashboard (Team Folder)/Country_Work/Peru/2019/Data/sampling/school_sample_",currentDate,".RData", sep="")


```


```{r data2021}

#Country name and year of survey
country <-'ETH'
country_name <- "Ethiopia"
year <- '2021'


#Add your UPI here and set the directory paths of your choice.
if (str_to_lower(Sys.getenv("USERNAME")) == "wb469649"){
  #project_folder  <- "//wbgfscifs01/GEDEDU/datalib-edu/projects/gepd"
  project_folder  <- "C:/Users/wb469649/WBG/HEDGE Files - HEDGE Documents/GEPD-Confidential/CNT/"
  download_folder <-file.path(paste(project_folder,country,paste(country,year,"GEPD", sep="_"),paste(country,year,"GEPD_v01_RAW", sep="_"),"Data/raw/School", sep="/"))
  confidential_folder <- file.path(paste(project_folder,country,paste(country,year,"GEPD", sep="_"),paste(country,year,"GEPD_v01_RAW", sep="_"),"Data/confidential/School", sep="/"))
  save_folder <- file.path(paste(project_folder,country,paste(country,year,"GEPD", sep="_"),paste(country,year,"GEPD_v01_RAW", sep="_"),"Data/anonymized/School", sep="/"))
  backup_onedrive="no"
  save_folder_onedrive <- file.path(paste("C:/Users/wb469649/WBG/Ezequiel Molina - Dashboard (Team Folder)/Country_Work/",country_name,year,"Data/clean/School", sep="/"))
  
} else if (str_to_lower(Sys.getenv("USERNAME")) == "wb577189"){

    project_folder  <- "C:/Users/wb577189/OneDrive - WBG/CNT/"
    
    download_folder <-file.path(paste(project_folder,country,paste(country,year,"GEPD", sep="_"),paste(country,year,"GEPD_v01_RAW", sep="_"),"Data/raw/School", sep="/"))
    
    confidential_folder <- file.path(paste(project_folder,country,paste(country,year,"GEPD", sep="_"),paste(country,year,"GEPD_v01_RAW", sep="_"),"Data/confidential/School", sep="/"))
    
    save_folder <- file.path(paste(project_folder,country,paste(country,year,"GEPD", sep="_"),paste(country,year,"GEPD_v01_RAW", sep="_"),"Data/anonymized/School", sep="/"))
    
    backup_onedrive="no"
    
    save_folder_onedrive <- file.path(paste("C:/Users/wb577189/OneDrive - WBG/My files/Dashboard (Team Folder)/Country_Work/",country_name,year,"Data/clean/School", sep="/"))
    
    
  }else {
  download_folder <- choose.dir(default = "", caption = "Select folder to open data downloaded from API")
  save_folder <- choose.dir(default = "", caption = "Select folder to save final data")
  
}

#attach saved results
attach(paste0(confidential_folder, "/school_indicators_data.Rdata"))
school_gdp_2021 <- school_gdp
school_dta_2021 <- school_dta_short %>%
  left_join(school_gdp_2021)

currentDate<-c("2020-02-14")
sample_folder <- file.path(paste(project_folder,country,paste(country,year,"GEPD", sep="_"),paste(country,year,"GEPD_v01_RAW", sep="_"),"Data/sampling/", sep="/"))
sample_frame_name <- paste(sample_folder,"/school_sample_",currentDate,".RData", sep="")
weights_df  <- read_csv(paste(sample_folder,"/Ethiopia_weights.csv", sep="")) %>%
  select(-sample) #variable name causes conflict
load(sample_frame_name)

```

```{r data2020}

#Country name and year of survey
country <-'ETH'
country_name <- "Ethiopia"
year <- '2020'


#Add your UPI here and set the directory paths of your choice.
if (str_to_lower(Sys.getenv("USERNAME")) == "wb469649"){
  #project_folder  <- "//wbgfscifs01/GEDEDU/datalib-edu/projects/gepd"
  project_folder  <- "C:/Users/wb469649/WBG/HEDGE Files - HEDGE Documents/GEPD-Confidential/CNT/"
  download_folder <-file.path(paste(project_folder,country,paste(country,year,"GEPD", sep="_"),paste(country,year,"GEPD_v01_RAW", sep="_"),"Data/raw/School", sep="/"))
  confidential_folder <- file.path(paste(project_folder,country,paste(country,year,"GEPD", sep="_"),paste(country,year,"GEPD_v01_RAW", sep="_"),"Data/confidential/School", sep="/"))
  save_folder <- file.path(paste(project_folder,country,paste(country,year,"GEPD", sep="_"),paste(country,year,"GEPD_v01_RAW", sep="_"),"Data/anonymized/School", sep="/"))
  backup_onedrive="no"
  save_folder_onedrive <- file.path(paste("C:/Users/wb469649/WBG/Ezequiel Molina - Dashboard (Team Folder)/Country_Work/",country_name,year,"Data/clean/School", sep="/"))
  
} else if (str_to_lower(Sys.getenv("USERNAME")) == "wb577189"){

    project_folder  <- "C:/Users/wb577189/OneDrive - WBG/CNT/"
    
    download_folder <-file.path(paste(project_folder,country,paste(country,year,"GEPD", sep="_"),paste(country,year,"GEPD_v01_RAW", sep="_"),"Data/raw/School", sep="/"))
    
    confidential_folder <- file.path(paste(project_folder,country,paste(country,year,"GEPD", sep="_"),paste(country,year,"GEPD_v01_RAW", sep="_"),"Data/confidential/School", sep="/"))
    
    save_folder <- file.path(paste(project_folder,country,paste(country,year,"GEPD", sep="_"),paste(country,year,"GEPD_v01_RAW", sep="_"),"Data/anonymized/School", sep="/"))
    
    backup_onedrive="no"
    
    save_folder_onedrive <- file.path(paste("C:/Users/wb577189/OneDrive - WBG/My files/Dashboard (Team Folder)/Country_Work/",country_name,year,"Data/clean/School", sep="/"))
    
    
  } else {
  download_folder <- choose.dir(default = "", caption = "Select folder to open data downloaded from API")
  save_folder <- choose.dir(default = "", caption = "Select folder to save final data")
  
}

#attach saved results
attach(paste0(confidential_folder, "/school_indicators_data.Rdata"))
school_gdp_2020 <- school_gdp
school_dta_2020 <- school_dta_short %>%
  left_join(school_gdp_2020)



```

```{r combinedata}

#combine the data from 2020 and 2021

combine_gepd_data <- school_dta_2020 %>%
  mutate(date=2020,
         survey_time=as.character(survey_time)) %>%
  bind_rows(school_dta_2021) %>%
  mutate(date=if_else(is.na(date),2021,date)) 

combine_gepd_data %>%
  group_by(date) %>%
  summarise(
    GDP=mean(GDP, na.rm=T)
  )


```




```{r country_map, include=FALSE}
sample_map <- combine_gepd_data %>%
    mutate(longitude=as.character(lon)) %>%
    mutate(latitude=as.character(lat)) %>%
    mutate(longitude=as.numeric(longitude)) %>%
    mutate(latitude=as.numeric(latitude)) 


  sample_map_chosen <- sample_map %>%
     mutate(sample_text=if_else(
       date==2020,
       "2020",
       "2021"
     ))

   

   pal <- colorFactor(
     palette = c("red", "green"),
     domain = c("2020", "2021")
   )
   

    

```

## Table of Ethiopia Regions Visited Prior to School Closures

Below is a set of tables showing the regions visited by the enumerators prior to school closures.

```{r provtab}

prov_tab <- sample_map_chosen %>%
  mutate(Province=school_address_preload) %>%
  group_by(Province, sample_text) %>%
  summarise(n=n()) %>%
  ungroup() %>%
  pivot_wider(
    names_from=sample_text,
    values_from=n
  ) %>%
  mutate(`2020`=if_else(is.na(`2020`),0,as.numeric(`2020`)),
         `2021`=if_else(is.na(`2021`),0,as.numeric(`2021`))) %>%
  select(Province, `2020`, `2021`)

gt(prov_tab) %>%
  tab_header(
    title="Schools Visited/Not Visited by Province Prior to COVID-19."
  ) %>%
  summary_rows(
    columns = c('2020','2021' ),
    fns = list(
      Total = "sum"),
    formatter=fmt_number,
    decimals=0
  ) 

```



## Map of Ethiopia Schools Visited Prior to School Closures

The below map shows the schools that were visited prior to COVID related school closures that stopped data collection.



```{r country_map2, echo=FALSE}
leaflet(data=sample_map_chosen) %>%
    addTiles()  %>%
    addCircleMarkers( lng=~longitude,  lat=~latitude, color=~pal(sample_map_chosen$sample_text),
                      radius=7,
                popup =  paste("Name: ", sample_map_chosen$orig_name, " <br>",
                                  "Province: ", sample_map_chosen$school_address_preload, " <br>",
                                  "Region: ", sample_map_chosen$school_province_preload, " <br>",
                                  "Woreda: ", sample_map_chosen$school_district_preload, " <br>",
                                  "EMIS: ", sample_map_chosen$school_emis_preload)) %>%
  addLegend(position="bottomright", pal=pal, values=~sample_map_chosen$sample_text, title="Schools Visited")
```

The Following table pulls localized GDP data from satellites and compares the local GDP for schools visited in 2020 versus 2021.  The satellite data comes from here:

Data downloaded from Here:
https://datacatalog.worldbank.org/dataset/gross-domestic-product-2010 

also see
https://preview.grid.unep.ch/index.php?preview=data&events=socec&evcat=1&lang=eng

 In the distributed global GDP dataset sub-national GRP and national GDP data are allocated to 
 30 arc second (approximately 1km) grid cells in proportion to the population residing in that cell. 
 The method also distinguishes between rural and urban population, assuming the latter to have a higher 
 GDP per capita. Input data are from 1) a global time-series dataset of GDP, with subnational gross regional 
 product (GRP) for 74 countries, compiled by the World Bank Development Economics Research Group (DECRG). 2) 
 Gridded population projections for the year 2009, based on a population grid for the year 2005 provided by 
 LandScanTM Global Population Database (Oak Ridge, TN: Oak Ridge National Laboratory). This dataset has been 
 extrapolated to year 2010 by UNEP/GRID-Geneva. Unit is estimated value of production per cell, in thousand of 
 constant 2000 USD. Cell level anomalies may occur due to poor alignment of multiple input data sources, and it 
 is strongly recommended that users attempt to verify information, or consult original sources, in order to determine 
 suitability for a particular application. This product was compiled by DECRG for the Global Assessment Report on Risk 
 Reduction (GAR). It was modeled using global data. Credit: GIS processing World Bank DECRG, Washington, DC, 
 extrapolation UNEP/GRID-Geneva.

```{r ttest1}


t1 <-  t.test(sample_map_chosen$GDP ~ sample_map_chosen$sample_text) %>% broom::tidy() %>% mutate(indicator="2015 Satellite based GDP Estimate")
                       


t_df <- t1 %>%
  #bind_rows(t1, t2, t3, t4, t5, t6) %>%
  transmute(
    Indicator=indicator,
    `2020` = round(estimate1,1),
    `2021`=round(estimate2,1),
    Difference=round(estimate,1),
    `P-value`=round(p.value,3), 
    `95% CI`=paste0("[",round(conf.low,1),",",round(conf.high,1),"]")
    
    
  ) 

gt(t_df) %>%
  tab_header(
    title="Test of Differences for Indicators between Schools Visited 2020 and 2021"
  )

```

## Predictions of Whether School Visited in 2020 or 2021

In the next section, we will use regression to examine characteristics of schools that were visited in 2020 and 2021. Examine GDP as estimated using satellite data, distance from capital, other?

```{r}

#get coordinates of capital city from WDI
wdi<-wbstats::wbcountries() %>%
  filter(country=="Ethiopia")

my_lat <- as.numeric(wdi$lat)
my_lon <- as.numeric(wdi$long)

pred_df <- sample_map_chosen %>% 
  filter(!is.na(lon) & !is.na(GDP)) %>%
  rowwise() %>% mutate(
  dist = distm(c(my_lon, my_lat), c(lon, lat), fun=distHaversine) # this works
  )
 # mutate(GDP=GDP+0.01) #some GDP values set to 0

#drop schools directly in addis

#OLS
reg_mod <- lm(sample_text ~ GDP + dist, data=pred_df)
summary(reg_mod)

#random forest
set.seed(222)
ind <- sample(2, nrow(pred_df), replace = TRUE, prob = c(0.7, 0.3))
train <- pred_df[ind==1,] %>%
  select(sample_text, GDP, dist) %>%
  mutate(sample_text=factor(sample_text))

test <- pred_df[ind==2,] %>%
  select(sample_text, GDP, dist) %>%
  mutate(sample_text=factor(sample_text))

#tree
rt <- rpart(
  formula = sample_text ~ .,
  data    = train,
  method  = "anova"
  )
rpart.plot(rt)

rf <- randomForest(sample_text~., data=train,) 
print(rf)
p2 <- predict(rf, test, type='prob')
#confusionMatrix(p2, test$ sample_text)
importance(rf)
varImpPlot(rf,
           sort = T,
           n.var = 10,
           main = "Variable Importance")
```

Use random forest predicted probabilities to do inverse propensity weighting.

Student attendance, teacher presense, and 1st grade assessment scores seem negatively affected.  Not much else.

```{r}

indicator <- 'presence_rate'

predicted <- predict(rf, pred_df, type='prob')

#add probabilites to data frame
inv_weight_df <- pred_df %>%
  mutate(sample_2021=sample_text=="2021") %>%
  rename(outcome= !!indicator)

inv_weight_df$prob2020 <- predicted[,1]
inv_weight_df$prob2021 <- predicted[,2]

inv_weight_df <- inv_weight_df %>%
  filter(prob2021>0 & prob2021<100) %>%
  mutate(ipw=if_else(sample_2021==TRUE, 1/prob2021, 1/prob2020))

#regress student learning on whether data collected in 2021
reg_simp <- lm(outcome ~ sample_2021, data= inv_weight_df)
summary(reg_simp)

#now use propensity weights
reg_weight <- lm(outcome ~ sample_2021, data= inv_weight_df, weights=ipw)
summary(reg_weight)

# #Manual method
# dta_2020 <- inv_weight_df %>%
#   filter(sample_2021==FALSE) %>%
#   mutate(ipw=1/prob2020)
# 
# mean_2020_wgt <- wtd.mean(dta_2020$student_knowledge, weights=dta_2020$ipw)
# mean_2020_wgt
# 
# dta_2021 <- inv_weight_df %>%
#   filter(sample_2021==TRUE) %>%
#   mutate(ipw=1/prob2021)
# 
# mean_2021_wgt <- wtd.mean(dta_2021$student_knowledge, weights=dta_2021$ipw)
# mean_2021_wgt
# 
# mean_2021_wgt-mean_2020_wgt

```

```{r}


dens <- density(pred_df$dist/1000, from=min(pred_df$dist/1000), to=max(pred_df$dist/1000))
df <- data.frame(x=dens$x, y=dens$y)

probs <- c(0, 0.25, 0.5, 0.75, 1)


quantiles <- quantile(pred_df$dist/1000, prob=probs)
df$quant <- factor(findInterval(df$x,quantiles))
ggplot(df, aes(x,y)) + geom_line() + geom_ribbon(aes(ymin=0, ymax=y, fill=quant)) + scale_x_continuous(labels=scales::comma) + scale_fill_brewer(guide="none") +
  ggtitle('Distance (km) of School from Addis Ababa',
          subtitle='Shaded by Quartile') +
  theme_bw()


```
```{r}

  ## NOTE ####

  # We are trying to compare the schools for which the data collection took place before Covid-19 started with the ones for which data collection was completed in 2021. To do that, we are drawing a random sample of ~ 50-60 schools from the ones that were done at the beginning of 2020. Each school from this first sample is then match with the schools from 2021 based on 1) observable characteristics (GDP + number of students) and 2) geographic location (closest GPS distance)

   ## Shortest path with distance ---- 

      library(geosphere)


      schools_2021 <- school_dta_2021%>% filter(!is.na(lon)|!is.na(lat))
      schools_2020 <- school_dta_2020

      
      # create distance matrix
       mat <- distm(schools_2021[,c('lon','lat')], schools_2020[,c('lon','lat')], fun=distVincentyEllipsoid) 
      
       # assign the name to the point in list1 based on shortest distance in the matrix
      schools_2021$Closest_school_Pre_covid <- schools_2020$school_code[max.col(-mat)]
      schools_2021$Distance_btw_schools <- apply(mat, 1, min)
      
      #shortest <- random_2020
          
    
      
    ## Drawing the sample from 2021 -----

  sample_full <- schools_2021 %>% 
      sample_n(60, replace = F, weight = NULL) %>% 
      rename_with(~paste0(., "_POST"), school_code:GDP) %>% 
      rename(school_code=Closest_school_Pre_covid) %>% 
      left_join(schools_2020, by =c("school_code")) %>% 
      rename_with(~paste0(., "_PRE"), school_name_preload:GDP) 
      
    
      ## Pivot for graphs --------
    sample_full_long <- sample_full  %>% 
          
        select(-school_code, -Distance_btw_schools) %>% 
          
         mutate(across(where(is.numeric),
                    
                    ~ as.character(.)
                    )) %>% 
          
            pivot_longer(
                    cols = school_code_POST:GDP_PRE,
                    names_to = c("Indicator", "Covid"),
                    names_pattern = "(.*)_(PRE|POST)",
                    values_to = "Value"
      ) %>% 
        
        # get rid off the names and character like variables that are no use for comparison here
        
        dplyr::filter(!str_detect(Value, "[A-Za-z]")) %>% 
        mutate_at(c("Value"),
                  ~ as.numeric(.)) %>% 
                dplyr::filter(!is.na(Value)) %>% 
        
        group_by(Covid, Indicator) %>%

        summarise(Value = mean(Value, na.rm = T)) %>%
        
        ## Remove indicator not used for comparison
        
        dplyr::filter(!str_detect(Indicator, "school_code")) %>% 
        
        dplyr::filter(!str_detect(Indicator, "sch_management_attraction")) %>% 
        
        ungroup() %>% 
        
        mutate(Covid = as.factor(Covid))

 #sample_full_long[sample_full_long$Indicator %in% names(which(table(sample_full_long$Indicator) <2 )), ]



# # Compute t-test
# library(rstatix)
#       
# # res.aov <- anova_test(sample_full_long$Value ~ sample_full_long$Covid)
# 
#       
# for(ii in unique(sample_full_long$Indicator)){    
#       
#       
#       
#   stat.test <- sample_full_long  %>% 
#     
#     group_by(ii, Covid) %>%
#     
#     t_test(Value ~ Covid) %>%
#     
#     adjust_pvalue(method = "bonferroni") %>%
#     
#     add_significance("p.adj")
# 
#   
#   stat.test
#   
# }
  
sample_full_wide <- sample_full_long %>% 
  pivot_wider(names_from = Indicator, values_from  = Value) %>% 
  mutate(across(where(is.numeric),
             ~ as.double(.)))
  
      

x <- sample_full  %>% 
          
        select(-school_code, -Distance_btw_schools) %>% 
          
         mutate(across(where(is.numeric),
                    
                    ~ as.character(.)
                    )) %>% 
          
            pivot_longer(
                    cols = school_code_POST:GDP_PRE,
                    names_to = c("Indicator", "Covid"),
                    names_pattern = "(.*)_(PRE|POST)",
                    values_to = "value"
      )  %>% 
  # select(tip, total_bill, sex) %>% 
  # gather(key = variable, value = value, -sex) %>% 
  group_by(Covid, Indicator) %>% 
  summarise(value = list(value)) %>% 
  spread(Covid, Indicator) #%>% 
  group_by(Indicator) %>% 
  mutate(p_value = t.test(unlist(PRE), unlist(POST))$p.value,
         t_value = t.test(unlist(PRE), unlist(POST))$statistic)

# boxplots and t-tests for the 4 variables at once
for (i in names(sample_full_wide[ ,2:5])) { # variables to compare are variables 1 to 4
  boxplot(sample_full_wide[, i] ~ sample_full_wide$Covid, # draw boxplots by group
    ylab = names(sample_full_wide[i]), # rename y-axis with variable's name
    xlab = "Pre-Post Covid"
  )
  print(t.test(sample_full_wide[, i] ~ sample_full_wide$Covid)) # print results of t-test
}
      
   



dat <- iris

# remove one level to have only two groups
dat <- subset(dat, Species != "setosa")
dat$Species <- factor(dat$Species)

# boxplots and t-tests for the 4 variables at once
for (i in 1:4) { # variables to compare are variables 1 to 4
  boxplot(dat[, i] ~ dat$Species, # draw boxplots by group
    ylab = names(dat[i]), # rename y-axis with variable's name
    xlab = "Species"
  )
  print(t.test(dat[, i] ~ dat$Species)) # print results of t-test
}



   dat <- sample_full_wide

  # Create the plot

library(ggpubr)

# Edit from here #
x <- which(names(dat) == "COvid") # name of grouping variable
y <- which(names(dat) == "student_proficient" # names of variables to test
| names(dat) == "ecd_student_knowledge"
| names(dat) == "experience_pknw"
| names(dat) == "student_attendance")
method <- "t.test" # one of "wilcox.test" or "t.test"
paired <- FALSE # if paired make sure that in the dataframe you have first all individuals at T1, then all individuals again at T2
# Edit until here


# Edit at your own risk
for (i in y) {
  for (j in x) {
    ifelse(paired == TRUE,
      p <- ggpaired(dat,
        x = colnames(dat[j]), y = colnames(dat[i]),
        color = colnames(dat[j]), line.color = "gray", line.size = 0.4,
        palette = "npg",
        legend = "none",
        xlab = colnames(dat[j]),
        ylab = colnames(dat[i]),
        add = "jitter"
      ),
      p <- ggboxplot(dat,
        x = colnames(dat[j]), y = colnames(dat[i]),
        color = colnames(dat[j]),
        palette = "npg",
        legend = "none",
        add = "jitter"
      )
    )
    #  Add p-value
    print(p + stat_compare_means(aes(label = paste0(..method.., ", p-value = ", ..p.format..)),
      method = method,
      paired = paired,
      # group.by = NULL,
      ref.group = NULL
    ))
  }
}

```

