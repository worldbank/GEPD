---
title: "GEPD/AMPL-b revised weights"
author: "Brian Stacy"
date: "8/23/2022"
output: html_document
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
#load relevant libraries
library(knitr)
library(tidyverse)
library(readxl)
library(haven)
library(leaflet)
library(naniar)
library(Hmisc)
library(skimr)
library(ggthemes)
library(flextable)
#library(fuzzyjoin)
#Load the data
#Country name
country <-'SLE'
country_name <- "Sierra Leone"
year <- '2022'
#specify name of sampling frame file.  This needs to be a csv file
file_frame<-"EGRA EGMA/ASC/2020 files/Annual School Census EMIS (2020) for Share.xlsx"
frame_sheet <- "Annual School Census EMIS (2020"


set.seed(8473227)

#########################
# File paths #
#########################
#The download_folder will be the location of where raw data is downloaded from the API
#The save_folder will be the location of where cleaned data is stored



if (str_to_lower(Sys.getenv("USERNAME")) == "wb469649" ){
  #project_folder  <- "//wbgfscifs01/GEDEDU/datalib-edu/projects/gepd"
  project_folder  <- paste0("C:/Users/",str_to_lower(Sys.getenv("USERNAME")),"/WBG/HEDGE Files - HEDGE Documents/GEPD/CNT/")
  sampling_folder <-file.path(paste(project_folder,country,paste(country,year,"GEPD", sep="_"),paste(country,year,"GEPD_v01_M", sep="_"),"Data/Sampling", sep="/"))
  confidential_folder <- file.path(paste("C:/Users/wb469649/WBG/HEDGE Files - HEDGE Documents/GEPD-Confidential/CNT/",country,paste(country,year,"GEPD", sep="_"),paste(country,year,"GEPD_v01_RAW", sep="_"),"Data/confidential/School", sep="/"))
  download_folder <- file.path(paste("C:/Users/wb469649/WBG/HEDGE Files - HEDGE Documents/GEPD-Confidential/CNT/",country,paste(country,year,"GEPD", sep="_"),paste(country,year,"GEPD_v01_RAW", sep="_"),"Data/raw/School", sep="/"))
  
} else if (str_to_lower(Sys.getenv("USERNAME")) == "wb577189" ){

  project_folder  <- paste0("C:/Users/",str_to_lower(Sys.getenv("USERNAME")),"/OneDrive - WBG/GEPD/CNT/")
  sampling_folder <-file.path(paste(project_folder,country,paste(country,year,"GEPD", sep="_"),paste(country,year,"GEPD_v01_M", sep="_"),"Data/Sampling", sep="/"))
  confidential_folder <- file.path(paste("C:/Users/wb469649/WBG/HEDGE Files - HEDGE Documents/GEPD-Confidential/CNT/",country,paste(country,year,"GEPD", sep="_"),paste(country,year,"GEPD_v01_RAW", sep="_"),"Data/confidential/School", sep="/"))
    download_folder <- file.path(paste("C:/Users/wb469649/WBG/HEDGE Files - HEDGE Documents/GEPD-Confidential/CNT/",country,paste(country,year,"GEPD", sep="_"),paste(country,year,"GEPD_v01_RAW", sep="_"),"Data/raw/School", sep="/"))
  
} else {
  download_folder <- choose.dir(default = "", caption = "Select folder to open data downloaded from API")
  save_folder <- choose.dir(default = "", caption = "Select folder to save final data")

}

```



```{r geojson_prelim, echo=FALSE}

library(geojsonsf) # reads large .geojson files as sf objects much faster than sf's st_read()
library(rnaturalearth)
wbgis <- "C:/Users/wb469649/WBG/HEDGE Files - HEDGE Documents/GEPD-Confidential/General/"

sle.poly.2 <- ne_countries(country="Sierra Leone", returnclass="sf")

# load wb polygon data 

# 
# wb.poly.2 <- geojson_sf(
#   file.path(wbgis, "g2015_2014_2.geojson") # where _2 has district level polys
#   ) %>%
#   filter( ADM0_NAME == country_name) 
#   #distinct(ADM2_CODE, ADM1_CODE, ADM0_CODE, .keep_all = TRUE)  # remove any possible duplicates


# wb.poly.2 <- wb.poly.2 %>%
#   filter( ADM0_NAME == 'Sierra Leone') %>%
#   distinct(ADM2_CODE, ADM1_CODE, ADM0_CODE, .keep_all = TRUE)  # remove any possible duplicates

# ## import at district level (adm1 level)
# geo1 <- geojson_sf(
#   file.path(wbgis, "GeoJSON/g2015_2014_1.geojson") # where _1 has region-level polys
#   ) %>%
#   filter( ADM0_NAME == country_name) %>%
#   distinct(ADM1_CODE, ADM0_CODE, .keep_all = TRUE)  # remove any possible duplicates
# 
# ## keep only the adm0 code and the geometry column.
# geo1 <- geo1 %>%
#   select(ADM1_CODE, geometry)


# plot to show different geometries: rwa1 has 5 regions and rwa has 30 districts 
#geo1 %>% select(ADM1_CODE) %>% plot(., main = 'region geometry')
#wb.poly.2 %>% select(ADM2_CODE) %>% plot(., main = 'district geometry')



```


```{r echo=FALSE}
#read sample frame
df_raw<-read_excel(paste(sampling_folder, file_frame, sep="/"),
              sheet=frame_sheet) 

miss_plt <- gg_miss_var(df_raw, show_pct = TRUE)  +
  theme(axis.text.y = element_blank()) 


  #plotly::ggplotly(miss_plt)
  
df_selected <- df_raw %>%
    select(c(
    "startdate",
    "key",
    "idregion",
    "iddistrict",
    "idcouncil",
    "idchiefdom",
    "idward",
    "idsection",
    "idtown",
    "sch_type",
    "idschool_name",
    "idemis_code",
    "respondent_name",
    "res_designation",
    "res_contact",
    "new_emis_code_id",
    "geopointlatitude",
    "geopointlongitude",
    "geopointaltitude",
    "geopointaccuracy",
    "accessibility",
    "school_districthq_distance",
    "school_districthq_distance_hrs",
    "mixed_school",
    "class1_combined",
    "class2_combined",
    "class3_combined",
    "class4_combined",
    "class5_combined",
    "class6_combined",
    "classes_primary",
    "classes_primary_1",
    "classes_primary_2",
    "classes_primary_3",
    "classes_primary_4",
    "classes_primary_5",
    "classes_primary_6",
    "total_male_teachers",
    "total_female_teachers",
    "total_male_pupils",
    "total_female_pupils",
    "total_permanent_classrooms",
    "total_nonperm_classrooms",
    "total_teachers",
    "total_pupils",
    "total_classrooms",
    "total_stream_class1",
    "total_stream_class2",
    "total_stream_class3",
    "total_stream_class4",
    "total_stream_class5",
    "total_stream_class6",    
    "sch_owner",
    "shift_status",
    "pri_lang_instruct",
    "electricity",
    "water_source",
    "sch_feeding",
    "internet",
    "computers"
  ))



#merge on the list of EGRA/EGMA schools
frame_2019 <- read_csv( paste(sampling_folder, 'EGRA EGMA/ASC/2019 Files/Data Files/2019 Annual School Census Data_Final_20191016.csv', sep="/")) %>%
  select(c(
    "idregion",
    "iddistrict",
    "idcouncil",
    "idchiefdom",
    "idward",
    "idsection",
    "idtown",
    "sch_type",
    "idschool_name",
    "idemis_code"
  ))

#link up the egra data with the EMIS code in the frame_2019
egra_df_raw <- read_excel(path=paste(sampling_folder, 'EGRA EGMA/List of 260 schools - UNICEF SL EGRA EGMA study .xlsx', sep="/")) %>%
  mutate(idschool_name=`School Name`,
         iddistrict=District) %>%
  mutate(row_id=row_number())

egra_df <- egra_df_raw %>%
  left_join(frame_2019) %>%
  select(`School Name`, idemis_code,iddistrict, row_id ) %>%
  distinct(row_id, .keep_all=TRUE) 


egra_join_df <- egra_df %>%
  left_join(df_selected) %>%
  distinct(row_id, .keep_all=TRUE) %>%
  select(-row_id) %>%
  mutate(School="EGRA/EGMA School")

# egra_join_df %>%
#   select(c(
#     "sch_type",
#     "accessibility",
#     "mixed_school",
#     "class1_combined",
#     "class2_combined",
#     "class3_combined",
#     "class4_combined",
#     "class5_combined",
#     "class6_combined",
#     "classes_primary",
#     "classes_primary_1",
#     "classes_primary_2",
#     "classes_primary_3",
#     "classes_primary_4",
#     "classes_primary_5",
#     "classes_primary_6",
#     "total_male_teachers",
#     "total_female_teachers",
#     "total_male_pupils",
#     "total_female_pupils",
#     "total_permanent_classrooms",
#     "total_nonperm_classrooms",
#     "total_teachers",
#     "total_pupils",
#     "total_classrooms",
#     "sch_owner",
#     "shift_status",
#     "pri_lang_instruct",
#     "electricity",
#     "water_source",
#     "sch_feeding",
#     "internet",
#     "computers"
#   )) %>% tbl_summary(  )



df_selected %>% #   
  ungroup() %>%
    select(c(
    "sch_type",
    "accessibility",
    "mixed_school",
    "class1_combined",
    "class2_combined",
    "class3_combined",
    "class4_combined",
    "class5_combined",
    "class6_combined",
    "total_male_teachers",
    "total_female_teachers",
    "total_male_pupils",
    "total_female_pupils",
    "total_permanent_classrooms",
    "total_nonperm_classrooms",
    "total_teachers",
    "total_pupils",
    "total_classrooms",
    "sch_owner",
    "shift_status",
    "pri_lang_instruct",
    "electricity",
    "water_source",
    "sch_feeding",
    "internet",
    "computers"
  )) %>%
  skim() %>%
  filter(skim_type=="numeric") %>%
  select(-skim_type) %>%
  select(-contains('character')) %>%
  flextable() %>%
  add_header_lines("Summary Statistics of Raw Sample Frame")

```



```{r setframe, echo=TRUE}
pupil_count_max_threshold_g2 = 30
pupil_count_min_threshold_g1 = 3
pupil_count_min_threshold_g4 = 3
pupil_count_min_threshold_g6 = 3

df_frame <- df_selected %>%
  filter(sch_type=="B. Primary" | idemis_code %in% c(420512204, 319103315)) %>%
  filter((class1_combined>=pupil_count_min_threshold_g1 & class4_combined>=pupil_count_min_threshold_g4) | idemis_code %in% c(420512204, 319103315)) %>%
  mutate(
    egra_size=if_else((class2_combined<pupil_count_max_threshold_g2), "Under 30 students", "30 or Greater students")
  )


df_frame %>% #   
  ungroup() %>%
    select(c(
    "sch_type",
    "accessibility",
    "mixed_school",
    "class1_combined",
    "class2_combined",
    "class3_combined",
    "class4_combined",
    "class5_combined",
    "class6_combined",
    "total_male_teachers",
    "total_female_teachers",
    "total_male_pupils",
    "total_female_pupils",
    "total_permanent_classrooms",
    "total_nonperm_classrooms",
    "total_teachers",
    "total_pupils",
    "total_classrooms",
    "sch_owner",
    "shift_status",
    "pri_lang_instruct",
    "electricity",
    "water_source",
    "sch_feeding",
    "internet",
    "computers"
  )) %>%
  skim() %>%
  filter(skim_type=="numeric") %>%
  select(-skim_type) %>%
  select(-contains('character')) %>%
  flextable() %>%
  add_header_lines("Summary Statistics of Sample Frame for All Schools")

```
# Reconstruct sample weights after field work

Because of issues in field work, the sample weights need to be reconstructed. A number of schools could not be reached during the field work.  A few issues caused the problems reaching the schools.

    Teacher strikes posed a challenge during the survey. The strikes began at the beginning of the third academic term, the week before the survey started. Teacher participation in the strike varied across schools. Enumerators observed that even when teachers were not striking, students (or their parents) were opting to stay home from school because they were unsure whether teachers would be present. Enumerators often documented this in comments. When logistically possible, enumerators tried returning to schools that were closed from strikes (usually not the next day, given that schools were not supposed to anticipate the survey date) – but if returning to the original would cause significant delays, the original schools were instead substituted with one of the two substitution options provided for each school. The strength of the strike fluctuated during the dates of the data collection, with the strike action generally tapering after the initial start of data collection. The Sierra Leone Teachers Union issued a 21-day strike to commence May 27. Enumerators reported an increase in striking teachers following the May 27 announcement. It was largely resolved through negotiations with the MBSSE that resulted in an agreement to increase salaries by 45% starting in 2023, but this agreement was announced on June 14, by which time nearly all schools had been surveyed.
    
    Another disruption that occurred during the survey was female genital mutilation (FRM) practices. These were carried out by Sierra Leone “secret societies,” sometime referred to by enumerators in comments as “bondo society.” When enumerators encountered FGM being carried out among schoolgirls, they tried to return on a different date to the school to complete the survey.
    
    Other reasons enumerators encountered for low student attendance included: Days of heavy rain; in very-understaffed schools, many students/parents opt not to attend; when a school does not have enough teachers, classes are sometimes combined (e.g. class 3 and class 4 students are taught the same material) leading to students being less interested in school; a community itself was small; children helping their family with farming and economic activities (e.g., giving extra help on market days) instead of attending class. Students also had to delay surveys at schools due to “sports days” (similar to “field days” in a US education context).
    
    
```{r}
#read in record of replacements
replacement_schools_df <- read_excel(path=paste0(sampling_folder, "/Record of Replacements.xlsx"), sheet="Schools")


#read in sample with cleaned info
sample_clean <- read_csv(paste0(sampling_folder, "/sample_clean_2022-04-17.csv"))

#read in school data
visited_schools <- read_csv(file.path(download_folder, "emis_fixes.csv")) %>% select(-m1s0q2_emis) %>%
  group_by(school_code) %>%
  summarise(visited=1,
            replaced=mean(replaced, na.rm=T)) %>%
  mutate(idemis_code=as.numeric(school_code),
         replaced=if_else(is.na(replaced),"Sampled School","Replaced School")) %>%
  filter(!is.na(idemis_code)) %>%
  left_join(df_selected) 



```

Get map of visited schools and those replaced

```{r country_map3, echo=FALSE}

   pal <- colorFactor(
     palette = c("red", "green"),
     domain = c("Replaced School", "Sampled School")
   )
   
leaflet(data=visited_schools) %>%
    addTiles()  %>%
    addCircleMarkers( lng=~geopointlongitude,  lat=~geopointlatitude, color=~pal(visited_schools$replaced),
                      radius=7,
                popup =  paste("Name: ", visited_schools$idschool_name, " <br>",
                                  "Region: ", visited_schools$idregion, " <br>",
                                  "District: ", visited_schools$iddistrict, " <br>",
                                  "EMIS: ", visited_schools$idemis_code)) %>%
  addLegend(position="bottomright", pal=pal, values=~visited_schools$replaced, title="Schools Visited")
```

Stats on number of replacements

```{r}
visited_schools %>% group_by(replaced) %>% summarise(n=n()) %>% flextable()
```


Get number of schools by strata
```{r}
sampled_strata <- sample_clean %>%
  group_by(iddistrict) %>%
  summarise(`Number Sampled`=n())

visited_strata <- visited_schools %>%
    group_by(iddistrict) %>%
  summarise(`Number Visited`=n())

strata_stats <- sampled_strata %>%
  left_join(visited_strata)

flextable(strata_stats) %>%
  add_header_lines('Districts Sampled versus Selected')
```

```{r}
sampled_strata <- sample_clean %>%
  group_by(sch_owner) %>%
  summarise(`Number Sampled`=n())

visited_strata <- visited_schools %>%
    group_by(sch_owner) %>%
  summarise(`Number Visited`=n())

strata_stats <- sampled_strata %>%
  left_join(visited_strata)

flextable(strata_stats) %>%
  add_header_lines('School Ownership Sampled versus Selected')
```

```{r}
sampled_strata <- sample_clean %>%
  group_by(idregion,iddistrict,sch_owner) %>%
  summarise(`Number Sampled`=n())

visited_strata <- visited_schools %>%
    group_by(idregion,iddistrict,sch_owner) %>%
  summarise(`Number Visited`=n())

strata_stats <- sampled_strata %>%
  left_join(visited_strata)

flextable(strata_stats) %>%
  add_header_lines('Full Strata Sampled versus Selected')

```
# Produce final weights based on visited schools

```{r echo=TRUE}



strata_weight_size <- visited_schools %>%
  group_by(idregion,iddistrict,sch_owner) %>%
  summarise(sample_size=n())


revised_school_weights_df <- df_frame %>%
  ungroup() %>%
  mutate(total_students_frame=sum(class4_combined)) %>%
  left_join(strata_weight_size) %>%
  group_by(idregion,iddistrict,sch_owner) %>%
  mutate(strata_count=n(),
         strata_size=sum(class4_combined),
         strata_school_prob=strata_size/total_students_frame) %>%
  mutate(strata_prob=(sample_size)*(class4_combined/strata_size),
         ipw=strata_school_prob*(1/strata_prob)) 

write_excel_csv(revised_school_weights_df, paste(sampling_folder, '/school_weights_revised_', Sys.Date(),  '.csv', sep=""))


# Weights for Ampl-b in 5th grade
revised_amplb_student_weights <- revised_school_weights_df %>%
  rename(school_weight=ipw) %>%
  mutate(class_weight=total_stream_class5/1, # weight is the number of 5th grade streams divided by number selected (1)
         student_weight=(class5_combined/total_stream_class5)/25,
         final_weight=school_weight*class_weight*student_weight
         ) 
  
write_excel_csv(revised_amplb_student_weights, paste(sampling_folder, '/amplb_weights_revised_', Sys.Date(),  '.csv', sep=""))


```

# Sanity Checks

Below I will use the survey weights to estimate aspects of the school that are available in the sampling frame. These are electricity rates, school feeding rates, and internet connectivity rates.  These data were collected as part of the school EMIS in Sierra Leone.  The population mean from the full sampling frame is compared to the estimated mean from the school sample using the sampling weights.  Estimated means very far from the population mean can indicate there is something wrong with the weights or that the school sample is biased.

The estimates based on the school weights are similar and within the confidence interval of those produced using the sampling frame.

```{r}
library(srvyr)
#sanity check of the sampling weights and results
# use weights to estimate population average of internet prevalence

df_frame %>%
  ungroup() %>%
        mutate(electricity=if_else(electricity=="No Electricity",0,1),
           school_feeding=if_else(sch_feeding=="No",0,1),
           internet=if_else(internet=="No",0,1)) %>%
  summarise(electricity=Hmisc::wtd.mean(electricity, weights=class4_combined),
            school_feeding=Hmisc::wtd.mean(school_feeding, weights=class4_combined),
            internet=Hmisc::wtd.mean(internet, weights=class4_combined)) %>%
  flextable() %>%
  add_header_lines("Population estimate")




linked_sample <- visited_schools %>%
  filter(!is.na(idemis_code)) %>%
  select(idemis_code) %>%
  ungroup() %>%
  left_join(revised_school_weights_df) 



linked_sample %>%
  filter(!is.na(ipw)) %>%
  filter(!is.infinite(ipw)) %>%
  ungroup() %>%
  as_survey_design(strata=c('idregion','iddistrict','sch_owner'),
                   weight=ipw) %>%
    mutate(electricity=if_else(electricity=="No Electricity",0,1),
           school_feeding=if_else(sch_feeding=="No",0,1),
           internet=if_else(internet=="No",0,1)) %>%
    summarise(electricity=survey_mean(electricity),
              school_feeding=survey_mean(school_feeding),
              internet=survey_mean(internet)) %>%
  flextable() %>%
  add_header_lines("Estimate based on Schools Visited and Sampling Weights")
```