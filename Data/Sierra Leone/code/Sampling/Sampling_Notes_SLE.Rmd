---
title: "Sampling Notes - Sierra Leone"
author: ''
output:
  word_document: default
  html_document: default
always_allow_html: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
#load relevant libraries
library(knitr)
library(tidyverse)
library(readxl)
library(haven)
library(leaflet)
library(naniar)
library(Hmisc)
library(skimr)
library(ggthemes)
library(flextable)
#library(fuzzyjoin)
#Load the data
#Country name
country <-'SLE'
country_name <- "Sierra Leone"
year <- '2022'
#specify name of sampling frame file.  This needs to be a csv file
file_frame<-"EGRA EGMA/ASC/2020 files/Annual School Census EMIS (2020) for Share.xlsx"
frame_sheet <- "Annual School Census EMIS (2020"


set.seed(8473227)

#########################
# File paths #
#########################
#The download_folder will be the location of where raw data is downloaded from the API
#The save_folder will be the location of where cleaned data is stored



if (str_to_lower(Sys.getenv("USERNAME")) == "wb469649" ){
  #project_folder  <- "//wbgfscifs01/GEDEDU/datalib-edu/projects/gepd"
  project_folder  <- paste0("C:/Users/",str_to_lower(Sys.getenv("USERNAME")),"/WBG/HEDGE Files - HEDGE Documents/GEPD/CNT/")
  sampling_folder <-file.path(paste(project_folder,country,paste(country,year,"GEPD", sep="_"),paste(country,year,"GEPD_v01_M", sep="_"),"Data/Sampling", sep="/"))
  confidential_folder <- file.path(paste("C:/Users/wb469649/WBG/HEDGE Files - HEDGE Documents/GEPD-Confidential/CNT/",country,paste(country,year,"GEPD", sep="_"),paste(country,year,"GEPD_v01_RAW", sep="_"),"Data/confidential/School", sep="/"))
  download_folder <- file.path(paste("C:/Users/wb469649/WBG/HEDGE Files - HEDGE Documents/GEPD-Confidential/CNT/",country,paste(country,year,"GEPD", sep="_"),paste(country,year,"GEPD_v01_RAW", sep="_"),"Data/raw/School", sep="/"))
  
} else if (str_to_lower(Sys.getenv("USERNAME")) == "wb577189" ){

  project_folder  <- paste0("C:/Users/",str_to_lower(Sys.getenv("USERNAME")),"/OneDrive - WBG/GEPD/CNT/")
  sampling_folder <-file.path(paste(project_folder,country,paste(country,year,"GEPD", sep="_"),paste(country,year,"GEPD_v01_M", sep="_"),"Data/Sampling", sep="/"))
  confidential_folder <- file.path(paste("C:/Users/wb469649/WBG/HEDGE Files - HEDGE Documents/GEPD-Confidential/CNT/",country,paste(country,year,"GEPD", sep="_"),paste(country,year,"GEPD_v01_RAW", sep="_"),"Data/confidential/School", sep="/"))
    download_folder <- file.path(paste("C:/Users/wb469649/WBG/HEDGE Files - HEDGE Documents/GEPD-Confidential/CNT/",country,paste(country,year,"GEPD", sep="_"),paste(country,year,"GEPD_v01_RAW", sep="_"),"Data/raw/School", sep="/"))
  
} else {
  download_folder <- choose.dir(default = "", caption = "Select folder to open data downloaded from API")
  save_folder <- choose.dir(default = "", caption = "Select folder to save final data")

}

```

## Introduction

This file outlines the sampling strategy for Sierra Leone.

## General Notes on Sampling
The aim of the Global Education Policy Dashboard school survey is to produce nationally representative estimates, which will be able to detect changes in the indicators over time at a minimum power of 80% and with a 0.05 significance level.  We also wish to detect differences by urban/rural location. 

For our school survey, we will employ a two-stage random sample design, where in the first stage a sample of around 200 schools, based on local conditions, is drawn, chosen in advance by the Bank staff.  In the second stage, a sample of teachers and students will be drawn to answer questions from our survey modules, chosen in the field.  A total of 10 teachers will be sampled for absenteeism.  Five teachers will be interviewed and given a content knowledge exam.  Three 1st grade students will be assessed at random, and a classroom of 4th grade students will be assessed at random.  Stratification will be based on the school’s urban/rural classification and based on region. When stratifying by region, we will work with our partners within the country to make sure we include all relevant geographical divisions. 

For our Survey of Public Officials, we will sample a total of 200 public officials.  Roughly 40 officials will be surveyed at the federal level, while 160 officials will be surveyed at the reginoal/district level.  For selection of officials at the regional and district level, we will employ a cluster sampling strategy, where 12 Governorate offices are chosen at random from among the regions in which schools were sampled.  Then among these 12 Governorates, we also select at random 12 Directorates from among the Directorates in which schools werer sampled.  The result of this sampling approach is that for 12 clusters we will have links from the school to the Directorates office to the Governorate office to the central office.  Within the Governorates/Directorates five or six officials will be sampled, including the head of organization, HR director, two division directors from finance and planning, and one or two randomly selected professional employees among the finance, planning, and one other service related department chosen at random.  At the federal level, we will interview the HR director, finance director, planning director, and three randomly selected service focused departments.  In addition to the directors of each of these departments, a sample of 9 professional employees will be chosen in each department at random on the day of the interview.

 

Sampling Approach for Global Education Policy Dashboard

This document will provide an overview of the sampling strategy used in the Global Education Policy Dashboard (GEPD) surveys, as well as remaining questions.  New data for the dashboard will be collected using three main instruments: a School Survey, an Expert Survey, and a Survey of Public Officials. More information pertaining to each can be found below.  The goal of the Global Education Policy Dashboard is to provide summary information at the national level on a set of 35 indicators and to allow countries to track progress on those indicators over a short time frame (every 2 years).  Specifically, we aim to produce nationally representative estimates, which will be able to detect changes in the indicators over time at a minimum power of 80% and with a 0.05 significance level.  We also wish to disaggregate by urban/rural.

School Survey: The School Survey will collect data primarily on Practices (the quality of service delivery in schools), but also on some de facto Policy and school-level Politics indicators.  It will consist of streamlined versions of existing instruments—including SDI and SABER SD on teachers, 4th grade students, and inputs/infrastructure, TEACH on pedagogical practice, GECDD on school readiness of young children, and DWMS on management quality—together with new questions to fill gaps in those instruments.  Though the number of modules is similar to the full version of SDI, the number of items within each module is significantly lower. In each country, this survey will be administered in a nationally representative sample of 250 schools, selected through stratified  random sampling. As currently envisioned, the School Survey will include 8 short modules.
Expert Survey: The Expert Survey will collect information to feed into the policy indicators.  This survey will be filled out by key informants in each country, drawing on their knowledge to identify key elements of the policy framework (as in the SABER approach to policy-data collection that the Bank has used over the past 7 years).  The survey will have 4 modules with each including approximately ten questions.

Survey of Public Officials: The Survey of Public Officials will collect information about the capacity and orientation of the bureaucracy, as well as political factors affecting education outcomes. This survey will be a streamlined and education-focused version of the civil-servant surveys that the Bank’s Bureaucracy Lab has implemented recently in several countries, and the dashboard team is collaborating closely with DEC and Governance GP staff to develop this instrument.  As currently envisioned, the survey will be administered to a random sample of about 200 staff serving in the central education ministry and district education offices.  It will include questions about technical and leadership skills, work environment, stakeholder engagement, clientelism, and attitudes and behaviors.

## Sierra Leone  Specific Comments

```{r geojson_prelim, echo=FALSE}

library(geojsonsf) # reads large .geojson files as sf objects much faster than sf's st_read()
library(rnaturalearth)
wbgis <- "C:/Users/wb469649/WBG/HEDGE Files - HEDGE Documents/GEPD-Confidential/General/"

sle.poly.2 <- ne_countries(country="Sierra Leone", returnclass="sf")

# load wb polygon data 

# 
# wb.poly.2 <- geojson_sf(
#   file.path(wbgis, "g2015_2014_2.geojson") # where _2 has district level polys
#   ) %>%
#   filter( ADM0_NAME == country_name) 
#   #distinct(ADM2_CODE, ADM1_CODE, ADM0_CODE, .keep_all = TRUE)  # remove any possible duplicates


# wb.poly.2 <- wb.poly.2 %>%
#   filter( ADM0_NAME == 'Sierra Leone') %>%
#   distinct(ADM2_CODE, ADM1_CODE, ADM0_CODE, .keep_all = TRUE)  # remove any possible duplicates

# ## import at district level (adm1 level)
# geo1 <- geojson_sf(
#   file.path(wbgis, "GeoJSON/g2015_2014_1.geojson") # where _1 has region-level polys
#   ) %>%
#   filter( ADM0_NAME == country_name) %>%
#   distinct(ADM1_CODE, ADM0_CODE, .keep_all = TRUE)  # remove any possible duplicates
# 
# ## keep only the adm0 code and the geometry column.
# geo1 <- geo1 %>%
#   select(ADM1_CODE, geometry)


# plot to show different geometries: rwa1 has 5 regions and rwa has 30 districts 
#geo1 %>% select(ADM1_CODE) %>% plot(., main = 'region geometry')
#wb.poly.2 %>% select(ADM2_CODE) %>% plot(., main = 'district geometry')



```


```{r echo=FALSE}
#read sample frame
df_raw<-read_excel(paste(sampling_folder, file_frame, sep="/"),
              sheet=frame_sheet) 

miss_plt <- gg_miss_var(df_raw, show_pct = TRUE)  +
  theme(axis.text.y = element_blank()) 


  #plotly::ggplotly(miss_plt)
  
df_selected <- df_raw %>%
    select(c(
    "startdate",
    "key",
    "idregion",
    "iddistrict",
    "idcouncil",
    "idchiefdom",
    "idward",
    "idsection",
    "idtown",
    "sch_type",
    "idschool_name",
    "idemis_code",
    "respondent_name",
    "res_designation",
    "res_contact",
    "new_emis_code_id",
    "geopointlatitude",
    "geopointlongitude",
    "geopointaltitude",
    "geopointaccuracy",
    "accessibility",
    "school_districthq_distance",
    "school_districthq_distance_hrs",
    "mixed_school",
    "class1_combined",
    "class2_combined",
    "class3_combined",
    "class4_combined",
    "class5_combined",
    "class6_combined",
    "classes_primary",
    "classes_primary_1",
    "classes_primary_2",
    "classes_primary_3",
    "classes_primary_4",
    "classes_primary_5",
    "classes_primary_6",
    "total_male_teachers",
    "total_female_teachers",
    "total_male_pupils",
    "total_female_pupils",
    "total_permanent_classrooms",
    "total_nonperm_classrooms",
    "total_teachers",
    "total_pupils",
    "total_classrooms",
    "total_stream_class1",
    "total_stream_class2",
    "total_stream_class3",
    "total_stream_class4",
    "total_stream_class5",
    "total_stream_class6",    
    "sch_owner",
    "shift_status",
    "pri_lang_instruct",
    "electricity",
    "water_source",
    "sch_feeding",
    "internet",
    "computers"
  ))



#merge on the list of EGRA/EGMA schools
frame_2019 <- read_csv( paste(sampling_folder, 'EGRA EGMA/ASC/2019 Files/Data Files/2019 Annual School Census Data_Final_20191016.csv', sep="/")) %>%
  select(c(
    "idregion",
    "iddistrict",
    "idcouncil",
    "idchiefdom",
    "idward",
    "idsection",
    "idtown",
    "sch_type",
    "idschool_name",
    "idemis_code"
  ))

#link up the egra data with the EMIS code in the frame_2019
egra_df_raw <- read_excel(path=paste(sampling_folder, 'EGRA EGMA/List of 260 schools - UNICEF SL EGRA EGMA study .xlsx', sep="/")) %>%
  mutate(idschool_name=`School Name`,
         iddistrict=District) %>%
  mutate(row_id=row_number())

egra_df <- egra_df_raw %>%
  left_join(frame_2019) %>%
  select(`School Name`, idemis_code,iddistrict, row_id ) %>%
  distinct(row_id, .keep_all=TRUE) 


egra_join_df <- egra_df %>%
  left_join(df_selected) %>%
  distinct(row_id, .keep_all=TRUE) %>%
  select(-row_id) %>%
  mutate(School="EGRA/EGMA School")

# egra_join_df %>%
#   select(c(
#     "sch_type",
#     "accessibility",
#     "mixed_school",
#     "class1_combined",
#     "class2_combined",
#     "class3_combined",
#     "class4_combined",
#     "class5_combined",
#     "class6_combined",
#     "classes_primary",
#     "classes_primary_1",
#     "classes_primary_2",
#     "classes_primary_3",
#     "classes_primary_4",
#     "classes_primary_5",
#     "classes_primary_6",
#     "total_male_teachers",
#     "total_female_teachers",
#     "total_male_pupils",
#     "total_female_pupils",
#     "total_permanent_classrooms",
#     "total_nonperm_classrooms",
#     "total_teachers",
#     "total_pupils",
#     "total_classrooms",
#     "sch_owner",
#     "shift_status",
#     "pri_lang_instruct",
#     "electricity",
#     "water_source",
#     "sch_feeding",
#     "internet",
#     "computers"
#   )) %>% tbl_summary(  )



df_selected %>% #   
  ungroup() %>%
    select(c(
    "sch_type",
    "accessibility",
    "mixed_school",
    "class1_combined",
    "class2_combined",
    "class3_combined",
    "class4_combined",
    "class5_combined",
    "class6_combined",
    "total_male_teachers",
    "total_female_teachers",
    "total_male_pupils",
    "total_female_pupils",
    "total_permanent_classrooms",
    "total_nonperm_classrooms",
    "total_teachers",
    "total_pupils",
    "total_classrooms",
    "sch_owner",
    "shift_status",
    "pri_lang_instruct",
    "electricity",
    "water_source",
    "sch_feeding",
    "internet",
    "computers"
  )) %>%
  skim() %>%
  filter(skim_type=="numeric") %>%
  select(-skim_type) %>%
  select(-contains('character')) %>%
  flextable() %>%
  add_header_lines("Summary Statistics of Raw Sample Frame")

```



# Select the 40 additional schools

About the EGRA/EGMA sampling frame:

> The sampling frame begun with the 2019 Annual School Census (ASC) list of primary schools as provided by UNICEF/MBSSE where the sample of 260 schools for this study were obtained from an initial list of 7,154 primary schools. Only schools that meet a pre-defined selection criteria were eligible for sampling.

> To achieve the recommended sample size of 10 learners per grade, schools that had an enrolment of at least 30 learners in Grade 2 in 2019 were considered. To achieve a high level of confidence in the findings and generate enough data for analysis, the selection criteria only considered schools that:
•	had an enrolment of at least 30 learners in grade 1; and
•	had an active grade 4 in 2019 (enrolment not zero)

> The sample was taken from a population of 4,597 primary schools that met the eligibility criteria above, representing 64.3% of all the 7,154 primary schools in Sierra Leone (as per the 2019 school census). Schools with higher numbers of learners were purposefully selected to ensure the sample size could be met in each site.

> As a result, a sample of 260 schools were drawn using proportional to size allocation with simple random sampling without replacement in each stratum. In the population, there were 16 districts and five school ownership categories (community, government, mission/religious, private and others). A total of 63 strata were made by forming combinations of  the 16 districts and school ownership categories. In each stratum, a sample size was computed proportional to the total population and samples were drawn randomly without replacement. Drawing from other EGRA/EGMA studies conducted by Montrose in the past, a backup sample of up to 78 schools (30% of the sample population) with which enumerator teams can replace sample schools was also be drawn. 

> In the distribution of sampled schools by ownership, majority of the sampled schools are owned by mission/religious group (62.7%, n=163) followed by the government owned schools at 18.5% (n=48). Additionally, in school distribution by district, majority of the sampled schools (54%) were found in Bo, Kambia, Kenema, Kono, Port Loko and Kailahun districts. Refer to annex 9. for details on the population and sample distribution by district.

Because of the restriction that at least 30 learners were available in Grade 2, we chose to add an additional 40 schools to the sample from among smaller schools, with between 3 and 30 grade 2 students.  The objective of this supplement was to make the sample more nationally representative, as the restriction reduced the sampling frame for the EGRA/EGMA sample by over 1,500 schools from 7,154 to 4,597.  

The 40 schools were chosen in a manner consistent with the original set of EGRA/EGMA schools. The 16 districts formed the strata. In each stratum, the number of schools selected were proportional to the total population of the statum, and within stratum schools were chosen with probability proportional to size.


```{r setframe, echo=TRUE}

pupil_count_max_threshold_g2 = 30
pupil_count_min_threshold_g1 = 3
pupil_count_min_threshold_g4 = 3
pupil_count_min_threshold_g6 = 3

df_gepd_normal_df <- df_selected %>%
  filter(sch_type=="B. Primary") %>%
  filter(class1_combined>=pupil_count_min_threshold_g1 & class4_combined>=pupil_count_min_threshold_g4) 
  
df_gepd_g6_df <- df_selected %>%
  filter(sch_type=="B. Primary") %>%
  filter(class1_combined>=pupil_count_min_threshold_g1 & class4_combined>=pupil_count_min_threshold_g4 & class6_combined>=pupil_count_min_threshold_g6) 
  
    

df_egra_frame <- df_selected %>%
  filter(sch_type=="B. Primary") %>%
  filter(class1_combined>=pupil_count_min_threshold_g1 & class4_combined>=pupil_count_min_threshold_g4) %>%
  filter(class2_combined>=pupil_count_max_threshold_g2)

df_updated <- df_selected %>%
  filter(sch_type=="B. Primary") %>%
  filter(class1_combined>=pupil_count_min_threshold_g1 & class4_combined>=pupil_count_min_threshold_g4) %>%
  filter(class2_combined<pupil_count_max_threshold_g2)

df_frame <- df_selected %>%
  filter(sch_type=="B. Primary") %>%
  filter(class1_combined>=pupil_count_min_threshold_g1 & class4_combined>=pupil_count_min_threshold_g4) %>%
  mutate(
    egra_size=if_else((class2_combined<pupil_count_max_threshold_g2), "Under 30 students", "30 or Greater students")
  )


df_updated %>% #   
  ungroup() %>%
    select(c(
    "sch_type",
    "accessibility",
    "mixed_school",
    "class1_combined",
    "class2_combined",
    "class3_combined",
    "class4_combined",
    "class5_combined",
    "class6_combined",
    "total_male_teachers",
    "total_female_teachers",
    "total_male_pupils",
    "total_female_pupils",
    "total_permanent_classrooms",
    "total_nonperm_classrooms",
    "total_teachers",
    "total_pupils",
    "total_classrooms",
    "sch_owner",
    "shift_status",
    "pri_lang_instruct",
    "electricity",
    "water_source",
    "sch_feeding",
    "internet",
    "computers"
  )) %>%
  skim() %>%
  filter(skim_type=="numeric") %>%
  select(-skim_type) %>%
  select(-contains('character')) %>%
  flextable() %>%
  add_header_lines("Summary Statistics of Sample Frame for Small Schools")

```

```{r statacounts, echo=TRUE}

#in this code chunk, the number of schools to be selected in each stratum will be set.  This will be based on the population of the stratum.
# The strata are based on the 16 districts 


strata_size <- df_updated %>%
  group_by(idregion,iddistrict) %>%
  summarise(
    n_schools=n(),
    n_students=sum(class4_combined),
    share_students=n_students/sum(df_updated$class4_combined),
    exp_num_schools=40*share_students,
    ini_num_schools=round(exp_num_schools,0)
  ) %>%
  ungroup() %>%
  sample_n(nrow(.)) #randomly order the rows


#pick number of schools in each strata so that total adds to 40
# get vector of exp_num_schools
num_schools <- strata_size$ini_num_schools

#do a while loop sequentially randomly adding or subtracting a school to the list for a randomly selected strata until total is 40
while (sum(num_schools)!=40) {
  
  if (sum(num_schools)<40) {
    
    nr <- round(runif(n=1,min=1,max=16),0) #randomly choose integer between 0 and 16
    extra_schools <- rep(0,16) #create vector of 0s
    extra_schools[nr] <- 1 # for one random strata add one.
    num_schools <- num_schools + extra_schools #add to list of schools.
  } else {
    nr <- round(runif(n=1,min=1,max=16),0) #randomly choose integer between 0 and 16
    extra_schools <- rep(0,16) #create vector of 0s
    extra_schools[nr] <- -1 # for one random strata add one.
    num_schools <- num_schools + extra_schools #add to list of schools.
  }
  
}


sum(num_schools)
strata_size$num_schools <- num_schools

sum(strata_size$chosen_num_schools)

# There are 34 schools, so we need to choose 6 more randomly
districts <- strata_size %>%
  group_by(idregion,iddistrict) %>%
  summarise(num_schools=sum(num_schools),
            n_students=sum(n_students))





```


```{r echo=TRUE}
#now choose the schools within strata
school_sample_df <- df_updated %>%
  left_join(strata_size) %>%
  group_by(idregion,iddistrict) %>%
  sample_n(size=num_schools, weight=class4_combined)

sample_combined <- school_sample_df %>%
  mutate(School="Supplemental School") %>%
  bind_rows(egra_join_df)

write_excel_csv(sample_combined, paste(sampling_folder, '/sample_schools_', Sys.Date(),  '.csv', sep=""))

school_sample_df %>% 
  ungroup() %>%
    select(c(
    "sch_type",
    "accessibility",
    "mixed_school",
    "class1_combined",
    "class2_combined",
    "class3_combined",
    "class4_combined",
    "class5_combined",
    "class6_combined",
    "total_male_teachers",
    "total_female_teachers",
    "total_male_pupils",
    "total_female_pupils",
    "total_permanent_classrooms",
    "total_nonperm_classrooms",
    "total_teachers",
    "total_pupils",
    "total_classrooms",
    "sch_owner",
    "shift_status",
    "pri_lang_instruct",
    "electricity",
    "water_source",
    "sch_feeding",
    "internet",
    "computers"
  )) %>%
  skim() %>%
  filter(skim_type=="numeric") %>%
  select(-skim_type) %>%
  select(-contains('character')) %>%
  flextable() %>%
  add_header_lines('Summary Statistics of Supplemental Sample')


```

```{r country_map2, echo=FALSE}

   pal <- colorFactor(
     palette = c("red", "green"),
     domain = c("EGRA/EGMA School", "Supplemental School")
   )
   
leaflet(data=sample_combined) %>%
    addTiles()  %>%
    addCircleMarkers( lng=~geopointlongitude,  lat=~geopointlatitude, color=~pal(sample_combined$School),
                      radius=7,
                popup =  paste("Name: ", sample_combined$idschool_name, " <br>",
                                  "Region: ", sample_combined$idregion, " <br>",
                                  "District: ", sample_combined$iddistrict, " <br>",
                                  "EMIS: ", sample_combined$idemis_code)) %>%
  addLegend(position="bottomright", pal=pal, values=~sample_combined$School, title="Schools to visit")
```



```{r eval=FALSE, include=FALSE}
SL_dis<- sample_combined %>% 
  rename(District = iddistrict, Region = idregion) %>% 
  group_by(Region, District) %>% 
  summarise(`Number of schools` = n_distinct(idemis_code)) %>% 
  flextable() %>%
  add_header_lines('Distribution of schools on territory')

# SL_dis <- tempfile(fileext = ".html")
save_as_html(SL_dis, path = "C:/Users/wb577189/OneDrive - WBG/Desktop/distribution_sample_SL.html")


sample_final <- sample_combined %>% select(idregion, iddistrict, idcouncil, idchiefdom, idsection, idtown, sch_type, idschool_name, idemis_code, starts_with("geo"), school_districthq_distance ,mixed_school, total_classrooms, total_teachers, total_pupils, shift_status, pri_lang_instruct)

write.csv(sample_final, "C:/Users/wb577189/OneDrive - WBG/Desktop/gepd_sl_sample.csv", row.names = F, na="")

```


# Replacement Schools

Below is a list of replacement schools for each sampled school. Replacement schools were randomly selected among the set of schools in the district, not including the orginally sampled schools. Each row contains the school name, location, and other information for each replacement school.  In the final 5 columns of the database is the school code, school name, region, and district of the originally sampled school for which this school serves as a replacement. 



```{r update_dataset_public, echo=FALSE, message=FALSE, warning=FALSE}
#define sampled schools in sample dataset
sample_chosen <- sample_combined %>%
  mutate(sample="Sampled School") %>%
  mutate(school_name=if_else(is.na(idschool_name),`School Name`, idschool_name)) %>%
  mutate(
    egra_size=if_else((class2_combined<pupil_count_max_threshold_g2) & School=="Supplemental School", "Under 30 students", "30 or Greater students")
  )

#add sample schools back to original database
data_set_updated_chosen <- df_frame %>%
  left_join(sample_chosen)

#get list of tehsil
sampled_districts <- sample_chosen %>%
  group_by( iddistrict,egra_size) %>% 
  summarise(sampled_districts=n()
            )

# select one replacement per district
sample_replace <- data_set_updated_chosen %>%
  left_join(sampled_districts) %>%
  filter(!is.na(sampled_districts)) %>%
  filter(is.na(sample)) %>%
  group_by(iddistrict,egra_size) %>% 
  sample_n(2*sampled_districts, weight=class4_combined) %>% #select two replacement schools
  mutate(sample='Replacement School') %>%
  arrange(iddistrict,egra_size, idschool_name) 

sample_replace2 <- sample_chosen %>%
    bind_rows(sample_chosen) %>% #add a duplicate observation for matching to two replacement schools
    arrange(iddistrict,egra_size,school_name ) 


#add in school info for school that will be replaced
sample_replace$replaced_school_name=sample_replace2$school_name
sample_replace$replaced_school_emis=sample_replace2$idemis_code
sample_replace$replaced_district=sample_replace2$iddistrict

sample_replace %>%
  select(idemis_code, idschool_name, iddistrict, replaced_school_emis, replaced_school_name, replaced_district) %>%
  DT::datatable( caption = 'List of Replacement Schools Chosen for Public School Sample') 

sample_replace <- sample_replace %>%
  select(idemis_code, idschool_name, iddistrict, replaced_school_emis, replaced_school_name, replaced_district, everything())
  
write_excel_csv(sample_replace, paste(sampling_folder, '/sample_replacement_schools_', Sys.Date(),  '.csv', sep=""))



```

# Weights

Get probabilities of selection for each school in the sample.

For our school survey, we will employ a two-stage random sample design, where in the first stage a sample of typically around 200 schools, based on local conditions, is drawn, chosen in advance by the Bank staff.  In the second stage, a sample of teachers and students will be drawn to answer questions from our survey modules, chosen in the field.  

For the AMPL-b assessment, a randomly selected stream is chosen in each school and a random selection of 25 students is selected to take the assessment. The student sampling weight is a combination of the weights for each level of selection (school, classroom, student).  

For the school weights, the weights are the inverse probability that a school is randomly selected for the school survey. Stratification is done on the basis of the schools district (16 districts) and school ownership (4 types: Private, Government, Mission/religious, Community).  There are 64 strata.  The number of units in each strata were allocated based on the number of 4th grade students in the strata.  Within each strata, the schools were selected with the probability proportional to size.

The weight for school i within stratum j is, where m is a measure of school size and n is the number of schools selected per stratum:

$$ SW_i^j=\frac{\sum_{i=1}^{N_j}m_i}{n*m_i} $$

Within each school, one classroom of 5th grade students was chosen randomly.  For the class weight, it is the inverse of the probability that a classroom was selected, where $C_i$ is the number of 5th grade streams in the school.

$$ CW_i^j=\frac{C_i}{1} $$

Within each classroom, 25 students were randomly selected to take the assessment.  The student weight is as follows, where $S_i$ is the total number of students in the selected classroom in school i.

$$ PW_i^j=\frac{S_i}{25} $$

The final weights for school i in strata j are then

$$ FW_i^j= SW_i^j*CW_i^j*PW_i^j$$



```{r}


#in this code chunk, the number of schools to be selected in each stratum will be set.  This will be based on the population of the stratum.
# The strata are based on the 16 districts 


# strata_weight_size <- df_updated %>%
#   group_by(idregion,iddistrict,sch_owner) %>%
#   summarise(
#     n_schools=n(),
#     n_students=sum(class4_combined),
#     share_students=n_students/sum(df_updated$class4_combined),
#     exp_num_schools=300*share_students,
#     ini_num_schools=round(exp_num_schools,0)
#   ) %>%
#   ungroup() %>%
#   sample_n(nrow(.)) #randomly order the rows
# 
# 
# #pick number of schools in each strata so that total adds to 40
# # get vector of exp_num_schools
# num_schools <- strata_weight_size$ini_num_schools
# 
# #do a while loop sequentially randomly adding or subtracting a school to the list for a randomly selected strata until total is 40
# while (sum(num_schools)!=300) {
#   
#   if (sum(num_schools)<300) {
#     
#     nr <- round(runif(n=1,min=1,max=16),0) #randomly choose integer between 0 and 16
#     extra_schools <- rep(0,16) #create vector of 0s
#     extra_schools[nr] <- 1 # for one random strata add one.
#     num_schools <- num_schools + extra_schools #add to list of schools.
#   } else {
#     nr <- round(runif(n=1,min=1,max=16),0) #randomly choose integer between 0 and 16
#     extra_schools <- rep(0,16) #create vector of 0s
#     extra_schools[nr] <- -1 # for one random strata add one.
#     num_schools <- num_schools + extra_schools #add to list of schools.
#   }
#   
# }
# 
# 
# sum(num_schools)
# strata_weight_size$num_schools <- num_schools
# 
# sum(strata_weight_size$num_schools)


strata_weight_size <- read_csv(file=paste(sampling_folder, '/sample_clean_2022-04-17.csv', sep="")) %>%
  group_by(idregion,iddistrict,sch_owner) %>%
  summarise(sample_size=n())


school_weights_df <- df_frame %>%
  ungroup() %>%
  mutate(total_students_frame=sum(class4_combined)) %>%
  left_join(strata_weight_size) %>%
  group_by(idregion,iddistrict,sch_owner) %>%
  mutate(strata_count=n(),
         strata_size=sum(class4_combined),
         strata_school_prob=strata_size/total_students_frame) %>%
  mutate(strata_prob=(sample_size)*(class4_combined/strata_size),
         ipw=1/strata_school_prob*(1/strata_prob)) 

write_excel_csv(school_weights_df, paste(sampling_folder, '/school_weights_', Sys.Date(),  '.csv', sep=""))


# Weights for Ampl-b in 5th grade
amplb_student_weights <- school_weights_df %>%
  rename(school_weight=ipw) %>%
  mutate(class_weight=total_stream_class5/1, # weight is the number of 5th grade streams divided by number selected (1)
         student_weight=(class5_combined/total_stream_class5)/25,
         final_weight=school_weight*class_weight*student_weight
         ) 
  
write_excel_csv(amplb_student_weights, paste(sampling_folder, '/amplb_weights_', Sys.Date(),  '.csv', sep=""))



```

```{r}
library(srvyr)
#sanity check of the sampling weights and results
# use weights to estimate population average of internet prevalence

df_frame %>%
  ungroup() %>%
  mutate(electricity=if_else(electricity=="No Electricity",0,1)) %>%
  summarise(electricity=mean(electricity))

school_sampler <- function(seed) {
  set.seed(seed)
  
  t <- school_weights_df %>%
    filter(sample_size>0) %>%
    group_by(idregion,iddistrict,sch_owner) %>%
    sample_n(size=sample_size, weight=class4_combined) %>%
    ungroup() %>%
    as_survey_design(strata=c('idregion','iddistrict','sch_owner'),
                   weight=ipw) %>%
    mutate(electricity=if_else(electricity=="No Electricity",0,1)) %>%
    summarise(electricity=survey_mean(electricity))
  
  return(t)
}

bootstrap_df <- bind_rows(lapply(sample(x=c(1:10000),size=100),
                                 school_sampler))

bootstrap_df

linked_sample <- read_csv(file=paste(sampling_folder, '/sample_clean_2022-04-17.csv', sep="")) %>%
  filter(!is.na(idemis_code)) %>%
  select(idemis_code) %>%
  ungroup() %>%
  left_join(school_weights_df) 

linked_sample %>%
  mutate(electricity=if_else(electricity=="No Electricity",0,1)) %>%
  summarise(electricity=Hmisc::wtd.mean(electricity, weights=ipw))



linked_sample %>%
  filter(!is.na(ipw)) %>%
  ungroup() %>%
  as_survey_design(strata=c('idregion','iddistrict','sch_owner'),
                   weight=ipw) %>%
  mutate(electricity=if_else(electricity=="No Electricity",0,1)) %>%
  summarise(electricity=survey_mean(electricity))
```


# Reconstruct sample weights after field work

Because of issues in field work, the sample weights need to be reconstructed. A number of schools could not be reached during the field work.  A few issues caused the problems reaching the schools.

    Teacher strikes posed a challenge during the survey. The strikes began at the beginning of the third academic term, the week before the survey started. Teacher participation in the strike varied across schools. Enumerators observed that even when teachers were not striking, students (or their parents) were opting to stay home from school because they were unsure whether teachers would be present. Enumerators often documented this in comments. When logistically possible, enumerators tried returning to schools that were closed from strikes (usually not the next day, given that schools were not supposed to anticipate the survey date) – but if returning to the original would cause significant delays, the original schools were instead substituted with one of the two substitution options provided for each school. The strength of the strike fluctuated during the dates of the data collection, with the strike action generally tapering after the initial start of data collection. The Sierra Leone Teachers Union issued a 21-day strike to commence May 27. Enumerators reported an increase in striking teachers following the May 27 announcement. It was largely resolved through negotiations with the MBSSE that resulted in an agreement to increase salaries by 45% starting in 2023, but this agreement was announced on June 14, by which time nearly all schools had been surveyed.
    
    Another disruption that occurred during the survey was female genital mutilation (FRM) practices. These were carried out by Sierra Leone “secret societies,” sometime referred to by enumerators in comments as “bondo society.” When enumerators encountered FGM being carried out among schoolgirls, they tried to return on a different date to the school to complete the survey.
    
    Other reasons enumerators encountered for low student attendance included: Days of heavy rain; in very-understaffed schools, many students/parents opt not to attend; when a school does not have enough teachers, classes are sometimes combined (e.g. class 3 and class 4 students are taught the same material) leading to students being less interested in school; a community itself was small; children helping their family with farming and economic activities (e.g., giving extra help on market days) instead of attending class. Students also had to delay surveys at schools due to “sports days” (similar to “field days” in a US education context).
    
    
```{r}
#read in record of replacements
replacement_schools_df <- read_excel(path=paste0(sampling_folder, "/Record of Replacements.xlsx"), sheet="Schools")


#read in sample with cleaned info
sample_clean <- read_csv(paste0(sampling_folder, "/sample_clean_2022-04-17.csv"))

#read in school data
visited_schools <- read_csv(file.path(download_folder, "emis_fixes.csv")) %>% select(-m1s0q2_emis) %>%
  group_by(school_code) %>%
  summarise(visited=1,
            replaced=mean(replaced, na.rm=T)) %>%
  mutate(idemis_code=as.numeric(school_code),
         replaced=if_else(is.na(replaced),"Sampled School","Replaced School")) %>%
  filter(!is.na(idemis_code)) %>%
  left_join(df_selected) 



```

Get summaries statistics of visited schools

```{r country_map3, echo=FALSE}

   pal <- colorFactor(
     palette = c("red", "green"),
     domain = c("Replaced School", "Sampled School")
   )
   
leaflet(data=visited_schools) %>%
    addTiles()  %>%
    addCircleMarkers( lng=~geopointlongitude,  lat=~geopointlatitude, color=~pal(visited_schools$replaced),
                      radius=7,
                popup =  paste("Name: ", visited_schools$idschool_name, " <br>",
                                  "Region: ", visited_schools$idregion, " <br>",
                                  "District: ", visited_schools$iddistrict, " <br>",
                                  "EMIS: ", visited_schools$idemis_code)) %>%
  addLegend(position="bottomright", pal=pal, values=~visited_schools$replaced, title="Schools Visited")
```

Stats on number of replacements

```{r}
visited_schools %>% group_by(replaced) %>% summarise(n=n()) %>% flextable()
```


Get number of schools by strata
```{r}
sampled_strata <- sample_clean %>%
  group_by(iddistrict) %>%
  summarise(`Number Sampled`=n())

visited_strata <- visited_schools %>%
    group_by(iddistrict) %>%
  summarise(`Number Visited`=n())

strata_stats <- sampled_strata %>%
  left_join(visited_strata)

flextable(strata_stats) %>%
  add_header_lines('Districts Sampled versus Selected')
```

```{r}
sampled_strata <- sample_clean %>%
  group_by(sch_owner) %>%
  summarise(`Number Sampled`=n())

visited_strata <- visited_schools %>%
    group_by(sch_owner) %>%
  summarise(`Number Visited`=n())

strata_stats <- sampled_strata %>%
  left_join(visited_strata)

flextable(strata_stats) %>%
  add_header_lines('School Ownership Sampled versus Selected')
```

```{r}
sampled_strata <- sample_clean %>%
  group_by(idregion,iddistrict,sch_owner) %>%
  summarise(`Number Sampled`=n())

visited_strata <- visited_schools %>%
    group_by(idregion,iddistrict,sch_owner) %>%
  summarise(`Number Visited`=n())

strata_stats <- sampled_strata %>%
  left_join(visited_strata)

flextable(strata_stats) %>%
  add_header_lines('Full Strata Sampled versus Selected')

```
# Produce final weights based on visited schools

```{r}



strata_weight_size <- visited_schools %>%
  group_by(idregion,iddistrict,sch_owner) %>%
  summarise(sample_size=n())


revised_school_weights_df <- df_frame %>%
  ungroup() %>%
  mutate(total_students_frame=sum(class4_combined)) %>%
  left_join(strata_weight_size) %>%
  group_by(idregion,iddistrict,sch_owner) %>%
  mutate(strata_count=n(),
         strata_size=sum(class4_combined),
         strata_school_prob=strata_size/total_students_frame) %>%
  mutate(strata_prob=(sample_size)*(class4_combined/strata_size),
         ipw=1/strata_school_prob*(1/strata_prob)) 

write_excel_csv(revised_school_weights_df, paste(sampling_folder, '/school_weights_revised_', Sys.Date(),  '.csv', sep=""))


# Weights for Ampl-b in 5th grade
revised_amplb_student_weights <- revised_school_weights_df %>%
  rename(school_weight=ipw) %>%
  mutate(class_weight=total_stream_class5/1, # weight is the number of 5th grade streams divided by number selected (1)
         student_weight=(class5_combined/total_stream_class5)/25,
         final_weight=school_weight*class_weight*student_weight
         ) 
  
write_excel_csv(revised_amplb_student_weights, paste(sampling_folder, '/amplb_weights_revised_', Sys.Date(),  '.csv', sep=""))


```

```{r}
library(srvyr)
#sanity check of the sampling weights and results
# use weights to estimate population average of internet prevalence

df_frame %>%
  ungroup() %>%
  mutate(electricity=if_else(electricity=="No Electricity",0,1)) %>%
  summarise(electricity=mean(electricity))

school_sampler <- function(seed) {
  set.seed(seed)
  
  t <- revised_school_weights_df %>%
    filter(sample_size>0) %>%
    group_by(idregion,iddistrict,sch_owner) %>%
    sample_n(size=sample_size, weight=class4_combined) %>%
    ungroup() %>%
    as_survey_design(strata=c('idregion','iddistrict','sch_owner'),
                   weight=ipw) %>%
    mutate(electricity=if_else(electricity=="No Electricity",0,1)) %>%
    summarise(electricity=survey_mean(electricity))
  
  return(t)
}

bootstrap_df <- bind_rows(lapply(sample(x=c(1:10000),size=100),
                                 school_sampler))

summary(bootstrap_df$electricity)

linked_sample <- visited_schools %>%
  filter(!is.na(idemis_code)) %>%
  select(idemis_code) %>%
  ungroup() %>%
  left_join(school_weights_df) 

linked_sample %>%
  mutate(electricity=if_else(electricity=="No Electricity",0,1)) %>%
  summarise(electricity=Hmisc::wtd.mean(electricity, weights=ipw))



linked_sample %>%
  filter(!is.na(ipw)) %>%
  ungroup() %>%
  as_survey_design(strata=c('idregion','iddistrict','sch_owner'),
                   weight=ipw) %>%
  mutate(electricity=if_else(electricity=="No Electricity",0,1)) %>%
  summarise(electricity=survey_mean(electricity))
```
    