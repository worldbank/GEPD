---
title: "Madagascar Teacher Cleaning"
author: "Brian Stacy"
date: "9/9/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(haven)
library(vtable)
library(here)
library(readxl)
library(stringr)
library(Hmisc)
library(naniar)

#Country name
country <-'MDG'
country_name <- "Madagascar"
year <- '2021'

#########################
# File paths #
#########################
#The download_folder will be the location of where raw data is downloaded from the API
#The save_folder will be the location of where cleaned data is stored



if (str_to_lower(Sys.getenv("USERNAME")) == "wb469649" ){
  #project_folder  <- "//wbgfscifs01/GEDEDU/datalib-edu/projects/gepd"
  project_folder  <- "C:/Users/wb469649/WBG/HEDGE Files - HEDGE Documents/GEPD-Confidential/CNT/"
  download_folder <-file.path(paste(project_folder,country,paste(country,year,"GEPD", sep="_"),paste(country,year,"GEPD_v01_RAW", sep="_"),"Data/raw/School", sep="/"))
  sampling_folder <-file.path(paste(project_folder,country,paste(country,year,"GEPD", sep="_"),paste(country,year,"GEPD_v01_RAW", sep="_"),"Data/sampling", sep="/"))
  confidential_folder <- file.path(paste(project_folder,country,paste(country,year,"GEPD", sep="_"),paste(country,year,"GEPD_v01_RAW", sep="_"),"Data/confidential/School", sep="/"))
  save_folder <- file.path(paste(project_folder,country,paste(country,year,"GEPD", sep="_"),paste(country,year,"GEPD_v01_RAW", sep="_"),"Data/anonymized/School", sep="/"))
  backup_onedrive="no"
  save_folder_onedrive <- file.path(paste("C:/Users/wb469649/WBG/Ezequiel Molina - Dashboard (Team Folder)/Country_Work/",country_name,year,"Data/clean/School", sep="/"))
  
} else {
  download_folder <- choose.dir(default = "", caption = "Select folder to open data downloaded from API")
  save_folder <- choose.dir(default = "", caption = "Select folder to save final data")

}


```

```{r functions}

bin_var <- function(var, val) {
  case_when(
    var==val  ~ 1,
    var!=val   ~ 0,
    is.na(var) ~ as.numeric(NA))
}



bin_var_2 <- function(var, val) {
  if_else(var==val, 
          as.numeric(1),
          as.numeric(var))
}
```


# Load Data

Read in data for Madagascar.  All teacher questionnaire files were numbered as Module 3 in the Madagascar school survey.  These files will be read in one at a time.

Start with non-teacher files, including the school file.

```{r schoolload}
## 2. Calling in datasets ----  
# load sampling frame

sampling_frame <- read_excel(path=paste0(sampling_folder,'/Echantillons SDI V12.xlsx'))

## 1st grade assessment ----
first_grade <- read_dta(file.path(download_folder, "/21-M5.dta")) %>%
  filter(s_type_ecole==3) #just keep dashboard schools

## 4th grade assessment ----
fourth_grade <- read_dta(file.path(download_folder, "/20-M5_liste.dta")) %>%
  filter(s_type_ecole==3) #just keep dashboard schools

## School level data ----
school_dta<-read_dta(file.path(download_folder, "/01-SECABD24DE.dta")) %>%
  filter(s_type_ecole==3) #just keep dashboard schools
vtable(school_dta)

## Infrastructure school ----
infrastructure_dta <- read_dta(file.path(download_folder, "/06-M1SECC.dta")) %>%
  filter(s_type_ecole==3) #just keep dashboard schools
vtable(infrastructure_dta)

## Infrastructure school : blackboard, light, cholk ----
#input_dta <- read_dta(file.path(download_folder, "/astata/17-M4BC..dta"))
input_dta<-read_dta(file.path(download_folder, "/01-SECABD24DE.dta")) %>%
  filter(s_type_ecole==3) #just keep dashboard schools

vtable(input_dta)

## Management school  ----
management_dta <- read_dta(file.path(download_folder, "/11-M3A.dta")) %>%
  filter(s_type_ecole==3) #just keep dashboard schools
vtable(management_dta)



#rename a few key variables up front
school_dta<- school_dta %>%
  mutate(
         enumerator_number=s_enqueteur_code ,
         survey_time=s_date_heure_fin	,
         school_code=s_ecole_code
         # lat=s_latitude,
         # lon=s_longitude,
  ) %>%
  mutate(school_code=if_else(school_code==0, 328328, school_code)) %>%
  mutate(school_code=if_else(school_code==62181, 558163, school_code))  #fix an error where the school code was loaded incorrectly



#------------------------------------------------------------------------------#
## 3. Lists of variables ----  

#list additional info that will be useful to keep in each indicator dataframe
preamble_info <- c( "s_ecole_code", 
                   "s_region_code", "s_cisco_code", "s_commune_name",   
                   "s_commune_code", "s_ecole_name", "s_zap_name", "s_zap_code",
                   "s_urbain", "s_date_visite", "s_enqueteur_code", "s_type_ecole", "s_public", "s_etab_code",
                   "lat","lon"
                   )

school_dta_preamble <- input_dta %>%
  left_join(school_dta) %>%
  mutate(
    lat=s_latitude,
    lon=s_longitude
  ) %>%
  select(preamble_info)

```

Now load the teacher files.

```{r teacherload}
list.files(path=download_folder)

#Teacher absence file
teacher_roster_dta <- read_dta(paste0(download_folder, '/08-M2AB1AB.dta')) %>%
  left_join(school_dta_preamble) %>%
  filter(s_type_ecole==3) #just keep dashboard schools

#Teacher questionnaire file
teacher_questionnaire_dta_raw <- read_dta(paste0(download_folder, '/10-M2BA1_E.dta')) %>%
  left_join(school_dta_preamble) %>%
  filter(s_type_ecole==3) #just keep dashboard schools

#Teacher assessment file
teacher_assessment_dta_raw <- read_dta(paste0(download_folder, '/24-M6CORR.dta')) %>% #read in the corrected version of the teacher assessment
  select(-c("s_ecole_nom","s_region_code","id1_nom", "s_cisco_code","s_cisco_nom", "s_commune_nom",   "s_commune_code",  "nom_fokontany",   "id4_nom", "numero_fiche" )) %>% #drop some information that may conflict with primary school file.  Just match on school code
  left_join(school_dta_preamble) %>%
  filter(s_type_ecole==3) #just keep dashboard schools

teacher_pedagogy_dta <- read_dta(paste0(download_folder, '/17-M4BC.dta')) %>%
  left_join(school_dta_preamble) %>%
  filter(s_type_ecole==3) #just keep dashboard schools

```
# Practice Indicators

## Teacher Absence

```{r absence}



#############################################
##### Teacher Absence ###########
#############################################

# School survey. Percent of teachers absent. Teacher is coded absent if they are: 
#   - not in school 
# - in school but absent from the class 
# - in the class but not teaching.

#create absence file containing just teacher selected for absence check
teacher_absence_dta <- teacher_roster_dta %>%
  filter(s_m2aa_09a==1)
  


#number missing
teacher_absence_dta <- teacher_absence_dta %>%
  mutate(n_mssing_EFFT=n_miss_row(.))

#rename a few key variables up front
teacher_absence_dta<- teacher_absence_dta %>%
  mutate(
         teacher_number=s_m2aa_02c ,
         teacher_position=s_m2aa_04,
         teacher_permanent=bin_var(s_m2aa_05,1),
         teacher_contract=bin_var(s_m2aa_05,2),
         #teacher_temporary=bin_var(m2saq5,3),
         teacher_volunteer=bin_var(s_m2aa_05,5),
         #teacher_ngo=bin_var(m2saq5,5)==5,
         # teacher_other=case_when(
         #   m2saq5==97 ~ m2saq5_other,
         #   m2saq5!=97 ~ "NA"
         # ),
         teacher_fulltime=bin_var(s_m2aa_06,1),
         teacher_male=bin_var(s_m2aa_03,1),
         teacher_grd1=bin_var(s_m2aa_08aa,1),
         teacher_grd2=bin_var(s_m2aa_08ab,1),
         teacher_grd3=bin_var(s_m2aa_08ac,1),
         teacher_grd4=bin_var(s_m2aa_08ad,1),
         teacher_grd5=bin_var(s_m2aa_08ae,1),
         #teacher_language=bin_var(m2saq8__1,1),
         #teacher_math=bin_var(m2saq8__2,1),
         #teacher_both_subj=bin_var(m2saq8__3,1),
         #teacher_other_subj=bin_var(m2saq8__97,1),
  )

teacher_absence_dta<- teacher_absence_dta %>%
  mutate(temp=rowSums(select(.,teacher_grd1, teacher_grd2, teacher_grd3, teacher_grd4, teacher_grd5))) %>% # here we count the number of grades present in the classroom
  mutate(multigrade=case_when(temp > 1 ~ 1,
                              TRUE ~ 0)) %>% #this variable is equal to 1 if there are several grades and zero otherwise
  select(-temp)

#  We create a unique grade variable

teacher_absence_dta <- teacher_absence_dta %>%
  mutate(grade=case_when(teacher_grd1==1 & multigrade!=1 ~ 1,
                         teacher_grd2==1 & multigrade!=1 ~ 2,
                         teacher_grd3==1 & multigrade!=1 ~ 3,
                         teacher_grd4==1 & multigrade!=1 ~ 4,
                         teacher_grd5==1 & multigrade!=1 ~ 5,
                         multigrade==1 ~ 6,
                         TRUE ~ NA_real_)) %>%
  mutate(grade=factor(grade, levels=c(1,2,3,4,5,6), labels=c("Grade 1", "Grade 2", "Grade 3", "Grade 4", "Grade 5", "Multigrade")))

label(teacher_absence_dta$grade) <- "Grade"

#list additional info that will be useful to keep in each indicator dataframe
preamble_info_absence <- c('teacher_number',
                           'teacher_position', 'teacher_permanent', 'teacher_contract', 'teacher_volunteer', 
                           'teacher_fulltime', 'teacher_male', 'teacher_grd1', 'teacher_grd2', 'teacher_grd3', 'teacher_grd4', 'teacher_grd5', 
                            's_m2ab1a_01', 's_m2ab1b_01')

#create indicator for whether each teacher was absent from school
teacher_absence_dta <- teacher_absence_dta %>%
  mutate(
    sch_absence_rate_1st=100*case_when(
      s_m2ab1a_01==5 ~ 1,
      s_m2ab1a_01!=5   ~ 0,
      is.na(s_m2ab1a_01) ~ as.numeric(NA)
    ),
    
    sch_absence_rate_2nd=100*case_when(
      s_m2ab1b_01==5 ~ 1,
      s_m2ab1b_01!=5   ~ 0,
      is.na(s_m2ab1b_01) ~ as.numeric(NA)
    ))

#create indicator for whether each teacher was absent from classroom or school
teacher_absence_dta <- teacher_absence_dta %>%
  mutate(

    
    absence_rate_1st=100*case_when(
      s_m2ab1a_01==5 | s_m2ab1a_01==3  ~ 1,
      s_m2ab1a_01==1 | s_m2ab1a_01==2 | s_m2ab1a_01==4   ~ 0,
      is.na(s_m2ab1a_01) ~ as.numeric(NA)
    ),
    
    absence_rate_2nd=100*case_when(
      s_m2ab1b_01==5 | s_m2ab1b_01==3  ~ 1,
      s_m2ab1b_01==1 | s_m2ab1b_01==2 | s_m2ab1b_01==4   ~ 0,
      is.na(s_m2ab1b_01) ~ as.numeric(NA)
    )) 
    
    
#set absence measure to be second measure
teacher_absence_dta <- teacher_absence_dta %>%
  mutate(absence_rate=absence_rate_2nd,
         sch_absence_rate=sch_absence_rate_2nd)
  
teacher_absence_final<- teacher_absence_dta %>%
  select(preamble_info, preamble_info_absence, contains('absence')) %>%
  group_by(s_ecole_code, teacher_number) %>%
  summarise_all( ~(if(is.numeric(.)) mean(., na.rm = TRUE) else first(.)))

     #plot the indicator  
 hist(teacher_absence_dta$absence_rate)  
 hist(teacher_absence_dta$sch_absence_rate)  


#Build teacher absence practice indicator
final_indicator_data_EFFT <- teacher_absence_dta %>%
  group_by(s_ecole_code) %>%
  summarise_all( ~(if(is.numeric(.)) mean(., na.rm = TRUE) else first(.)))

#Breakdowns by Male/Female
final_indicator_data_EFFT_M <- teacher_absence_dta %>%
  filter(teacher_male==1) %>%
  group_by(s_ecole_code) %>%
  summarise_all( ~(if(is.numeric(.)) mean(., na.rm = TRUE) else first(.))) 

final_indicator_data_EFFT_F <- teacher_absence_dta %>%
  filter(teacher_male==0) %>%
  group_by(s_ecole_code) %>%
  summarise_all( ~(if(is.numeric(.)) mean(., na.rm = TRUE) else first(.))) 


```

## Teacher Content Knowledge

```{r content}

# School survey. Fraction correct on teacher assessment. In the future, we will align with SDG criteria for minimum proficiency.


  #number missing
  teacher_assessment_dta <- teacher_assessment_dta_raw %>%
    mutate(n_mssing_CONT=n_miss_row(.),
           teacher_number=id12) 
    
  
  

  

  
  #drop the correct the letter and other tasks not usually featured in assessment
  teacher_assessment_dta <- teacher_assessment_dta %>% 
    select(-starts_with("t1s2_"), -starts_with("t12"),-f9_comment2)
  
  #recode assessment variables to be 1 if teacher got it correct and zero otherwise
  teacher_assessment_dta<- teacher_assessment_dta %>%
    mutate_at(vars(starts_with("t1"), starts_with("t2")), ~bin_var(.,1)  )
  
  # because two scorers were used to grade test, take the average of the scores per teacher
  teacher_assessment_dta<- teacher_assessment_dta %>%
    group_by(s_ecole_code, teacher_number) %>%
    summarise_all( ~(if(is.numeric(.)) mean(., na.rm = TRUE) else first(.))) %>%
    ungroup()
 
  
  
  ####Literacy####
  #calculate # of literacy items
  #note: grep is a tool for searching text with specified pattern.  In our case, we are looking for m5s1q, which is the prefix of literacy items
  teacher_assessment_dta$literacy_length<-length(grep(x=colnames(teacher_assessment_dta), pattern="t1"))
  
  
  lit_items<-colnames(teacher_assessment_dta[,grep(x=colnames(teacher_assessment_dta), pattern="t1")])
  
  #calculate teachers lit items correct
  teacher_assessment_dta <- teacher_assessment_dta %>%
    mutate(literacy_content_knowledge=100*rowMeans(.[grep(x=colnames(teacher_assessment_dta), pattern="t1")], na.rm=TRUE),
           correct_letter=100*rowMeans(.[grep(x=colnames(teacher_assessment_dta), pattern="t1s2_")], na.rm=TRUE),
           cloze=100*rowMeans(.[grep(x=colnames(teacher_assessment_dta), pattern="t11")], na.rm=TRUE),
           grammar=100*rowMeans(.[grep(x=colnames(teacher_assessment_dta), pattern="t13")], na.rm=TRUE),
           read_passage=100*rowMeans(.[grep(x=colnames(teacher_assessment_dta), pattern="t14")], na.rm=TRUE)) #there is no such item in the test in madagascar
  
  ####Math####
  #calculate # of math items
  teacher_assessment_dta$math_length<-length(grep(x=colnames(teacher_assessment_dta), pattern="t2"))
  
  math_items<-colnames(teacher_assessment_dta[,grep(x=colnames(teacher_assessment_dta), pattern="t2")])
  
  #calculate teachers math items correct
  teacher_assessment_dta <- teacher_assessment_dta %>%
    mutate(math_content_knowledge=100*rowMeans(.[grep(x=colnames(teacher_assessment_dta), pattern="t2")], na.rm=TRUE),
           arithmetic_number_relations=100*rowMeans(.[grep(x=colnames(teacher_assessment_dta), pattern="t21|t22|t23|t24|t25|t211|t212")], na.rm=TRUE),
           geometry=100*rowMeans(.[grep(x=colnames(teacher_assessment_dta), pattern="t26|t27|t213")], na.rm=TRUE),
           interpret_data=100*rowMeans(.[grep(x=colnames(teacher_assessment_dta), pattern="t28|t29|t210")], na.rm=TRUE))
  
 
     #plot the indicator  
 hist(teacher_assessment_dta$literacy_content_knowledge)    
 hist(teacher_assessment_dta$math_content_knowledge)    
  
  #calculate % correct for literacy, math, and total
  final_indicator_data_CONT <- teacher_assessment_dta %>%
    group_by(s_ecole_code) %>%
    add_count(s_ecole_code,name='m5_teach_count') %>%
    mutate(content_knowledge=case_when(
      (!is.na(math_content_knowledge) & !is.na(literacy_content_knowledge)) ~ (math_content_knowledge+literacy_content_knowledge)/2,
      is.na(math_content_knowledge)  ~ literacy_content_knowledge,
      is.na(literacy_content_knowledge)  ~ math_content_knowledge)) %>%
    mutate(content_proficiency=100*as.numeric(content_knowledge>=80),
           content_proficiency_70=100*as.numeric(content_knowledge>=70),
           content_proficiency_75=100*as.numeric(content_knowledge>=75),
           literacy_content_proficiency=100*as.numeric(literacy_content_knowledge>=80),
           literacy_content_proficiency_70=100*as.numeric(literacy_content_knowledge>=70),
           literacy_content_proficiency_75=100*as.numeric(literacy_content_knowledge>=75),
           math_content_proficiency=100*as.numeric(math_content_knowledge>=80),
           math_content_proficiency_70=100*as.numeric(math_content_knowledge>=70),
           math_content_proficiency_75=100*as.numeric(math_content_knowledge>=75)) %>%
    summarise_all( ~(if(is.numeric(.)) mean(., na.rm = TRUE) else first(.))) 
  # 
  
  #### TO DO #####
  
  
  # #Breakdown by Male/Female
  # final_indicator_data_CONT_M <- teacher_assessment_dta %>%
  #   mutate(TEACHERS__id=g4_teacher_number) %>%
  #   left_join(select(teacher_absence_dta,c('m2saq3','school_code', 'TEACHERS__id')), by=c('school_code', 'TEACHERS__id')) %>%
  #   filter(m2saq3==1) %>%
  #   group_by(school_code) %>%
  #   add_count(school_code,name='m5_teach_count') %>%
  #   mutate(content_knowledge=case_when(
  #     (!is.na(math_content_knowledge) & !is.na(literacy_content_knowledge)) ~ (math_content_knowledge+literacy_content_knowledge)/2,
  #     is.na(math_content_knowledge)  ~ literacy_content_knowledge,
  #     is.na(literacy_content_knowledge)  ~ math_content_knowledge)) %>%
  #   mutate(content_proficiency=100*as.numeric(content_knowledge>=80),
  #          content_proficiency_70=100*as.numeric(content_knowledge>=70),
  #          content_proficiency_75=100*as.numeric(content_knowledge>=75),
  #          literacy_content_proficiency=100*as.numeric(literacy_content_knowledge>=80),
  #          literacy_content_proficiency_70=100*as.numeric(literacy_content_knowledge>=70),
  #          literacy_content_proficiency_75=100*as.numeric(literacy_content_knowledge>=75),
  #          math_content_proficiency=100*as.numeric(math_content_knowledge>=80),
  #          math_content_proficiency_70=100*as.numeric(math_content_knowledge>=70),
  #          math_content_proficiency_75=100*as.numeric(math_content_knowledge>=75)) %>%
  #   summarise_all( ~(if(is.numeric(.)) mean(., na.rm = TRUE) else first(.))) %>%
  #   
  #   select(-ends_with('length'), -ends_with('items'), -starts_with('interview'), -starts_with('enumerator'),
  #          -starts_with('g4_teacher'), -c('teacher_assessment_answers__id', 'm5sb_troster', 'm5sb_tnum')) 
  # 
  # final_indicator_data_CONT_F <- teacher_assessment_dta %>%
  #   mutate(TEACHERS__id=g4_teacher_number) %>%
  #   left_join(select(teacher_absence_dta,c('m2saq3','school_code', 'TEACHERS__id')), by=c('school_code', 'TEACHERS__id')) %>%
  #   filter(m2saq3==2) %>%
  #   group_by(school_code) %>%
  #   add_count(school_code,name='m5_teach_count') %>%
  #   mutate(content_knowledge=case_when(
  #     (!is.na(math_content_knowledge) & !is.na(literacy_content_knowledge)) ~ (math_content_knowledge+literacy_content_knowledge)/2,
  #     is.na(math_content_knowledge)  ~ literacy_content_knowledge,
  #     is.na(literacy_content_knowledge)  ~ math_content_knowledge)) %>%
  #   mutate(content_proficiency=100*as.numeric(content_knowledge>=80),
  #          content_proficiency_70=100*as.numeric(content_knowledge>=70),
  #          content_proficiency_75=100*as.numeric(content_knowledge>=75),
  #          literacy_content_proficiency=100*as.numeric(literacy_content_knowledge>=80),
  #          literacy_content_proficiency_70=100*as.numeric(literacy_content_knowledge>=70),
  #          literacy_content_proficiency_75=100*as.numeric(literacy_content_knowledge>=75),
  #          math_content_proficiency=100*as.numeric(math_content_knowledge>=80),
  #          math_content_proficiency_70=100*as.numeric(math_content_knowledge>=70),
  #          math_content_proficiency_75=100*as.numeric(math_content_knowledge>=75)) %>%
  #   summarise_all( ~(if(is.numeric(.)) mean(., na.rm = TRUE) else first(.))) %>%
  #   
  #   select(-ends_with('length'), -ends_with('items'), -starts_with('interview'), -starts_with('enumerator'),
  #          -starts_with('g4_teacher'), -c('teacher_assessment_answers__id', 'm5sb_troster', 'm5sb_tnum')) 
  # 
  # 
  

```
# Policy Indicators

## Teacher Teaching Attraction

```{r tatt}

 #############################################
  ##### Teacher Teaching Attraction ###########
  #############################################
  
  # In the school survey, a number of De Facto questions on teacher attraction are asked. 0.8 points is awarded for each of the following: 
  #   - 0.8 Points. Teacher satisfied with job 
  # - 0.8 Points. Teacher satisfied with status in community 
  # - 0.8 Points. Would better teachers be promoted faster? 
  #   - 0.8 Points. Do teachers receive bonuses? 
  #   - 0.8 Points. One minus the fraction of months in past year with a salary delay.
  
  
  #create function to clean teacher attitudes questions.  Need to reverse the order for scoring for some questions.  
  #Should have thought about this, when programming in Survey Solutions and scale 1-5.
  
  attitude_fun  <- function(x) {
    case_when(
      x==98 ~ as.numeric(NA),
      TRUE ~ x
    )
  }
  
  attitude_fun_rev  <- function(x) {
    case_when(
      x==98 ~ as.numeric(NA),
      x==1 ~ 5,
      x==2 ~ 4,
      x==3 ~ 3,
      x==4 ~ 2,
      x==5 ~ 1
    )
  }
  
  
  teacher_questionnaire_dta <- teacher_questionnaire_dta_raw %>%
    mutate(teacher_satisfied_job=attitude_fun_rev(d_m2be_01)/5,
           teacher_satisfied_status=attitude_fun_rev(d_m2be_02)/5,
           better_teachers_promoted=bin_var(d_m2be_03,1),
           teacher_bonus=bin_var(d_m2be_04,1),
           teacher_bonus_attend=if_else(d_m2be_04==1,
                                        bin_var(d_m2be_05a,1),
                                        0),
           teacher_bonus_student_perform=if_else(d_m2be_04==1,
                                                 bin_var(d_m2be_05b,1),
                                                 0),
           teacher_bonus_extra_duty=if_else(d_m2be_04==1,
                                            bin_var(d_m2be_05c,1),
                                            0),
           teacher_bonus_hard_staff=if_else(d_m2be_04==1,
                                            bin_var(d_m2be_05d,1),
                                            0),
           # teacher_bonus_subj_shortages=if_else(d_m2be_04==1,
           #                                      bin_var(d_m2be_05e,1),
           #                                      0),
           teacher_bonus_add_qualif=if_else(d_m2be_04==1,
                                            bin_var(d_m2be_05e,1),
                                            0),
           teacher_bonus_school_perform=if_else(d_m2be_04==1,
                                                bin_var(d_m2be_05f,1),
                                                0),
           teacher_bonus_other=if_else(d_m2be_04==1,
                                       if_else(d_m2be_05g==1,d_m2be_05au,"NA"),
                                       "NA"),
           salary_delays=s_m2bb1_01) %>%
    mutate(salary_delays=if_else(salary_delays>12,12,salary_delays)) %>%
    mutate(teacher_attraction=1+0.8*teacher_satisfied_job+.8*teacher_satisfied_status+.8*better_teachers_promoted+.8*teacher_bonus+.8*(1-salary_delays/12))

   #plot the indicator  
 hist(teacher_questionnaire_dta$teacher_attraction)    
  
  final_indicator_data_TATT <- teacher_questionnaire_dta %>%
    mutate(n_mssing_TATT=n_miss_row(.)) %>%
    group_by(s_ecole_code) %>%
    summarise_all( ~(if(is.numeric(.)) mean(., na.rm = TRUE) else first(.))) 
  
  
```

## Teacher Teaching Selection and Deployment

```{r tsdp}
  
  #############################################
  ##### Teacher Teaching Selection and Deployment ###########
  #############################################
  
  # School Survey. The De Facto portion of the Teacher Selection and Deployment Indicator considers two issues: how teachers are selected into the profession and how teachers are assigned to positions (transferred) once in the profession. Research shows that degrees and years of experience explanin little variation in teacher quality, so more points are assigned for systems that also base hiring on content knowledge or pedagogical skill. 2 points are available for the way teachers are selected and 2 points are available for deployment. 
  # 
  # Selection 
  # - 0 Points. None of the below 
  # - 1 point. Teachers selected based on completion of coursework, educational qualifications, graduating from tertiary program (including specialized programs), selected based on experience 
  # - 2 points. Teacher recruited based on passing written content knowledge test, passed interview stage assessment, passed an assessment conducted by supervisor based on practical experience, conduct during mockup class. 
  # 
  # Deployment 
  # - 0 Points. None of the below 
  # - 1 point. Teachers deployed based on years of experience or job title hierarchy 
  # - 2 points. Teacher deployed based on performance assessed by school authority, colleagues, or external evaluator, results of interview.
  
  
  teacher_questionnaire_dta <- teacher_questionnaire_dta %>%
    mutate(
      teacher_selection=case_when(
        (d_m2bd_01c==1 | d_m2bd_01d==1 | d_m2bd_01f==1 | d_m2bd_01g==1 )  ~ 2,
        (d_m2bd_01a==1 | d_m2bd_01b==1 | d_m2bd_01e==1) ~ 1,
        (d_m2bd_01a==0 & d_m2bd_01b==0 & d_m2bd_01c==0 & d_m2bd_01d==0 & d_m2bd_01e==0 & d_m2bd_01f==0 & d_m2bd_01g==0 ) ~ 0
      ),
      teacher_deployment=case_when(
        (d_m2be_06bb==1 | d_m2be_06bc==1 | d_m2be_06bd==1  )  ~ 2,
        (d_m2be_06ba==1 | d_m2be_06bf==1) ~ 1,
        ((d_m2be_06ba==0 & d_m2be_06bb==0 & d_m2be_06bc==0 & d_m2be_06bd==0 | d_m2be_06bf==0) ) ~ 0
        
      )
    ) %>%
    mutate(teacher_selection_deployment=1+teacher_selection+teacher_deployment)
  
 #plot the indicator  
 hist(teacher_questionnaire_dta$teacher_selection_deployment)   
  
  final_indicator_data_TSDP <- teacher_questionnaire_dta %>%  
    mutate(n_mssing_TSDP=n_miss_row(.)) %>%
    group_by(s_ecole_code) %>%
    summarise_all( ~(if(is.numeric(.)) mean(., na.rm = TRUE) else first(.))) 
  
  
```

## Teacher Teaching Support

```{r tsup}
  #############################################
  ##### Teacher Teaching Support ###########
  #############################################
  
  
  # School survey. Our teaching support indicator asks teachers about participation and the experience with several types of formal/informal training: 
  #   
  #   Pre-Service (Induction) Training: 
  #   - 0.5 Points. Had a pre-service training 
  # - 0.5 Points. Teacher reported receiving usable skills from training 
  # 
  # Teacher practicum (teach a class with supervision) 
  # - 0.5 Points. Teacher participated in a practicum 
  # - 0.5 Points. Practicum lasted more than 3 months and teacher spent more than one hour per day teaching to students. 
  # 
  # In-Service Training: 
  #   - 0.5 Points. Had an in-service training 
  # - 0.25 Points. In-service training lasted more than 2 total days 
  # - 0.125 Points. More than 25% of the in-service training was done in the classroom. 
  # - 0.125 Points. More than 50% of the in-service training was done in the classroom. 
  # 
  # Opportunities for teachers to come together to share ways of improving teaching: 
  #   - 1 Point if such opportunities exist.
  

  teacher_questionnaire_dta <- teacher_questionnaire_dta %>%
    mutate(opportunities_teachers_share=bin_var(d_m2bd_14,1),
           pre_training_exists=bin_var(d_m2bd_03,1)/2,
           pre_training_useful=if_else(d_m2bd_03==1,
                                       bin_var(d_m2bd_04,1),
                                       0)/2,
           pre_training_practicum=bin_var(d_m2bd_06,1)/2,
           pre_training_practicum_lngth=case_when(
             (d_m2bd_06==1 & (d_m2bd_07m>=3 | d_m2bd_07a>=1) & d_m2bd_08>=1) ~  0.5,
             (d_m2bd_06==1 & ((d_m2bd_07m<3 & d_m2bd_07a<1) | d_m2bd_08<1))  ~ 0,
             d_m2bd_06==2 ~ 0,
             TRUE ~ 0),
           in_service_exists=bin_var(d_m2bd_09,1),
           in_servce_lngth=case_when(
             (d_m2bd_09==1 & d_m2bd_10>2 ) ~ 1,
             (d_m2bd_09==1 & d_m2bd_10<=2) ~ 0,
             d_m2bd_09==0 ~ 0,
             TRUE ~ 0
           ),
           in_service_classroom=case_when(
             (d_m2bd_09==1 & d_m2bd_13>=3)  ~ 1,
             (d_m2bd_09==1 & d_m2bd_13==2)  ~ 0.5,
             (d_m2bd_09==1 & d_m2bd_13==1)  ~ 0,
             d_m2bd_09==0 ~ 0,
             TRUE ~ 0
           )
    ) %>%
    mutate(pre_service=pre_training_exists+pre_training_useful,
           practicum=pre_training_practicum+pre_training_practicum_lngth,
           in_service=0.5*in_service_exists+0.25*in_servce_lngth+0.25*in_service_classroom) %>%
    mutate(teacher_support=1+pre_service+practicum+in_service+opportunities_teachers_share) 
  # mutate(teacher_support=if_else(teacher_support>5,5,teacher_support)) #need to fix
  
  
 #plot the indicator  
 hist(teacher_questionnaire_dta$teacher_support) 
  
  
  
  final_indicator_data_TSUP <- teacher_questionnaire_dta %>%
    mutate(n_mssing_TSUP=n_miss_row(.)) %>%
    group_by(s_ecole_code) %>%
    summarise_all( ~(if(is.numeric(.)) mean(., na.rm = TRUE) else first(.)))  
  
  
```

```{r tevl}
  #############################################
  ##### Teacher Teaching Evaluation ###########
  #############################################
  
  # School survey. This policy lever measures whether there is a teacher evaluation system in place, and if so, the types of decisions that are made based on the evaluation results. Score is the sum of the following: 
  #   - 1 Point. Was teacher formally evaluated in past school year? 
  #   - 1 Point total. 0.2 points for each of the following: Evaluation included evaluation of attendance, knowledge of subject matter, pedagogical skills in the classroom, students' academic achievement, students' socio-emotional development 
  # - 1 Point. Consequences exist if teacher receives 2 or more negative evaluations 
  # - 1 Point. Rewards exist if teacher receives 2 or more positive evaluations
  
  

  
  teacher_questionnaire_dta<- teacher_questionnaire_dta %>%
    mutate(formally_evaluated=bin_var(d_m2bb2_06,1),
           evaluation_content=if_else(d_m2bb2_06==1,
                                      (d_m2bb2_08b+d_m2bb2_08c+ d_m2bb2_08d + d_m2bb2_08e + d_m2bb2_08f)/5,
                                      0),
           negative_consequences=case_when(
             (d_m2bb2_09a==1 | d_m2bb2_09b==1 | d_m2bb2_09c==1 | d_m2bb2_09d==1 | d_m2bb2_09f==1) ~ 1,
              TRUE ~ 0),
           positive_consequences=case_when(
             (d_m2bb2_10a==1 | d_m2bb2_10b==1 | d_m2bb2_10c==1 | d_m2bb2_10d==1 | d_m2bb2_10f==1) ~ 1,
             TRUE ~ 0)
    ) %>%
    mutate(teaching_evaluation=1+formally_evaluated+evaluation_content+negative_consequences+positive_consequences)

#plot the indicator  
 hist(teacher_questionnaire_dta$teaching_evaluation)
  
  final_indicator_data_TEVL <- teacher_questionnaire_dta %>%
    mutate(n_mssing_TEVL=n_miss_row(.)) %>%
    group_by(s_ecole_code) %>%
    summarise_all( ~(if(is.numeric(.)) mean(., na.rm = TRUE) else first(.))) 
  
  
  
```

```{r tmna}
  
  #############################################
  ##### Teacher  Monitoring and Accountability ###########
  #############################################
  
  # School Survey. This policy lever measures the extent to which teacher presence is being monitored, whether attendance is rewarded, and whether there are consequences for chronic absence. Score is the sum of the following: 
  #   - 1 Point. Teachers evaluated by some authority on basis of absence. 
  # - 1 Point. Good attendance is rewarded. 
  # - 1 Point. There are consequences for chronic absence (more than 30% absence). 
  # - 1 Point. One minus the fraction of teachers that had to miss class because of any of the following: collect paycheck, school administrative procedure, errands or request of the school district office, other administrative tasks.
  

  
  teacher_questionnaire_dta <- teacher_questionnaire_dta %>%
    mutate(attendance_evaluated=if_else(d_m2bb2_06==1,
                                        case_when(
                                          (d_m2bb2_08a==1) ~ 1,
                                          TRUE ~ 0
                                        ),
                                        0),
           attendance_rewarded=if_else(d_m2be_04==1,
                                       case_when(
                                         (d_m2be_05a==1) ~ 1,
                                         TRUE ~ 0
                                       ),
                                       0),
           attendence_sanctions=case_when(
             (d_m2bb2_021==1 | d_m2bb2_022==1 | d_m2bb2_023==1 | d_m2bb2_024==1 | d_m2bb2_025==1 | d_m2bb2_028==1) ~ 1,
             
             TRUE ~ 0
           ),
           miss_class_admin=case_when(
             (d_m2bb2_01a==1 | d_m2bb2_01b==1 | d_m2bb2_01c==1 | d_m2bb2_01d==1 | d_m2bb2_01e==1) ~ 1,
             TRUE ~ 0
           )
    )  %>%
    mutate(teacher_monitoring=1+attendance_evaluated + 1*attendance_rewarded + 1*attendence_sanctions + (1-miss_class_admin))

#plot the indicator  
 hist(teacher_questionnaire_dta$teacher_monitoring)
 hist(teacher_questionnaire_dta$attendance_evaluated)
 hist(teacher_questionnaire_dta$attendance_rewarded)
 hist(teacher_questionnaire_dta$attendence_sanctions)
 hist(teacher_questionnaire_dta$miss_class_admin)
  
  final_indicator_data_TMNA <- teacher_questionnaire_dta %>%
    mutate(n_mssing_TMNA=n_miss_row(.)) %>%
    group_by(s_ecole_code) %>%
    summarise_all( ~(if(is.numeric(.)) mean(., na.rm = TRUE) else first(.))) 
  
  
```

```{r tinm}
  
  #############################################
  ##### Teacher  Intrinsic Motivation ###########
  #############################################
  
  # 
  # School Survey. This lever measures whether teachers are intrinsically motivated to teach. The question(s) aim to address this 
  # phenomenon by measuring the level of intrinsic motivation among teachers as well as teacher values that may be relevant for 
  # ensuring that the teacher is motivated to focus on all children and not just some. Average score (1 (worst) - 5 (best)) on items 
  # given to teachers on intrinsic motivation.
    intrinsic_motiv_q_rev <- c('d_m2bc_01','d_m2bc_02', 'd_m2bc_03', 'd_m2bc_04', 'd_m2bc_05', 'd_m2bc_06')
  
  #intrinsic_motiv_q <- c( 'm3scq11_tinm', 'm3scq14_tinm')
  

  attitude_fun_rev2  <- function(x) {
    case_when(
      x==97 ~ as.numeric(NA),
      x==1 ~ 5,
      x==2 ~ 3.67,
      x==3 ~ 2.33,
      x==4 ~ 1
    )
  }
  
  teacher_questionnaire_dta <- teacher_questionnaire_dta %>%
    mutate(n_mssing_TINM=n_miss_row(.)) %>%
    mutate(    
      SE_PRM_TINM_1 = 100*if_else(d_m2bc_01>=3,1,0),  #(De Facto) Percent of teachers that agree or strongly agrees with It is acceptable for a teacher to be absent if the ~
      SE_PRM_TINM_2 = 100*if_else(d_m2bc_02>=3,1,0),  #(De Facto) Percent of teachers that agree or strongly agrees with It is acceptable for a teacher to be absent if stud~
      SE_PRM_TINM_3 = 100*if_else(d_m2bc_03>=3,1,0),  #(De Facto) Percent of teachers that agree or strongly agrees with It is acceptable for a teacher to be absent if the ~
      SE_PRM_TINM_4 = 100*if_else(d_m2bc_04>=3,1,0),  #(De Facto) Percent of teachers that agree or strongly agrees with Students deserve more attention if they attend scho~
      SE_PRM_TINM_5 = 100*if_else(d_m2bc_05>=3,1,0),  #(De Facto) Percent of teachers that agree or strongly agrees with Students deserve more attention if they come to sch~
      SE_PRM_TINM_6 = 100*if_else(d_m2bc_06>=3,1,0),  #(De Facto) Percent of teachers that agree or strongly agrees with Students deserve more attention if they are motivat~
      #SE_PRM_TINM_7 = 100*if_else(m3scq7_tinm>=3,1,0),  #(De Facto) Percent of teachers that agree or strongly agrees with Students have a certain amount of intelligence and ~
      #SE_PRM_TINM_8 = 100*if_else(m3scq10_tinm>=3,1,0),  #(De Facto) Percent of teachers that agree or strongly agrees with To be honest, students can't really change how inte~
      #SE_PRM_TINM_9 = 100*if_else(m3scq11_tinm>=3,1,0),  #(De Facto) Percent of teachers that agree or strongly agrees with Students can always substantially change how intell~
      #SE_PRM_TINM_10 = 100*if_else(m3scq14_tinm>=3,1,0) #(De Facto) Percent of teachers that agree or strongly agrees with \"Students can change even their basic intelligence l~
    ) %>%
    mutate_at(intrinsic_motiv_q_rev, attitude_fun_rev2 ) %>%
    #mutate_at(intrinsic_motiv_q, attitude_fun ) %>%
    mutate(acceptable_absent=(d_m2bc_01+ d_m2bc_02 + d_m2bc_03)/3,
           students_deserve_attention=(d_m2bc_04+ d_m2bc_05 + d_m2bc_06 )/3,
           #growth_mindset=(m3scq7_tinm + m3scq10_tinm + m3scq11_tinm + m3scq14_tinm)/4,
           motivation_teaching=case_when(
             d_m2bc_09==1 ~ 0, #penalize teachers who report the number 1 reason is to have steady career rather than helping students or internal motivation.
             d_m2bc_09!=1 ~ 1,
             TRUE ~ as.numeric(NA)
           )) %>%
    mutate(intrinsic_motivation=1+(.2*acceptable_absent + .2*students_deserve_attention  + motivation_teaching+bin_var(d_m2bd_02,1))) 

#plot the indicator  
 hist(teacher_questionnaire_dta$intrinsic_motivation)
 hist(teacher_questionnaire_dta$acceptable_absent)
 hist(teacher_questionnaire_dta$students_deserve_attention)
 hist(teacher_questionnaire_dta$motivation_teaching)
 hist(teacher_questionnaire_dta$d_m2bd_02)
 
 
  final_indicator_data_TINM <- teacher_questionnaire_dta %>%
    mutate(n_mssing_TINM=n_miss_row(.)) %>%
    group_by(s_ecole_code) %>%
    summarise_all( ~(if(is.numeric(.)) mean(., na.rm = TRUE) else first(.)))  
  
  

```

