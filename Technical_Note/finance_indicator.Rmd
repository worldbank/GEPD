---
title: "Finance Indicator"
author: "Brian Stacy"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
library(tidyverse)
library(here)
library(frontier)
library(wbstats)
dir <- here()


```




# Background on Finance Indicator

## Essence
The aim of this indicator is to capture three aspects of education financing that play a key role in promoting learning for all. These are adequacy, equity, and efficiency.

## Indicator  

The indicator is a score ranging from 1 to 5 that considers the quality of financing using three lenses – adequacy, equity, and efficiency. This score is calculated using 4 sub-indicators: 1) per child spending (adequacy), 2) public management financing performance (efficiency), 3) outcomes per spending (efficiency), and 4) an equity measure.  The disaggregated information for each of these 4 sub-indicators is available as a drill-down option.

## Background  

Data shows that many countries have successfully increased their investments in education. Just in the last 15 years, government spending on education has doubled. However, more is needed to achieve the ambitious learning agenda that countries must have. At the same time, it is not sufficient to invest more, countries need to invest differently to reach the desired learning outcomes. Using resources differently will require tackling weak links in spending-learning chains. This will involve solving misalignments between funds and learning, address unequal spending, avoid spending on the wrong things, and prevent situations in which the funds don’t reach the schools. For this, the indicator proposed is aiming to measure not just adequacy (how much money is being invested), but also equity and efficiency (how the investment is being distributed and whether it is achieving the expected results).

## Instrument Used for Measurement  

- School Survey  
- Policy Survey  
- Survey of Public Officials  
- Existing Data Source

## Measurement Approach
All four sub-indicators mentioned above will be indexed, so that a summary score can be generated to measure overall health of financing. The methodology for each of the sub-indicators is the following:    

1. To capture adequacy: Calculate per child spending using data from the UIS.  
2.	To capture efficiency in terms of performance of the financing processes: Use the summary score resulting from the Public Expenditure and Financial Accountability (PEFA) assessment. The score is then weighted to give additional weight to the service delivery pillar that is part of the PEFA assessment.  

3. 	To capture efficiency in terms of outcomes achieved for the given level of investment (return on education investment): Use linear regressions to estimate the expected adjusted learning outcomes (combination of access and learning outcomes) associated with the different levels of per child spending. The sub-indicator reports the distance between the observed outcomes and the expected outcomes.  

4. 	To capture equity: Calculate how much education spending goes towards the bottom two quintiles of the income distribution. First, calculate total spending going towards primary, secondary, and tertiary education.  

### Instrument Sources
UIS for spending per child and spending per education level (primary, secondary, and tertiary)  

Public Expenditure and Financial Accountability (PEFA)


# PEFA

For PEFA download data at https://www.pefa.org/assessments/batch-downloads.

Download all indicators for all countries.  Score A=4.0, B+=3.5, B=3.0, C+=2.5, C=2, D+=1.5, D=1.

Composite 2016 weighted index is Composite of 31 pillars and 94 indicators; all indicators weighted 1% except 4 indicators in “Pillar 8: Performance Information for Service Delivery” weighted 2.5% each
Composite 2011 weighted index is Composite of 31 pillars and 76 indicators; all indicators weighted 1.2% except 1 indicator in “Pillar 23: Availability of information on resources received by service delivery units” weighted 10%

When available the 2016 version of PEFA is used.  When not available, the 2011 versions is used.

```{r pefa}
#get data based on 2016 framework
pefa_2016_df <- read_csv(file=paste0(dir, "/Technical_Note/Finance_Data/pefa_2016_framework_data_20230809.csv")) %>%
  select(Country, Year, contains(".")) %>%
  mutate(across(starts_with(c('PI','UD')),~case_when(
    . == "A" ~ 4,
    . == "B+" ~ 3.5,
    . == "B" ~ 3,
    . == "C+" ~ 2.5,
    . == "C" ~ 2,
    . == "D+" ~ 1.5,
    grepl("D",.) ~ 1,
    TRUE ~ as.numeric(NA)
  )),
  mutate(
    across(starts_with(c('PI','UD')),.fns=~case_when(
      grepl("PI-08",cur_column()) ~ 2.5*./100, #100 items total weight_sum <- rowSums(select(pefa_2016_df, starts_with('wt_')), na.rm = TRUE)
      TRUE ~ 1*./100
    ), .names="wt_{.col}")
  )) 


pefa_2016_final_df <- pefa_2016_df %>%
  transmute(
    Country=Country,
    Year=Year,
    composite_2016=rowMeans(select(pefa_2016_df, starts_with(c('PI','UD'))), na.rm = TRUE),
    composite_2016_weighted=rowSums(select(pefa_2016_df, starts_with("wt_")), na.rm = TRUE)
  )


#get data based on 2011 framework
pefa_2011_df <- read_csv(file=paste0(dir, "/Technical_Note/Finance_Data/pefa_2011_framework_data_20230809.csv")) %>%
  select(Country, Year, contains(".")) %>%
  mutate(across(starts_with(c('PI','UD')),~case_when(
    . == "A" ~ 4,
    . == "B+" ~ 3.5,
    . == "B" ~ 3,
    . == "C+" ~ 2.5,
    . == "C" ~ 2,
    . == "D+" ~ 1.5,
    grepl("D",.) ~ 1,
    TRUE ~ as.numeric(NA)
  )),
  mutate(
    across(starts_with(c('PI','UD')),.fns=~case_when(
      grepl("PI-23",cur_column()) ~ 10*./100, #132 items total weight_sum <- rowSums(select(pefa_2011_df, starts_with('wt_')), na.rm = TRUE)
      TRUE ~ 1.2*./100
    ), .names="wt_{.col}")
  )) 


pefa_2011_final_df <- pefa_2011_df %>%
  transmute(
    Country=Country,
    Year=Year,
    composite_2011=rowMeans(select(pefa_2011_df, starts_with(c('PI','UD'))), na.rm = TRUE),
    composite_2011_weighted=rowSums(select(pefa_2011_df, starts_with("wt_")), na.rm = TRUE)
  )


#combine 2011 and 2016 versions.  Choose 2016 when availab le
pefa_final_df <- pefa_2016_final_df %>% 
  bind_rows(pefa_2011_final_df ) %>%
  group_by(Country) %>%
  fill(starts_with('composite'),.direction='downup') %>%
  filter(Year==max(Year)) %>%
  mutate(composite=if_else(!is.na(composite_2016),composite_2016, composite_2011 ),
         composite_weighted=if_else(!is.na(composite_2016_weighted),composite_2016_weighted, composite_2011_weighted ))



write_excel_csv(pefa_final_df, paste0(dir, "/Technical_Note/Finance_Data/pefa_final_data_",Sys.Date(),'.csv'))
```

# Frontier Analysis

 A brief description of the finance indicator is below.  The original analysis and code was run in Stata.  Below is the documentation for the stochastic analysis command.  

Frontier fits stochastic production or cost frontier models; the default is a production frontier model. It provides estimators for the parameters of a linear model with a disturbance that is assumed to be a mixture of two components, which have a strictly nonnegative and symmetric distribution, respectively. Frontier can fit models in which the nonnegative distribution component (a measurement of inefficiency) is assumed to be from a half-normal, exponential, or truncated-normal distribution.  See Kumbhakar and Lovell (2000) for a detailed introduction to frontier analysis.

``` Stata
ge x1=ln(learn_adj_yrs_sch_5yr) if learn_adj_yrs_sch_5yr~=.
ge x2=ln(exp_total_perchild_5yr) if exp_total_perchild_5yr~=.
frontier x1 x2 if learn_adj_yrs_sch_5yr~=. & exp_total_perchild_5yr~=.
predict xb_adj, xb
predict u_adj, u 
```

The model for the stochastic frontier model is as follows.  Let $y_i$ be an outcome indicator, in our case it is harmonized learning outcomes (HLO) from the world bank, and $x_i$ be the inputs, in our case government expenditure per student, primary (PPP adjusted).

$$ln(y_i) = \beta_0 + \beta_1 ln(x_i) + \epsilon_i - u_i$$
and 

$$e^{u_i}$$ is the country's efficiency parameter.  These parameters are estimated using maximum likelihood.


```{r}
stochastic_frontier_df <- read_csv(paste0(dir, "/Technical_Note/Finance_Data/stochastic_frontier.csv"))
```

```{r data, message=FALSE, warning=FALSE, include=FALSE}

# get World Bnak country metadata
countries_df <- wb_countries()

# get WDI data on Government expenditure per student, primary (% of GDP per capita)
wdi_df <- wb_data(indicator=c('SE.XPD.PRIM.PC.ZS','SP.POP.TOTL','NY.GDP.PCAP.PP.CD','HD.HCI.HLOS', "HD.HCI.LAYS"),
                  country='countries_only',
                  start_date = 2010,
                  end_date=2022) %>%
  group_by(iso3c) %>%
  arrange(date) %>%
  fill(c('SE.XPD.PRIM.PC.ZS','SP.POP.TOTL','NY.GDP.PCAP.PP.CD','HD.HCI.HLOS', "HD.HCI.LAYS"), .direction="downup")


# get WDI data on Government expenditure per student, primary (% of GDP per capita)
gni_df <- wb_data(indicator=c( 'NY.GNP.PCAP.CD'),
                  country='countries_only',
                  start_date = 2022,
                  end_date=2022) %>%
  select(iso3c, NY.GNP.PCAP.CD) %>%
  write_excel_csv(file=paste0(dir, '/Technical_Note/GEPD_finance/gni_df.csv'))

#pull finance indicator data from UIS
finance_pull <- 'http://data.uis.unesco.org/RestSDMX/sdmx.ashx/GetData/NATMON_DS/X_PPP_1_FSGOV+SAP_1+20062.AFG+ALA+ALB+DZA+ASM+AND+AGO+AIA+ATG+ARG+ARM+ABW+AUS+AUT+AZE+BHS+BHR+BGD+BRB+BLR+BEL+BLZ+BEN+BMU+BTN+BOL+BIH+BWA+BRA+VGB+BRN+BGR+BFA+BDI+KHM+CMR+CAN+CPV+CYM+CAF+TCD+ZZA+CHL+CHN+HKG+MAC+COL+COM+COG+COK+CRI+CIV+HRV+CUB+CUW+CYP+CZE+PRK+COD+DNK+DJI+DMA+DOM+ECU+EGY+SLV+GNQ+ERI+EST+SWZ+ETH+FRO+FLK+FJI+FIN+FRA+GUF+PYF+GAB+GMB+GEO+DEU+GHA+GIB+GRC+GRL+GRD+GLP+GUM+GTM+GGY+GIN+GNB+GUY+HTI+VAT+HND+HUN+ISL+IND+IDN+IRN+IRQ+IRL+IMN+ISR+ITA+JAM+JPN+JEY+JOR+KAZ+KEN+KIR+KWT+KGZ+LAO+LVA+LBN+LSO+LBR+LBY+LIE+LTU+LUX+MDG+MWI+MYS+MDV+MLI+MLT+MHL+MTQ+MRT+MUS+MYT+MEX+FSM+MCO+MNG+MNE+MSR+MAR+MOZ+MMR+NAM+NRU+NPL+NLD+ANT+NCL+NZL+NIC+NER+NGA+NIU+NFK+MKD+MNP+NOR+OMN+PAK+PLW+PSE+PAN+PNG+PRY+PER+PHL+PCN+POL+PRT+PRI+QAT+KOR+MDA+REU+ROU+RUS+RWA+SHN+KNA+LCA+SPM+VCT+BLM+MAF+WSM+SMR+STP+SAU+SEN+SRB+SYC+SLE+SGP+SXM+SVK+SVN+SLB+SOM+ZAF+SSD+ESP+LKA+SDN+XDN+SUR+SJM+SWE+CHE+SYR+TJK+THA+TLS+TGO+TKL+TON+TTO+TUN+TUR+TKM+TCA+TUV+UGA+UKR+ARE+GBR+TZA+USA+VIR+URY+UZB+VUT+VEN+VNM+WLF+ESH+YEM+ZMB+ZWE/all?startTime=2010&endTime=2023'

finance_sdmx_df <- readSDMX(file=finance_pull) %>% as_tibble()


finance_df <- finance_sdmx_df %>%
  pivot_wider(id_cols = c('LOCATION', 'obsTime'),
              names_from = NATMON_IND,
              values_from=obsValue
  ) %>%
  mutate(spending_per_sap=X_PPP_1_FSGOV*1000000/SAP_1,
         spending_per_pupil=X_PPP_1_FSGOV*1000000/`20062`) %>%
  filter(!is.na(X_PPP_1_FSGOV)) %>%
  rename(iso3c=LOCATION,
         date=obsTime) %>%
  mutate(date=as.numeric(date))  %>%
  left_join(wdi_df) %>%
  left_join(countries_df) %>%
  mutate(spender_per_sap_gdp=100*spending_per_sap/NY.GDP.PCAP.PP.CD) %>%
  group_by(iso3c) %>%
  arrange(date) %>%
  fill(spending_per_sap,spender_per_sap_gdp, spending_per_pupil, SE.XPD.PRIM.PC.ZS,HD.HCI.HLOS, .direction = 'downup') %>%
  group_by(iso3c) %>%
  filter(row_number()==max(row_number()))




```

```{r sfa}
#use frontier package to calculate stochastic frontier analysis using HLOs and spending per school age child.
cobbDouglas <- sfa( log( HD.HCI.LAYS ) ~ log( spending_per_pupil ),
                    data = finance_df)

summary(cobbDouglas)

#get efficiencies

finance_df$sfa_results <- as.vector(efficiencies(cobbDouglas, asInData = TRUE))

write_excel_csv(finance_df, file=paste0(dir, '/Technical_Note/GEPD_finance/finance_df.csv'))


```

