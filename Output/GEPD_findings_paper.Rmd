---
title: 'Measuring the Drivers of the Learning Crisis Across Countries using the Global Education Policy Dashboard'
author: "GEPD Team"
date: "`r Sys.Date()`"
output:
  bookdown::word_document2: 
    toc: yes
    fig_width: 9
    fig_height: 6
abstract: "To help countries put an end to Learning Poverty, the World Bank's Education Global Practice has developed and is supporting countries in the deployment of the Global Education Policy Dashboard (GEPD). This new tool offers a strong basis for identifying priorities for investment and policy reforms that are suited to each country context. It does so by (1) highlighting gaps between what the evidence suggests is effective in promoting learning and what is happening in practice in each system; and (2) allowing governments to track progress as they take action to close those gaps.  In this article, the conceptual foundations of the GEPD will be presented along with the methodology behind data collection. Additionally, findings from five countries will be discussed: Peru, Jordan, Rwanda, Ethiopia, and Madagascar."
bibliography: ./bibliography.bib
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE,
	fig.width = 9, fig.height = 6, fig.path = "plots/", dev = c("png"), dpi=500
)
#libraries
library(tidyverse)
library(foreign)
library(here)
library(vtable)
library(flextable)
library(ggthemes)
library(Hmisc)
library(httr)
library(patchwork)
library(ggrepel)
library(lubridate)
library(haven)
library(zoo)
library(readxl)
library(ggbeeswarm)
library(estimatr)
library(ggpmisc)
library(ggthemes)
library(ggtext)
library(gtsummary)
library(geosphere)
library(fixest)
library(modelsummary)
options(modelsummary_factory_word = 'flextable')


#directories


  if (str_to_lower(Sys.info()["user"]) == "wb469649") {
      
    dir <- here()

  } else if (str_to_lower(Sys.info()["user"]) == "wb577189") {

    dir <- "C:/Users/wb577189/OneDrive - WBG/Documents/GitHub/GEPD"

  }


indicators_dir <- paste(dir, 'Indicators', sep="/")
out_dir <- paste(dir, 'Output', sep="/")

#path to confidential directory

  if (str_to_lower(Sys.info()["user"]) == "wb469649") {
    #directories
    confidential_dir<- "C:/Users/wb469649/WBG/HEDGE Files - HEDGE Documents/GEPD-Confidential/"
    anonymized_dir <- "C:/Users/wb469649/WBG/HEDGE Files - HEDGE Documents/GEPD/"

  } else if (str_to_lower(Sys.info()["user"]) == "wb577189") {
    #directories
    confidential_dir<- "C:/Users/wb577189/OneDrive - WBG/GEPD-Confidential/"
    anonymized_dir <- "C:/Users/wb577189/OneDrive - WBG/GEPD/"

  }



# change_here <- function(new_path){
#   new_root <- here:::.root_env
#   
#   new_root$f <- function(...){file.path(new_path, ...)}
#   
#   assignInNamespace(".root_env", new_root, ns = "here")
# }

#list countries
countries <- c("PER", "JOR", "RWA", "MDG", "ETH")

```

```{r functions}
#functions
FitFlextableToPage <- function(ft, pgwidth = 5){

  ft_out <- ft %>% autofit()

  ft_out <- width(ft_out, width = dim(ft_out)$widths*pgwidth /(flextable_dim(ft_out)$widths))
  return(ft_out)
}

#add equations to plots
eq_plot_txt <- function(y,x,data) {
  
  f <- as.formula(paste(y,x, sep="~"))
  
  eq <- lm_robust(f, data=data, se_type='HC2')
  coef <- coef(eq)
  std_err <- sqrt(diag(vcov(eq)))
  r_2<- summary(eq)$r.squared
  glue::glue("y = {round(coef[1],3)} + {round(coef[2],3)} x, R<sup>2</sup> = {round(r_2[1],3)} <br> &nbsp;   &nbsp;  	&nbsp; 	&nbsp;   ({round(std_err[1],3)}) &nbsp;   &nbsp;  ({round(std_err[2],3)})" )
}
```


```{r load}

#read in indicator metadata
indicators <- read_csv(paste(dir,'Indicators/indicators.csv', sep = "/"))

# read in indicator data
PER_data <- read_csv(paste0(indicators_dir, "/GEPD_Indicators_API_", 'PER', ".csv")) %>%
  mutate(country="Peru",
         date='2019')

RWA_data <- read_csv(paste0(indicators_dir, "/GEPD_Indicators_API_", 'RWA', ".csv")) %>%
  mutate(country="Rwanda",
         date='2020')

JOR_data <- read_csv(paste0(indicators_dir, "/GEPD_Indicators_API_", 'JOR', ".csv")) %>%
  mutate(country="Jordan",
         date='2019')

ETH_data <- read_csv(paste0(indicators_dir, "/GEPD_Indicators_API_", 'ETH_pooled', ".csv")) %>%
  mutate(country="Ethiopia",
         date='2020-2021') 
# %>%
#   rename(value=value_pooled)

MDG_data <- read_csv(paste0(indicators_dir, "/GEPD_Indicators_API_", 'MDG', ".csv")) %>%
  mutate(country="Madagascar",
         date='2021')

# Indicator names
indicator_names_df <- PER_data %>%
  select(Series, `Indicator Name`)

combined_df_raw <- bind_rows(PER_data,JOR_data, ETH_data, RWA_data, MDG_data)

#add color coding
#Tags
practice_tags <- "SE.PRM.PROE|SE.LPV.PRIM|SE.PRM.LERN|SE.PRM.TENR|SE.PRM.EFFT|SE.PRM.CONT|SE.PRM.ATTD|SE.PRM.LCAP|SE.PRM.PEDG"

#function to create score data for a specified country and year

  combined_df_fn_p <- combined_df_raw %>%
    filter(grepl(practice_tags, Series) | grepl("Percent", `Indicator Name`)) %>%
    select(country, date, Series, value) %>%
    mutate(value=if_else(value==-999,as.numeric(NA),as.numeric(value))) %>%
    mutate(
      value_metadata=case_when(
        value <85 ~ "Needs Improvement",
        value >=85 & value<90 ~ "Caution",
        value >=90 ~ "On Target",
        TRUE ~ "N/A"
      ))
  
  combined_df_fn_c <- combined_df_raw %>%
    filter(!(grepl(practice_tags, Series) | grepl("Percent", `Indicator Name`))) %>%
    select(country, date, Series,  value) %>%
    mutate(value=if_else(value==-999,as.numeric(NA),as.numeric(value))) %>%
    mutate(
      value_metadata=case_when(
        value <3 ~ "Needs Improvement",
        value >=3 & value<4 ~ "Caution",
        value >=4 ~ "On Target",
        TRUE ~ "N/A"
      ))
  
  combined_df <- combined_df_fn_p %>%
    bind_rows(combined_df_fn_c) %>%
    arrange(Series) %>%
    mutate(
           value=round(value,1),
           value_color=case_when(
             value_metadata=="Needs Improvement" ~ "#FF0000",
             value_metadata=="Caution" ~ "#FCD606",
             value_metadata=="On Target" ~ "#85C546",
             TRUE ~ "#808080"
           ),
           Series=str_replace_all(Series, "SE.LPV","SE.GEPD"))


combined_wide_df <- combined_df %>%
  select(Series, country, value) %>%
  pivot_wider(
    names_from=country, 
    values_from=value
  ) %>%
  left_join(indicator_names_df)

combined_wide_color <- combined_df %>%
  select(Series, country, value_color) %>%
  pivot_wider(
    names_from=country, 
    values_from=value_color
  ) %>%
  left_join(indicator_names_df)

```


# Introduction

[The next three paragraphs are pulled verbatim from technical note.  This is just a placeholder, as we should add custom motivation]

Many countries, despite having significantly increased access to education for their children and youth, now realize that they are facing a learning crisis. In low- and middle-income countries, where enrollment in primary school is nearly universal, even before the COVID-19 pandemic hit, 53% of children suffered from Learning Poverty—meaning that they could not read and understand a short age-appropriate story by age 10. This reality underlines that schooling is not the same as learning, even though education policy often assumes that it is. The learning crisis has only deepened with the extended school closures and the sharp recessions caused by the pandemic.

The World Development Report 2018 argued that the learning crisis has multiple causes: poor service delivery in schools and communities, policies that are not aligned toward learning for all, and unhealthy politics and low bureaucratic capacity. To tackle the crisis and improve student learning for all, countries need to know where they stand on these three key dimensions—practices (or service delivery), policies, and politics. But providing such a systemwide overview requires better measurement. Many drivers of learning are not captured by existing administrative systems. And although new measurement tools capture some of these drivers well, no single instrument pulls together data on all these areas. This gap leaves policymakers in the dark about what is working and what isn’t.

To fill this gap, the World Bank, with support from the Bill and Melinda Gates Foundation, the UK’s Department for International Development, and the Government of Japan, has launched a Global Education Policy Dashboard, which measures the key drivers of learning outcomes in basic education around the world. In doing so, the GEPD highlights where systems are falling short in providing quality education for all children,  identifies gaps between current practice and what evidence suggests would be most effective in promoting learning for all, and helps governments in setting priorities and tracking progress as they work to close those gaps.  

[@filmer2018learning]

[@azevedo2021will]

What is the key message from this work?   
  - 
  
![](plots/gepd_framework.png)  

# Methodology

The Dashboard project collects new data in each country using three new instruments: A School Survey, a Policy Survey, and a Survey of Public Officials. Data collection involves school visits, classroom observations, legislative reviews, teacher and student assessments, and interviews with teachers, principals, and public officials. In addition, the project draws on some existing data sources to complement the new data it collects. A major objective of the GEPD project was to develop focused, cost-effective instruments and data-collection procedures, so that the dashboard can be inexpensive enough to be implemented (and re-implemented) in many countries. The team achieved this by streamlining and simplifying existing instruments, and thereby reducing the time required for data collection and training of enumerators.

![](plots/cost_fig.png)

## Instruments 

A detailed description of the GEPD instruments is available in the [GEPD Technical Note](https://www.educationpolicydashboard.org/sites/epd/files/resources-documents/GEPD%20Technical%20Note.pdf).  Additionally, all code used to construct the indicators is available in the Global Education Policy Dashboard [Github page](https://github.com/worldbank/GEPD).  A shorter description pertaining to each of the three instruments can be found below:

•	School Survey: The School Survey collects data primarily on Practices (the quality of service delivery in schools), but also on some de facto Policy indicators.  It consists of streamlined versions of existing instruments used by the World Bank and partners—including Service Delivery Indicators (SDI) Surveys on teachers and inputs/infrastructure, TEACH on pedagogical practice, Global Early Child Development Database (GECDD) and Measuring Early Learning Quality and Outcomes (MELQO) on school readiness of young children, and the Development World Management Survey (D-WMS) on management quality—together with new questions to fill gaps in those instruments. Though the number of modules in the School Survey is similar to the full version of the Service Delivery Indicators (SDI) Survey, the number of items and the complexity of the questions within each module have been reduced to streamline the survey, while additional items and assessments have been added from other instruments. The School Survey includes 8 short modules: School Information, Teacher Presence, Teacher Survey, Classroom Observation, Teacher Assessment, 1st-Grade Direct Assessment, School Management Survey, and 4th-Grade Student Assessment. 

•	Policy Survey: The Policy Survey collects information to feed into the Policy de jure indicators. This survey is filled out by key informants in each country, drawing on their knowledge to identify key elements of the policy framework (as in the SABER approach to policy-data collection that the Bank has used over the past 9 years).  The survey includes questions on policies related to teachers, school management, inputs and infrastructure, and learners. 

•	Survey of Public Officials: The Survey of Public Officials collects information about the capacity and orientation of the bureaucracy, as well as political factors affecting education outcomes. This survey is a streamlined and education-focused version of the civil-servant surveys that the Bureaucracy Lab (a joint initiative of the Governance Global Practice and the Development Impact Evaluation unit of the World Bank) has implemented recently in several countries. The survey includes questions about technical and leadership skills, work environment, stakeholder engagement, impartial decision-making, and attitudes and behaviors. 

## Sampling

The aim of the GEPD surveys is to produce nationally representative estimates with enough precision to allow detection of changes over time at a minimum power of 80% and at a 0.05 significance level. The GEPD also sets aims to detect differences by urban/rural location and by gender on relevant indicators.  In some cases, we can provide statistics by region, but this will depend on the geography of the country and the number of regions making up that country.  

For the GEPD School Survey, a two-stage random sample design is used.  In the first stage, Bank staff select a random sample of around 200 schools.  The sample is stratified based on urban/rural classification and the region in which schools are located. When stratifying by region, the GEPD team works with partners within the country to make sure all relevant geographical divisions are included. In the second stage, a random sample of teachers and students is selected to answer questions from the survey modules; this sampling is done by enumerators in the field at each school. Ten teachers per school are sampled for attendance checks, and five teachers are interviewed and given a teacher assessment. Three randomly selected 1st grade students are assessed, as is a randomly selected classroom of 4th grade students.  We could only interview three 1st grade students, compared to an entire 4th grade classroom, because the 1st grade assessment is done face to face by our enumerators and takes a considerable amount of time per student (~15-20 minutes).  The 4th grade assessment can be given to an entire class simultaneously.

For the GEPD Survey of Public Officials, 200 public education officials in each country are randomly selected for interviews.  These public officials are typically professional staff at the Ministry of Education central office, as well as from the regional or district offices. Roughly 60 officials are surveyed at the federal (or central-government) level, while 140 officials are surveyed at the regional/district level.  To select officials at the regional and district level, the team employs a cluster sampling strategy, where 10 regional offices are chosen at random from among the regions in which schools were sampled. Among these 10 regions, 10 districts are selected (one in each region) from among the districts in which schools are sampled. The result of this sampling approach is that for 10 clusters, the GEPD captures the links from the school to the district office, to the regional office, and then to the central office. In each regional/district office, 7 officials are sampled: the head of the office, the HR director, and 5 officials working in finance and planning chosen at random.  At the federal level, the GEPD team works with the Ministry of Education to identify the offices that should be included in the sample according to the functions they serve. In each office, the director of the office is interviewed along with a randomly selected number of public officials. The team aims to maintain roughly the same sampling strategy for the Survey of Public Officials for all countries, with some adaptation to country characteristics. For instance, in countries with smaller district offices, a larger number of district offices will be sampled, with fewer public officials interviewed at each of them. In countries with smaller offices at the federal level, fewer public officials will be interviewed at the federal level and more will be interviewed at the decentralized level. Ultimately, these adaptations are the result of extensive dialogue with the country counterparts. 


Before producing the sample using the stratification approach, the sampling frame is defined. Typically, the sampling frame includes all schools with at least three 1st-grade and at least three 4th-grade students, according to the latest school census. This minimum size was set to ensure that enough teachers and students would be interviewed on the limited budget available for each country.  To develop this sampling frame, the GEPD team works with the World Bank country teams and the country counterparts to compile an up-to-date and detailed database containing information on schools. Depending on the country, the sampling frame may include private schools, typically because a large share of students attends private schools. This sampling decision is jointly made by World Bank and country counterparts. As an example, in Peru only public schools were sampled, because private schools represent a small share of the schools in the country. Alternatively, in Jordan, the percentage of private schools was larger, and so a decision was made to include both public and private schools. 

For the stratified sampling, the stratification variables used are the rural/urban status of each school as well as the 1st- or 2nd-level administrative division (while the denomination changes, in most cases, the 1st administrative division is the province/department-level and the 2nd division corresponds to districts). For example, in Peru, the department and urban/rural status of the school made up the stratification variables. In cases where private schools are also included in the sampling frame, as in Jordan, the public/private status of the school is also included as a stratification variable.

In each country, the sampling strategy is slightly customized to reflect ongoing efforts and meet country needs. This is discussed further in the Data section below.




![](plots/GEPD_comprehensive.png)






# Data

Table 1: GEPD Data Collection Overview


| Country | Dates | Number of Schools | Description |
|---|---|---|---|
| Peru | November 2019 | 205 |     MELQO data was merged with the Peru school sampling frame to allow optimal stratification. The stratification was done on the basis of urban/rural   location and department. There are 25 departments in Peru. In 2017, Peru   conducted an examination of around 4,500 children aged 5-8, with a median age   of 6. The MELQO assessment is quite similar to the GEPD 1st-Grade Direct   Assessment. Using data from this 2017 survey, the team calculated means and   standard deviations by province and fed this information into the optimal   stratification algorithm. Provinces with low standard deviations among   students in terms of their MELQO development scores are allocated fewer   schools compared to an allocation that is simply based on population, and   provinces with high standard deviations are allocated more schools. 205   schools were chosen for the GEPD School Survey after optimally stratifying.    |
| Jordan | December 2019 | 250 |     For the GEPD School Survey, both public and private schools that are supervised   by the Ministry or Education were included in the sampling frame. Schools   supervised by Ministry of Defense, Ministry of Endowments, Ministry of Higher   Education, or Ministry of Social Development were excluded from the sampling   frame. This left a sampling frame containing 3,330 schools, with 1297 private   schools and 2003 public schools. Schools kept needed to have at least three 1st-grade   students, three 4th-grade students, and three teachers. Southern   schools were oversampled (to reach a total of 50 Southern schools) to allow regional   comparisons. Additionally, second-shift (evening) schools were oversampled,   for a total of 40 second-shift schools, to allow reporting on this unique   type of school.   Second-shift schools   make up around 16% of our total sample, while they make up 7.6% of the   schools in our sampling frame.  When   producing a national estimate, we reweight the schools to be reflective of   their totals in the population. 250 schools were sampled for the School   Survey after the discussed adaptations.     |
| Rwanda | February 2020 | 200 |     In the case of Rwanda, the GEPD team tested the possibility of each field team   visiting 2 schools per day. To allow visits to two schools per day, the team clustered   at the sector level and chose two schools per cluster. With a sample of 200   schools, this means that 100 PSUs had to be allocated. This clustering was   combined with stratification by district and by the urban/rural status of the   schools. The number of PSUs allocated to each stratum is proportionate to the   number of schools in each stratum (i.e., the district X urban/rural status   combination).    |
| Ethiopia | March 2020, June 2021 | 300 | In Ethiopia, a sample of 300 public schools from each of the provinces of Ethiopia was taken.  As a comparison to the total number of schools in Ethiopia, this constitutes an approximately 1% sample.  Because of the large size of the country, and because there can be very large distances between Woredas within the same province, a cluster sampling approach was chosen.  In this approach, 100 woredas were chosen with probability proportional to 4th grade size, with the number of woredas chosen within each province proportional to the regional 4th grade population.  Then within each woreda two rural and one urban school were chosen with probability proportional to 4th grade size.  Data collection started in March 2020, but because of school closures related to COVID, only 128 schools were visited at this time.  In June 2021, data collection was resumed for the other 182 schools.  During the June 2021 data collection, security issues in Tigray meant that 6 schools out of 15 originally chosen in the original sample could not be visited.  These 6 schools were replaced by schools in Amhara province. |
| Madagascar | June 2021 | 200 | In Madagascar, the sample for the GEPD school survey was drawn to be representative of primary schools at the national and regional levels, using EMIS data of 2019. The sampling frame consisted of 33,120 public and private primary schools – 25,869 public and 7,251 private schools - across the 1,567 communes covered by EMIS data in Madagascar’s 22 regions. 200 schools were selected for the GEPD survey, where the strata are regions and urban/rural status of schools. |


## GDP Data

 GDP per square kilometer data is produced by World Bank staff originally for the the Global Assessment Report on Risk Reduction (GAR) for the year 2010.  The data can be found at https://datacatalog.worldbank.org/dataset/gross-domestic-product-2010.

# Findings

## Overview of Indicators

Show low levels of learning across countries.  E.g. how manys students in 4th grade can identify basic words, 8+6, etc.  Low levels of teacher pedagogy.  Highlight some interesting Bureaucracy findings

```{r countrytabfn}
#create function for creating country comparison tables
country_tab_fn <- function(variables, title) {
  
  
tab_df <- combined_wide_df %>%
  filter(Series %in% variables) %>%
  arrange(factor(Series, levels=variables))

#set colors
tab_color_df <- combined_wide_color %>%
  filter(Series %in% variables) %>%
  arrange(factor(Series, levels=variables))

Peru_col <- tab_color_df$Peru
Jordan_col <- tab_color_df$Jordan
Rwanda_col <- tab_color_df$Rwanda
Ethiopia_col <- tab_color_df$Ethiopia
Madagascar_col <- tab_color_df$Madagascar


#build table
tab_df <- tab_df  %>%
  select(`Indicator Name`, Peru, Jordan, Rwanda, Ethiopia, Madagascar)


ovr_table <- flextable(tab_df) %>%
  add_header_lines(title) %>%
  add_footer( Group = paste0('Source: UIS, GLAD, GEPD, World Bank. 
(1) Proficiency on GEPD assessment means % students with knowledge 80%.\n  (2) Proficiency by end of primary uses threshold as per Minimum Proficiency Levels set by GAML(UIS).\n (3) All indicators are on a scale of 0-5 unless measured in %. \n (4) Green indicates indicator "on-target", yellow indicates "requires caution", red indicates "needs improvement"' )) %>%
  merge_at( j = 1:4, part = "footer") %>%
  theme_vanilla()

#colors
ovr_table <- ovr_table %>%
  bg(j = c('Peru'),
     bg = Peru_col) %>%
  bg(j = c('Jordan'),
     bg = Jordan_col) %>%
  bg(j = c('Ethiopia'),
     bg = Ethiopia_col) %>%
  bg(j = c('Rwanda'),
     bg = Rwanda_col) %>%
  bg(j = c('Madagascar'),
     bg = Madagascar_col)   


FitFlextableToPage(ovr_table) %>%
  set_table_properties(layout = "autofit")

  
}
```


Below is a table showing the means by country on the GEPD Practice Indicators.

```{r ovltab}
# Produce a table showing means by country for select practice indicators
practice_indicators <- c(
  'SE.PRM.LERN',
  'SE.PRM.EFFT',
  'SE.PRM.CONT',
  'SE.PRM.PEDG',
  'SE.PRM.INPT',
  'SE.PRM.INFR',
  'SE.PRM.LCAP',
  'SE.PRM.ATTD',
  'SE.PRM.OPMN',
  'SE.PRM.ILDR',
  'SE.PRM.PKNW',
  'SE.PRM.PMAN'
)

country_tab_fn(practice_indicators, 'GEPD Practice Indicators')

```

Below is a table showing the means by country on the GEPD Policy Indicators.

```{r poltab}
# Produce a table showing means by country for select practice indicators
policy_indicators <- c(
'SE.PRM.TATT',
'SE.PRM.TSDP',
'SE.PRM.TSUP',
'SE.PRM.TEVL',
'SE.PRM.TMNA',
'SE.PRM.TINM',
'SE.PRM.ISTD',
'SE.PRM.IMON',
'SE.PRM.LNTN',
'SE.PRM.LHTH',
'SE.PRM.LCBC',
'SE.PRM.LFCP',
'SE.PRM.LSKC',
'SE.PRM.SCFN',
'SE.PRM.SATT',
'SE.PRM.SSLD',
'SE.PRM.SSUP',
'SE.PRM.SEVL'

)

country_tab_fn(policy_indicators, 'GEPD Policy Indicators')

```

Below is a table showing the means by country on the GEPD Bureaucracy or Politics Indicators.

```{r ptictab}
# Produce a table showing means by country for select practice indicators
politics_indicators <- c(
'SE.PRM.BQBR',
'SE.PRM.BIMP',
'SE.PRM.BMAC',
'SE.PRM.BNLG',
'SE.PRM.BFIN'

)

country_tab_fn(politics_indicators, 'GEPD Politics Indicators')

```

## Systems View of Indicators

```{r}
# read in the microdata

########
## Peru
########

#read in anonymized school data
country <- "PER"
year <- "2019"

confidential_folder <- file.path(paste(confidential_dir,"CNT",country,paste(country,year,"GEPD", sep="_"),paste(country,year,"GEPD_v01_RAW", sep="_"),"Data/confidential/", sep="/"))

PER_school_anon_df <- read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/school_dta_short_anon.csv", sep="/"))

PER_school_office_linkages <- read_csv(file=paste0(confidential_folder, "/School/linked_po_school_data_",country,".csv"))

#load gdp info
PER_school_gdp <-read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/school_gdp_anon.csv", sep="/"))

PER_school_office_link_df <- PER_school_anon_df %>%
  left_join(PER_school_gdp) %>%
  left_join(PER_school_office_linkages)%>% mutate(country = "PER")

########
## Jordan
########

#read in anonymized school data
country <- "JOR"
year <- "2019"

confidential_folder <- file.path(paste(confidential_dir,"CNT",country,paste(country,year,"GEPD", sep="_"),paste(country,year,"GEPD_v01_RAW", sep="_"),"Data/confidential/", sep="/"))

JOR_school_anon_df <- haven::read_dta(file=paste(anonymized_dir,"CNT", 'JOR-19',paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/school_dta_short_anon.dta", sep="/"))

JOR_school_office_linkages <- read_csv(file=paste0(confidential_folder, "/School/linked_po_school_data_",country,".csv"))

#load gdp info
JOR_school_gdp <-haven::read_dta(file=paste(anonymized_dir,"CNT", 'JOR-19',paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/school_gdp_anon.dta", sep="/")) %>%
  select(hashed_school_code, GDP)


JOR_school_office_link_df <- JOR_school_anon_df %>%
  left_join(JOR_school_gdp) %>%
  left_join(JOR_school_office_linkages)%>% mutate(country = "JOR")

########
## Rwanda
########

#read in anonymized school data
country <- "RWA"
year <- "2020"

confidential_folder <- file.path(paste(confidential_dir,"CNT",country,paste(country,year,"GEPD", sep="_"),paste(country,year,"GEPD_v01_RAW", sep="_"),"Data/confidential/", sep="/"))

RWA_school_anon_df <- read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/school_dta_short_anon.csv", sep="/"))

RWA_school_office_linkages <- read_csv(file=paste0(confidential_folder, "/School/linked_po_school_data_",country,".csv"))

#load gdp info
RWA_school_gdp <-read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/school_gdp_anon.csv", sep="/"))



RWA_school_office_link_df <- RWA_school_anon_df %>%
  left_join(RWA_school_gdp) %>%
  left_join(RWA_school_office_linkages)%>% mutate(country = "RWA")
########

########
## Ethiopia
########

#read in anonymized school data
country <- "ETH"
year <- "2020_2021"

confidential_folder <- file.path(paste(confidential_dir,"CNT",country,paste(country,year,"GEPD", sep="_"),paste(country,year,"GEPD_v01_RAW", sep="_"),"Data/confidential/", sep="/"))

ETH_school_anon_df <- read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/school_dta_short_anon.csv", sep="/"))

ETH_school_office_linkages <- read_csv(file=paste0(confidential_folder, "/School/linked_po_school_data_",country,".csv"))

#load gdp info
ETH_school_gdp <-read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/school_gdp_anon.csv", sep="/"))



ETH_school_office_link_df <- ETH_school_anon_df %>%
  left_join(ETH_school_gdp) %>%
  left_join(ETH_school_office_linkages)%>% mutate(country = "ETH")
########

########
## Madagascar
########

#read in anonymized school data
country <- "MDG"
year <- "2021"

confidential_folder <- file.path(paste(confidential_dir,"CNT",country,paste(country,year,"GEPD", sep="_"),paste(country,year,"GEPD_v01_RAW", sep="_"),"Data/confidential/", sep="/"))

MDG_school_anon_df <- read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/school_dta_short_anon.csv", sep="/"))

# MDG_school_office_linkages <- read_csv(file=paste0(confidential_folder, "/School/linked_po_school_data_",country,".csv"))

#load gdp info
MDG_school_gdp <-read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/school_gdp_anon.csv", sep="/")) 



MDG_school_office_link_df <- MDG_school_anon_df %>%
  left_join(MDG_school_gdp) %>%
  select(-district)%>% mutate(country = "MDG")
# %>%
#   left_join(MDG_school_office_linkages)


###########
# Combined
##########

combined_school_office_df <- bind_rows(PER_school_office_link_df, JOR_school_office_link_df, RWA_school_office_link_df, ETH_school_office_link_df, MDG_school_office_link_df) %>%
    mutate(dist=distHaversine(.[,c('school_lon', 'school_lat')], .[c('office_lon', 'office_lat')]),
         dist_km=dist/1000,
         dist_log=log(dist_km),
         bureau_index=(quality_bureaucracy + national_learning_goals + impartial_decision_making + mandates_accountability )/4,
         rural2=if_else(urban_rural=="Rural",1,0),
         rural=if_else(is.na(rural),rural2,rural )) 
```


## Share of learning variation explained by the Dashboard’s Practice indicators

## Relationship between School Practices and 4th Grade Learning Outcomes

Next the relationships between 4th grade learning outcomes and practices in the school are shown. The practices considered are teacher presence, teacher content knowledge, teacher pedagogical skills, availability of basic inputs, basic infrastructure, student readiness (1st grade assessment scores), operational management scores, instructional leadership, principal school knowledge, and principal management skills.  Relationships are estimated using OLS regression.  The urban/rural status of the school and the log GDP within 1km of the school are included in the regressions.^[
Data downloaded from:
https://datacatalog.worldbank.org/dataset/gross-domestic-product-2010 also see
https://preview.grid.unep.ch/index.php?preview=data&events=socec&evcat=1&lang=eng
 In the distributed global GDP dataset sub-national GRP and national GDP data are allocated to 
 30 arc second (approximately 1km) grid cells in proportion to the population residing in that cell. 
 The method also distinguishes between rural and urban population, assuming the latter to have a higher 
 GDP per capita. Input data are from 1) a global time-series dataset of GDP, with subnational gross regional 
 product (GRP) for 74 countries, compiled by the World Bank Development Economics Research Group (DECRG). 2) 
 Gridded population projections for the year 2009, based on a population grid for the year 2005 provided by 
 LandScanTM Global Population Database (Oak Ridge, TN: Oak Ridge National Laboratory). This dataset has been 
 extrapolated to year 2010 by UNEP/GRID-Geneva. Unit is estimated value of production per cell, in thousand of 
 constant 2000 USD. Cell level anomalies may occur due to poor alignment of multiple input data sources, and it 
 is strongly recommended that users attempt to verify information, or consult original sources, in order to determine 
 suitability for a particular application. This product was compiled by DECRG for the Global Assessment Report on Risk 
 Reduction (GAR). It was modeled using global data. Credit: GIS processing World Bank DECRG, Washington, DC, 
 extrapolation UNEP/GRID-Geneva.].  Additionally, a dummy variable for each country is included in the regression to adjust for between country differences in variables.

```{r}
models <- list(
  
'4th Grade Student Knowledge' = feols(student_knowledge ~ 0 + presence_rate + content_knowledge + teach_score + inputs + infrastructure + ecd_student_knowledge + operational_management + instructional_leadership + principal_knowledge_score + principal_management  + log(GDP) + rural + i(ADM0_NAME), data=combined_school_office_df, se='hetero'),

'4th Grade Reading Score' = feols(literacy_student_knowledge ~ 0 + presence_rate + content_knowledge + teach_score + inputs + infrastructure + ecd_student_knowledge + operational_management + instructional_leadership + principal_knowledge_score + principal_management + log(GDP) + rural + i(ADM0_NAME), data=combined_school_office_df, se='hetero'),

'4th Grade Math Score' = feols(math_student_knowledge ~ 0 + presence_rate + content_knowledge + teach_score + inputs + infrastructure + ecd_student_knowledge + operational_management + instructional_leadership + principal_knowledge_score + principal_management + log(GDP) + rural + i(ADM0_NAME), data=combined_school_office_df, se='hetero')
)



modelsummary(models,
             estimate= "{estimate}{stars}",
             coef_rename = c("presence_rate"  = "Teacher Presence",
                             "content_knowledge" = "Teacher Content Knowledge",
                             "teach_score" = "Teacher Pedagogy",
                             "inputs" = "Basic Inputs",
                             "infrastructure" = "Basic Infrastructure",
                             "ecd_student_knowledge" = "1st Grade Student Knoweldge",
                             "operational_management" = "Operational Management",
                             "instructional_leadership" = "Instructional Leadership",
                             "principal_knowledge_score" = "Principal Knowledge",
                             "principal_management" = "Principal Management")
             )
```


## Relationship between School Practice Outcomes and Bureaucracy Indicators

The plots below show that the (geodesic) distance between a school and the district office managing the school.

In the first plot, the relationship between distance of the office and average 4th grade student knowledge, according to the 4th grade GEPD assessment, are shown.


```{r distscat, echo=FALSE}

#scatterplot of distance between school and office
school_office_dist_df <- combined_school_office_df %>%
  select(student_knowledge, inputs, infrastructure, principal_management, quality_bureaucracy, bureau_index, dist, dist_km, dist_log, ADM0_NAME) %>%
  mutate(bi_on_target=if_else(bureau_index>=4, "Yes", "No")) %>%
  group_by(ADM0_NAME) %>% #demean outcomes by country
  mutate(student_knowledge_dm=student_knowledge-mean(student_knowledge, na.rm=T),
         dist_log_dm=dist_log-mean(dist_log, na.rm=T),
         inputs_dm=inputs-mean(inputs, na.rm=T),
         infrastructure_dm=infrastructure-mean(infrastructure, na.rm=T))


lab <- eq_plot_txt('student_knowledge', 'dist_log', school_office_dist_df)

p1 <- ggplot(data=school_office_dist_df, aes(x=dist_km, y=student_knowledge)) +
  geom_point() + 
  geom_smooth(method='lm') +
  theme_bw() +
  scale_x_log10(labels=scales::comma) +
  expand_limits(y=c(0,100)) +
  xlab('Log Distance between School and District Office (km)') +
  ylab('Average 4th Grade Student Knowledge Scores at School') +
  geom_richtext(
    aes(x = 20, y = 5,label = lab, hjust=0.2)
  ) +
  ggtitle(str_wrap('Unadjusted ', 100))





school_office_dist_df_on <- school_office_dist_df %>%
  filter(bi_on_target=="Yes")

school_office_dist_df_off <- school_office_dist_df %>%
  filter(bi_on_target=='No')

lab1 <- eq_plot_txt('student_knowledge', 'dist_log', school_office_dist_df_on)
lab2 <- eq_plot_txt('student_knowledge', 'dist_log', school_office_dist_df_off)

  col_pal <- c("#457b9d","#e63946")  
  names(col_pal) <- c( "Yes","No")
  
  
# p2 <- ggplot(data=school_office_dist_df, aes(x=dist_km, y=student_knowledge, color=bi_on_target)) +
#   geom_point() +
#   geom_smooth(method='lm') +
#   theme_bw() +
#   scale_x_log10(labels=scales::comma) +
#   expand_limits(y=c(0,100)) +
#   xlab('Log Distance between School and District Office (km)') +
#   ylab('Average 4th Grade Student Knowledge Scores at School') +
#   scale_color_manual(
#     name="Quality of Bureaucracy Score",
#     labels=c("No"="Caution/Needs Improvement","Yes"="On Target"),
#     values=col_pal,
#     na.translate = F
#   ) +
#   geom_richtext(
#    aes(x = 0.1, y = 5,label = lab2, hjust=0.2), color='#e63946'
#   ) +
#   geom_richtext(
#    aes(x = 10, y = 5,label = lab1, hjust=0.2), color='#457b9d'
#   ) +
#   theme(
#     legend.position = 'bottom'
#   )
# 
# 
# 
# p2

lab2 <- eq_plot_txt('student_knowledge_dm', 'dist_log_dm', school_office_dist_df)

p3 <- ggplot(data=school_office_dist_df, aes(x=dist_log_dm, y=student_knowledge_dm)) +
  geom_point() + 
  geom_smooth(method='lm') +
  theme_bw() +
  expand_limits(y=c(0,100)) +
  xlab('Log Distance between School and District Office (km)') +
  ylab('Average 4th Grade Student Knowledge Scores at School') +
  scale_color_manual(
    name="Bureaucracy Index",
    labels=c("No"="Caution/Needs Improvement","Yes"="On Target"),
    values=col_pal,
    na.translate = F
  )+
  geom_richtext(
   aes(x = 0.1, y = 5,label = lab2, hjust=0.2)
  ) +
  # geom_richtext(
  #  aes(x = 10, y = 5,label = lab1, hjust=0.2), color='#457b9d'
  # ) +
  theme(
    legend.position = 'bottom'
  ) +
  ggtitle(str_wrap(' Demeaned by Country ', 100))


p1 + p3 +
  plot_annotation(title='Scatterplot of Average 4th Grade Student Knowledge Against Distance of School to District Office',
                  caption='Distance is the geodesic distance between the school and office.')


```

In the second plot, the relationship between the distance to the office and school input availability is shown.  This indicator measures the availability of basic inputs in the average school. These inputs, based on the literature and general expectations, are (i) functioning blackboard and chalk, (ii) pens, pencils, and exercise books in 4th-grade classrooms, (iii) textbooks, (iv) basic classroom furniture, and (v) access to ICT.


```{r inputscat}
lab <- eq_plot_txt('inputs', 'dist_log', school_office_dist_df)

p1 <- ggplot(data=school_office_dist_df, aes(x=dist_km, y=inputs)) +
  geom_point() + 
  geom_smooth(method='lm') +
  theme_bw() +
  scale_x_log10(labels=scales::comma) +
  expand_limits(y=c(0,5)) +
  xlab('Log Distance between School and District Office (km)') +
  ylab('School Input Availability at School') +
  geom_richtext(
    aes(x = 10, y = 1,label = lab, hjust=0.2)
  ) +
  ggtitle(str_wrap('Unadjusted ', 100))






  
  
# p2 <- ggplot(data=school_office_dist_df, aes(x=dist_km, y=inputs, color=bi_on_target)) +
#   geom_point() +
#   geom_smooth(method='lm') +
#   theme_bw() +
#   scale_x_log10(labels=scales::comma) +
#   expand_limits(y=c(0,100)) +
#   xlab('Log Distance between School and District Office (km)') +
#   ylab('Average 4th Grade Student Knowledge Scores at School') +
#   scale_color_manual(
#     name="Quality of Bureaucracy Score",
#     labels=c("No"="Caution/Needs Improvement","Yes"="On Target"),
#     values=col_pal,
#     na.translate = F
#   ) +
#   geom_richtext(
#    aes(x = 0.1, y = 5,label = lab2, hjust=0.2), color='#e63946'
#   ) +
#   geom_richtext(
#    aes(x = 10, y = 5,label = lab1, hjust=0.2), color='#457b9d'
#   ) +
#   theme(
#     legend.position = 'bottom'
#   )
# 
# 
# 
# p2

lab2 <- eq_plot_txt('inputs_dm', 'dist_log_dm', school_office_dist_df)

p3 <- ggplot(data=school_office_dist_df, aes(x=dist_log_dm, y=inputs_dm)) +
  geom_point() + 
  geom_smooth(method='lm') +
  theme_bw() +
  expand_limits(y=c(5)) +
  xlab('Log Distance between School and District Office (km)') +
  ylab('School Input Availability at School') +

  geom_richtext(
   aes(x = -0.1, y = 1,label = lab2, hjust=0.2)
  ) +
  # geom_richtext(
  #  aes(x = 10, y = 5,label = lab1, hjust=0.2), color='#457b9d'
  # ) +
  theme(
    legend.position = 'bottom'
  ) +
  ggtitle(str_wrap(' Demeaned by Country ', 100))


p1 + p3 +
  plot_annotation(title='Scatterplot of Availability of School Inputs Against Distance of School to District Office',
                  caption='Distance is the geodesic distance between the school and office.')


```


In the third plot, the relationship between the distance to the office and school infrastructure availability is shown.  This indicator measures the availability of basic inputs in the average school. The infrastructure aspects included, based on the literature and general expectations, are availability of (i) drinking water, (ii) functioning toilets, (iii) electricity, (iv) internet connectivity, and (v) accessibility for people with disabilities.


```{r infrascat}
lab <- eq_plot_txt('infrastructure', 'dist_log', school_office_dist_df)

p1 <- ggplot(data=school_office_dist_df, aes(x=dist_km, y=infrastructure)) +
  geom_point() + 
  geom_smooth(method='lm') +
  theme_bw() +
  scale_x_log10(labels=scales::comma) +
  expand_limits(y=c(0,5)) +
  xlab('Log Distance between School and District Office (km)') +
  ylab('School Infrastructure Availability at School') +
  geom_richtext(
    aes(x = 10, y = 1,label = lab, hjust=0.2)
  ) +
  ggtitle(str_wrap('Unadjusted ', 100))






  
  
# p2 <- ggplot(data=school_office_dist_df, aes(x=dist_km, y=inputs, color=bi_on_target)) +
#   geom_point() +
#   geom_smooth(method='lm') +
#   theme_bw() +
#   scale_x_log10(labels=scales::comma) +
#   expand_limits(y=c(0,100)) +
#   xlab('Log Distance between School and District Office (km)') +
#   ylab('Average 4th Grade Student Knowledge Scores at School') +
#   scale_color_manual(
#     name="Quality of Bureaucracy Score",
#     labels=c("No"="Caution/Needs Improvement","Yes"="On Target"),
#     values=col_pal,
#     na.translate = F
#   ) +
#   geom_richtext(
#    aes(x = 0.1, y = 5,label = lab2, hjust=0.2), color='#e63946'
#   ) +
#   geom_richtext(
#    aes(x = 10, y = 5,label = lab1, hjust=0.2), color='#457b9d'
#   ) +
#   theme(
#     legend.position = 'bottom'
#   )
# 
# 
# 
# p2

lab2 <- eq_plot_txt('infrastructure_dm', 'dist_log_dm', school_office_dist_df)

p3 <- ggplot(data=school_office_dist_df, aes(x=dist_log_dm, y=infrastructure_dm)) +
  geom_point() + 
  geom_smooth(method='lm') +
  theme_bw() +
  expand_limits(y=c(5)) +
  xlab('Log Distance between School and District Office (km)') +
  ylab('School Infrastructure Availability at School') +

  geom_richtext(
   aes(x = -0.1, y = 1,label = lab2, hjust=0.2)
  ) +
  # geom_richtext(
  #  aes(x = 10, y = 5,label = lab1, hjust=0.2), color='#457b9d'
  # ) +
  theme(
    legend.position = 'bottom'
  ) +
  ggtitle(str_wrap(' Demeaned by Country ', 100))


p1 + p3 +
  plot_annotation(title='Scatterplot of Availability of School Infrastructure Against Distance of School to District Office',
                  caption='Distance is the geodesic distance between the school and office.')


```


Next the relationships between an overall index of the functioning of the bureaucracy in the school district and school level outcomes are shown.  The index is formed by taking the unweighted average of the quality of bureaucracy score, the mandates and accountability score, the national learning goals score, and the impartial decision making score.  Relationships are estimated using OLS regression.  The urban/rural status of the school and the log GDP within 1km of the school are included in the regressions.^[
Data downloaded from:
https://datacatalog.worldbank.org/dataset/gross-domestic-product-2010 also see
https://preview.grid.unep.ch/index.php?preview=data&events=socec&evcat=1&lang=eng
 In the distributed global GDP dataset sub-national GRP and national GDP data are allocated to 
 30 arc second (approximately 1km) grid cells in proportion to the population residing in that cell. 
 The method also distinguishes between rural and urban population, assuming the latter to have a higher 
 GDP per capita. Input data are from 1) a global time-series dataset of GDP, with subnational gross regional 
 product (GRP) for 74 countries, compiled by the World Bank Development Economics Research Group (DECRG). 2) 
 Gridded population projections for the year 2009, based on a population grid for the year 2005 provided by 
 LandScanTM Global Population Database (Oak Ridge, TN: Oak Ridge National Laboratory). This dataset has been 
 extrapolated to year 2010 by UNEP/GRID-Geneva. Unit is estimated value of production per cell, in thousand of 
 constant 2000 USD. Cell level anomalies may occur due to poor alignment of multiple input data sources, and it 
 is strongly recommended that users attempt to verify information, or consult original sources, in order to determine 
 suitability for a particular application. This product was compiled by DECRG for the Global Assessment Report on Risk 
 Reduction (GAR). It was modeled using global data. Credit: GIS processing World Bank DECRG, Washington, DC, 
 extrapolation UNEP/GRID-Geneva.].  Additionally, a dummy variable for each country is included in the regression to adjust for between country differences in variables.
 
 
```{r breg}

models <- list(
  
'4th Grade Student Knowledge' = feols(student_knowledge ~ 0 + bureau_index + log(GDP) + rural + i(ADM0_NAME), data=combined_school_office_df, se='hetero'),

'Teacher Presence' =  feols(presence_rate ~ 0 +  bureau_index  + log(GDP) + rural + i(ADM0_NAME), data=combined_school_office_df, se='hetero'),

'Teacher Pedagogy' =  feols(teach_score ~ 0 +  bureau_index + log(GDP) + rural + i(ADM0_NAME), data=combined_school_office_df, se='hetero'),

'School Inputs' =  feols(inputs ~ 0 +  bureau_index + log(GDP) + rural + i(ADM0_NAME), data=combined_school_office_df, se='hetero'),

'School Infrastructure' =  feols(infrastructure ~ 0 +  bureau_index + log(GDP) + rural + i(ADM0_NAME), data=combined_school_office_df, se='hetero'),

'Operations Management' =  feols(operational_management ~ 0 +  bureau_index  + log(GDP) + rural + i(ADM0_NAME), data=combined_school_office_df, se='hetero'),

'Principal Management Skills' =  feols(principal_management ~ 0 +  bureau_index  + log(GDP) + rural  + i(ADM0_NAME), data=combined_school_office_df, se='hetero')

)



modelsummary(models,
             estimate= "{estimate}{stars}",
             coef_rename = c("bureau_index" = "Bureuacracy Index")
             )

```

The next table breakds out the effects into the underlying components of the bureaucracy index.

```{r breg2, echo=FALSE}

models <- list(
  
'Student Knowledge' = feols(student_knowledge ~ quality_bureaucracy + national_learning_goals + impartial_decision_making + mandates_accountability  + log(GDP) + rural| ADM0_NAME, data=combined_school_office_df, se='hetero'),

'Teacher Presence' =  feols(presence_rate ~ quality_bureaucracy + national_learning_goals + impartial_decision_making + mandates_accountability  + log(GDP) + rural| ADM0_NAME, data=combined_school_office_df, se='hetero'),

'Teacher Pedagogy' =  feols(teach_score ~ quality_bureaucracy + national_learning_goals + impartial_decision_making + mandates_accountability  + log(GDP) + rural| ADM0_NAME, data=combined_school_office_df, se='hetero'),

'School Inputs' =  feols(inputs ~ quality_bureaucracy + national_learning_goals + impartial_decision_making + mandates_accountability  + log(GDP) + rural| ADM0_NAME, data=combined_school_office_df, se='hetero'),

'School Infrastructure' =  feols(infrastructure ~ quality_bureaucracy + national_learning_goals + impartial_decision_making + mandates_accountability  + log(GDP) + rural| ADM0_NAME, data=combined_school_office_df, se='hetero'),

'Operations Management' =  feols(operational_management ~ quality_bureaucracy + national_learning_goals + impartial_decision_making + mandates_accountability  + log(GDP) + rural| ADM0_NAME, data=combined_school_office_df, se='hetero'),

'Principal Management Skills' =  feols(principal_management ~ quality_bureaucracy + national_learning_goals + impartial_decision_making + mandates_accountability  + log(GDP) + rural| ADM0_NAME, data=combined_school_office_df, se='hetero')

)



modelsummary(models,
             estimate= "{estimate}{stars}"
             )

```



[Discussion of the linkages between indicators.  E.g. How the teacher pedagogy relates to student outcomes.  Interesting findings on De-Facto versus De-Jure.  Findings on implementation differences across geographies within a country.  Findings on Bureaucracy and school outcomes.  Can maybe highlight link with poor bureaucracy with poor inputs/infrastructure.]

```{r}

  ## Relating the policy indicators to practices : TEACHING

models <- list(
  
'Student Knowledge' = feols(student_knowledge ~ teacher_attraction  + teacher_satisfied_job + teacher_selection_deployment + teacher_support + teacher_bonus + teacher_monitoring  + log(GDP) + rural| ADM0_NAME, data=combined_school_office_df, se='hetero'),

'Teacher Presence' =  feols(presence_rate ~ teacher_attraction  + teacher_satisfied_job + teacher_selection_deployment + teacher_support + teacher_bonus + teacher_monitoring  + log(GDP) + rural| ADM0_NAME, data=combined_school_office_df, se='hetero'),

'Teacher Pedagogy' =  feols(teach_score ~ teacher_attraction  + teacher_satisfied_job + teacher_selection_deployment + teacher_support + teacher_bonus + teacher_monitoring   + log(GDP) + rural| ADM0_NAME, data=combined_school_office_df, se='hetero'),

'Content Knowledge' =  feols(content_knowledge ~ teacher_attraction  + teacher_satisfied_job + teacher_selection_deployment + teacher_support + teacher_bonus + teacher_monitoring   + log(GDP) + rural| ADM0_NAME, data=combined_school_office_df, se='hetero')

)



modelsummary(models,
             estimate= "{estimate}{stars}"
             )

```
```{r}
  ## Relating the policy indicators to practices : SCHOOL MANAGEMENT

models <- list(
  
'Student Knowledge' =  feols(student_knowledge ~ sch_management_clarity  + sch_selection_deployment + sch_management_attraction + sch_monitoring + sch_support + log(GDP) + rural| ADM0_NAME, data=combined_school_office_df, se='hetero'),
  
'Operational Management' = feols(operational_management ~ sch_management_clarity  + sch_selection_deployment + sch_management_attraction + sch_monitoring + sch_support  + log(GDP) + rural| ADM0_NAME, data=combined_school_office_df, se='hetero'),

'Instructional Leadership' =  feols(instructional_leadership ~ sch_management_clarity  + sch_selection_deployment + sch_management_attraction + sch_monitoring + sch_support   + log(GDP) + rural| ADM0_NAME, data=combined_school_office_df, se='hetero'),

'School Knowledge' =  feols(principal_knowledge_score ~ sch_management_clarity  + sch_selection_deployment + sch_management_attraction + sch_monitoring + sch_support + log(GDP) + rural| ADM0_NAME, data=combined_school_office_df, se='hetero')

)



modelsummary(models,
             estimate= "{estimate}{stars}"
             )


```

```{r}
  ## Relating the policy indicators to practices : INFRASTRUCTURE

models <- list(
  
'Basic Infrastructure' =  feols(infrastructure ~ standards_monitoring  + monitoring_infrastructure + monitoring_inputs + log(GDP) + rural| ADM0_NAME, data=combined_school_office_df, se='hetero'),
  
'Basic Input' = feols(inputs ~ standards_monitoring  + monitoring_infrastructure + monitoring_inputs + log(GDP) + rural| ADM0_NAME, data=combined_school_office_df, se='hetero'),

'Student Knowledge' =  feols(student_knowledge ~ standards_monitoring  + monitoring_infrastructure + monitoring_inputs + log(GDP) + rural| ADM0_NAME, data=combined_school_office_df, se='hetero'),

'School Knowledge' =  feols(principal_knowledge_score ~ standards_monitoring  + monitoring_infrastructure + monitoring_inputs + log(GDP) + rural| ADM0_NAME, data=combined_school_office_df, se='hetero')

)



modelsummary(models,
             estimate= "{estimate}{stars}"
             )

```


```{r}
###breaking up the indicators into the underlying questions 

   #create subset with just main indicators



  ## calling in the global matrix

  matrix <- read_xlsx(paste(dir,'Indicators/GEPD_master.xlsx', sep = "/"), sheet = 2) %>% 
  fill(c(Indicator, `Variable name`, `Sub-indicators\r\nMain indicator (in red)`), .direction=c("down")) %>% 
  rename(subindicator=`Sub-indicators\r\nMain indicator (in red)`)

breaking_up_fun <- function(variables, reference_data){
    
  names.use <- names(combined_school_office_df)[(names(combined_school_office_df) %in% variables)]
 
  teaching_country_combined <- combined_school_office_df %>% 
  
    select(country, names.use) %>% 
      
    group_by(country) %>% 
    
    summarise_at(names.use, ~ mean(., na.rm = T)) %>% 
      
    pivot_longer(cols = names.use ,names_to = "subindicator", values_to = "value") %>% 
      
    left_join(reference_data) %>% 
    
    distinct(country, subindicator, value, .keep_all=T) %>% 
    
    ## Insert percentage whenever question beget a yes/no answers
    
    mutate(subindicator = if_else(str_detect(`Question options`, "Yes"), paste(subindicator, "percent", sep = "_"), subindicator )) %>% 
    
    mutate(value = if_else(str_detect(subindicator, "percent"), value *100, value )) %>% 

    
    ## Add colours and comments
    
    mutate(
      
      value_metadata=case_when(
        
        value <85 & str_detect(subindicator, "_percent") ~ "Needs Improvement",
        value >=85 & value<90 & str_detect(subindicator, "_percent") ~ "Caution",
        value >=90 & str_detect(subindicator, "_percent")~ "On Target",
        TRUE ~ "N/A"
      )) %>% 
    
    mutate(
           value=round(value,1),
           
           value_color=case_when(
             value_metadata=="Needs Improvement" ~ "#FF0000",
             value_metadata=="Caution" ~ "#FCD606",
             value_metadata=="On Target" ~ "#85C546",
             TRUE ~ "#808080"
           ),
           
           country = case_when(
            country == "ETH" ~ "Ethiopia",
            country == "JOR" ~ "Jordan",
            country == "MDG" ~ "Madagascar",
            country == "RWA" ~ "Rwanda",
            country == "PER" ~ "Peru"

    ))
  
    
  } 
    
    


  ## TEACHING

    series_teaching<- c(
      'SE.PRM.TATT',
      'SE.PRM.TSDP',
      'SE.PRM.TSUP',
      'SE.PRM.TEVL',
      'SE.PRM.TMNA',
      'SE.PRM.TINM')
 
  variable_teaching<-c(
    "teacher_attraction",
    "teacher_selection_deployment",
    "teacher_support",
    "teaching_evaluation",
    "teacher_monitoring",
    "intrinsic_motivation")

  ## Create referential dataframe
  teaching_var<-data.frame(Series=as.character(series_teaching),
                      variables=as.character(variable_teaching)) %>% 
    left_join(matrix, by = c("variables" = "Variable name"))
  
  sub_ind_teaching <- teaching_var %>% select(subindicator) %>% distinct() %>%  pull()
  
  teaching_country_combined <- breaking_up_fun(sub_ind_teaching, teaching_var) %>% 
    filter(!is.na(`Full question for a variable`))
  
  
country_tab_fn(policy_indicators, 'GEPD Policy Indicators')





  ## SCHOOL MANAGEMENT



  ## INFRASTRUCTUREs




```











```{r}

# read in the data for Policy surveys

  # policy_levers <- indicator_names_df %>% 
  # filter(str_detect(`Indicator Name`, "Policy Lever")) %>% 
  # left_join(combined_df)
  # 


########
## Peru
########

#read in anonymized school data
country <- "PER"
year <- "2019"

confidential_folder <- file.path(paste(confidential_dir,"CNT",country,paste(country,year,"GEPD", sep="_"),paste(country,year,"GEPD_v01_RAW", sep="_"),"Data/confidential/", sep="/"))

PER_policy_df <- haven::read_dta(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/Expert_Survey/expert_dta_final.dta", sep="/"))%>% mutate(country = "PER") 

PER_policy_df <- PER_policy_df %>% 
  setNames(gsub("school", "sch", names(.)))




########
## Jordan
########

#read in anonymized school data
country <- "JOR"
year <- "2019"

confidential_folder <- file.path(paste(confidential_dir,"CNT", paste(country, "-2019"),paste(country,year,"GEPD", sep="_"),paste(country,year,"GEPD_v01_RAW", sep="_"),"Data/confidential/", sep="/"))

JOR_policy_df <- haven::read_dta(file=paste(anonymized_dir,"CNT", 'JOR-19',paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/Expert_Survey/expert_dta_final.dta", sep="/"))%>% mutate(country = "JOR") 



########
## Rwanda
########

#read in anonymized school data
country <- "RWA"
year <- "2020"

confidential_folder <- file.path(paste(confidential_dir,"CNT",country,paste(country,year,"GEPD", sep="_"),paste(country,year,"GEPD_v01_RAW", sep="_"),"Data/confidential/", sep="/"))

RWA_policy_df <- haven::read_dta(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/Expert_Survey/expert_dta_final.dta", sep="/"))%>% mutate(country = "RWA") 


########

########
## Ethiopia
########

#read in anonymized school data
country <- "ETH"
year <- "2020_2021"

confidential_folder <- file.path(paste(confidential_dir,"CNT",country,paste(country,year,"GEPD", sep="_"),paste(country,year,"GEPD_v01_RAW", sep="_"),"Data/confidential/", sep="/"))

ETH_policy_df <- haven::read_dta(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/Policy_Survey/expert_dta_final.dta", sep="/"))%>% mutate(country = "ETH")


########

########
## Madagascar
########

#read in anonymized school data
country <- "MDG"
year <- "2021"

confidential_folder <- file.path(paste(confidential_dir,"CNT",country,paste(country,year,"GEPD", sep="_"),paste(country,year,"GEPD_v01_RAW", sep="_"),"Data/confidential/", sep="/"))

MDG_policy_df <- haven::read_dta(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/Policy_Survey/expert_dta_final.dta", sep="/")) %>% mutate(country = "MDG")


#######
# Get the main indicators
#######
#get list of de facto indicators
main_indicator_labels<-c( 
                        'Teaching - Attraction',
                         'Teaching - Selection & Deployment',
                         'Teaching - Support', 
                         'Teaching - Evaluation', 
                         'Teaching - Monitoring & Accountability', 
                         'Teaching - Intrinsic Motivation', 
                          'Inputs & Infrastructure - Monitoring',
                         'School Management - Attraction' ,                   
                         'School Management - Selection & Deployment'  ,      
                         'School Management - Support' ,                      
                         'School Management - Evaluation'

    )  
    
    indicators_list<-c(
                       'teacher_attraction', 
                       'teacher_selection_deployment', 
                       'teacher_support', 
                       'teaching_evaluation', 
                       'teacher_monitoring',
                        'intrinsic_motivation', 
                        'sch_monitoring', 
                       'sch_management_attraction', 
                       'sch_selection_deployment', 
                       'sch_support', 
                       'principal_evaluation'

    )


  labels_df_policy<-data.frame(indicators=as.character(indicators_list),
                          indicator_labels=as.character(main_indicator_labels)) 
    


###########
# Combined
##########
    
    #get de facto data
      
    de_facto_function <- function(df, Country_acronyme){
      
    ipw<-df %>% pull(ipw)
  
    df_defacto <- df %>%
      select(hashed_school_code, indicators_list, ipw) %>%
      summarise_at(.vars = indicators_list, wtd.mean, w=ipw, na.rm=TRUE) %>%
      mutate(group="De Facto",
             country = !!Country_acronyme) %>%
      select(group=group, everything())
      
      assign(paste0("data_de_facto_", quo_name(enquo(Country_acronyme))), df_defacto, envir = .GlobalEnv)
      
      
    data_policy_2 <- df_defacto %>%
      mutate_at(.vars=indicators_list, ~as.numeric(sample_n(as_tibble(c(1:5)),1)[1,1])) %>%
      mutate(group="De Jure") %>%
      select(group=group, everything())
    
    
      assign(paste0("data_de_jure_", quo_name(enquo(Country_acronyme))), data_policy_2, envir = .GlobalEnv)

      
    }  
      
    
    for (i in countries) {
      
      df_name <- paste(i,"school_anon_df", sep = "_")
      de_facto_function(get(df_name), i)
      
    }
      
  ##Combined
  names <- lapply(ls(pattern = "^data_de_"), function(x) get(x))
  data_policy_combined <- do.call(rbind, names)
 
  
  data_policy_combined <- data_policy_combined %>% 
    pivot_longer(cols = c(2:12), names_to= "indicators", values_to = "value") %>% 
    left_join(labels_df_policy)
  


```

```{r}
  ### Here our intentions are twofolds. First, we will regress the de jure indicators on 4th grade students assessment before doing the same for de facto indicators. It should enable us to compare how effective one set of indicators is at explaining the between countries variations. Second, we will regress on the difference between de facto and de jure.
  
combined_assessment <- combined_wide_df %>% 
  filter(Series=="SE.PRM.LERN") %>% 
  pivot_longer(cols = c(2:6), names_to = "country", values_to= "value") %>% 
  mutate(country = case_when(
    
    country == "Madagascar" ~ "MDG",
    country == "Peru" ~ "PER",
    country == "Ethiopia" ~ "ETH",
    country == "Rwanda" ~ "RWA",
    country == "Jordan" ~ "JOR"

    
  )) %>% 
  rename(
    
    indicators_labels= `Indicator Name`,
    indicator = Series
    
  ) %>%   pivot_wider(id_cols = country,
                    names_from = indicators_labels,
                    values_from = value)


## Wide format and regress covariate on respective 4th grade assessment
var1 <- 'indicators'
var2 <- 'group'


data_policy_combined_wide <- data_policy_combined %>% 
  
  mutate(group = case_when(
    
    group == "De Facto" ~ "De_Facto",
    group == "De Jure" ~ "De_Jure"

    
  )) %>% 

   pivot_wider(
    id_cols =  country,
    names_from = c(var1, var2),
    names_glue = sprintf('{%s}_{%s}', var2, var1),
    values_from = value) %>% 
  
  left_join(combined_assessment) %>% 
  rename(student_knowledge = `Proficiency on GEPD Assessment`)


## Regression ----
  
  
  library(stargazer)
  library(sandwich)

  covariates <- data_policy_combined_wide %>% select(starts_with("De_Facto")) %>% names()
  
  
  my_formula <- as.formula(paste('student_knowledge ~ ', paste(covariates, collapse=" + ")," + factor(country)", sep=""))
  multi_reg_school<-lm(my_formula, data_policy_combined_wide)
  
  # Adjust standard errors
  cov1_multi         <- vcovHC(multi_reg_school, type = "HC1")
  robust_multi_se    <- sqrt(diag(cov1_multi))
  

  multi_table<- summary(multi_reg_school)
  multi_table
  
```

# Conclusions

# References
