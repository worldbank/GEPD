---
title: 'Measuring the Drivers of the Learning Crisis Across Countries using the Global Education Policy Dashboard'
author: "GEPD Team"
date: "`r Sys.Date()`"
output:
  bookdown::word_document2: 
    toc: yes
    fig_width: 9
    fig_height: 6
abstract: "To help countries put an end to Learning Poverty, the World Bank's Education Global Practice has developed and is supporting countries in the deployment of the Global Education Policy Dashboard (GEPD). This new tool offers a strong basis for identifying priorities for investment and policy reforms that are suited to each country context. It does so by (1) highlighting gaps between what the evidence suggests is effective in promoting learning and what is happening in practice in each system; and (2) allowing governments to track progress as they take action to close those gaps.  In this article, the conceptual foundations of the GEPD will be presented along with the methodology behind data collection. Additionally, findings from five countries will be discussed: Peru, Jordan, Rwanda, Ethiopia, and Madagascar."
bibliography: ./bibliography.bib
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE,
	fig.width = 9, fig.height = 6, fig.path = "plots/", dev = c("png"), dpi=500
)
#libraries
library(tidyverse)
library(foreign)
library(here)
library(vtable)
library(flextable)
library(ggthemes)
library(Hmisc)
library(httr)
library(patchwork)
library(ggrepel)
library(lubridate)
library(haven)
library(zoo)
library(readxl)
library(ggbeeswarm)
library(estimatr)
library(ggpmisc)
library(ggthemes)
library(ggtext)
library(gtsummary)
library(geosphere)
library(fixest)
library(modelsummary)
options(modelsummary_factory_word = 'flextable')
custom_theme <- function(x, ...) {
    x %>% set_table_properties(layout = "autofit")
}
options("modelsummary_theme_flextable" = custom_theme)

library(factoextra)
library(skimr)
#directories


  if (str_to_lower(Sys.info()["user"]) == "wb469649") {
      
    dir <- here()
    shared_loc <- 'C:/Users/wb469649/WBG/Ezequiel Molina - Dashboard (Team Folder)/Main_Documents/GEPD_FCDO_report/'
  } else if (str_to_lower(Sys.info()["user"]) == "wb577189") {

    dir <- "C:/Users/wb577189/OneDrive - WBG/Documents/GitHub/GEPD"
    shared_loc <- 'C:/Users/wb577189/WBG/Ezequiel Molina - Dashboard (Team Folder)/Main_Documents/GEPD_FCDO_report/'
  }


indicators_dir <- paste(dir, 'Indicators', sep="/")
out_dir <- paste(dir, 'Output', sep="/")

#path to confidential directory

  if (str_to_lower(Sys.info()["user"]) == "wb469649") {
    #directories
    confidential_dir<- "C:/Users/wb469649/WBG/HEDGE Files - HEDGE Documents/GEPD-Confidential/"
    anonymized_dir <- "C:/Users/wb469649/WBG/HEDGE Files - HEDGE Documents/GEPD/"

  } else if (str_to_lower(Sys.info()["user"]) == "wb577189") {
    #directories
    confidential_dir<- "C:/Users/wb577189/OneDrive - WBG/GEPD-Confidential/"
    anonymized_dir <- "C:/Users/wb577189/OneDrive - WBG/GEPD/"

  }



# change_here <- function(new_path){
#   new_root <- here:::.root_env
#   
#   new_root$f <- function(...){file.path(new_path, ...)}
#   
#   assignInNamespace(".root_env", new_root, ns = "here")
# }

#list countries
countries <- c("PER", "JOR", "RWA", "MDG", "ETH")

```

```{r functions}
#functions
FitFlextableToPage <- function(ft, pgwidth = 5){

  ft_out <- ft %>% autofit()

  ft_out <- width(ft_out, width = dim(ft_out)$widths*pgwidth /(flextable_dim(ft_out)$widths))
  return(ft_out)
}

#add equations to plots
eq_plot_txt <- function(y,x,data) {
  
  f <- as.formula(paste(y,x, sep="~"))
  
  eq <- lm_robust(f, data=data, se_type='HC2')
  coef <- coef(eq)
  std_err <- sqrt(diag(vcov(eq)))
  r_2<- summary(eq)$r.squared
  glue::glue("y = {round(coef[1],3)} + {round(coef[2],3)} x, R<sup>2</sup> = {round(r_2[1],3)} <br> &nbsp;   &nbsp;  	&nbsp; 	&nbsp;   ({round(std_err[1],3)}) &nbsp;   &nbsp;  ({round(std_err[2],3)})" )
}

#modelsummary output
gm <- tibble::tribble(
  ~raw,        ~clean,          ~fmt,
  "nobs",      "N",             0,
  "r.squared", "R Sq.", 2)
```


```{r load}

#read in indicator metadata
indicators <- read_csv(paste(dir,'Indicators/indicators.csv', sep = "/"))

# read in indicator data
PER_data <- read_csv(paste0(indicators_dir, "/GEPD_Indicators_API_", 'PER', ".csv")) %>%
  mutate(country="Peru",
         date='2019') %>%
  select(-year)

RWA_data <- read_csv(paste0(indicators_dir, "/GEPD_Indicators_API_", 'RWA', ".csv")) %>%
  mutate(country="Rwanda",
         date='2020') %>%
  select(-year)


JOR_data <- read_csv(paste0(indicators_dir, "/GEPD_Indicators_API_", 'JOR', ".csv")) %>%
  mutate(country="Jordan",
         date='2019') %>%
  select(-year)


ETH_data <- read_csv(paste0(indicators_dir, "/GEPD_Indicators_API_", 'ETH_pooled', ".csv")) %>%
  mutate(country="Ethiopia",
         date='2020-2021')  %>%
  select(-year)

# %>%
#   rename(value=value_pooled)

MDG_data <- read_csv(paste0(indicators_dir, "/GEPD_Indicators_API_", 'MDG', ".csv")) %>%
  mutate(country="Madagascar",
         date='2021') %>%
  select(-year)


# Indicator names
indicator_names_df <- PER_data %>%
  select(Series, `Indicator Name`)

combined_df_raw <- bind_rows(PER_data,JOR_data, ETH_data, RWA_data, MDG_data)


  
  combined_df <- combined_df_raw %>%
    arrange(Series) %>%
    mutate(
           value=round(value,1),
           value_color=case_when(
             value_metadata=="Needs Improvement" ~ "#FF0000",
             value_metadata=="Caution" ~ "#FCD606",
             value_metadata=="On Target" ~ "#85C546",
             TRUE ~ "#808080"
           ),
           Series=str_replace_all(Series, "SE.LPV","SE.GEPD"))


combined_wide_df <- combined_df %>%
  select(Series, country, value) %>%
  pivot_wider(
    names_from=country, 
    values_from=value
  ) %>%
  left_join(indicator_names_df)

combined_wide_color <- combined_df %>%
  select(Series, country, value_color) %>%
  pivot_wider(
    names_from=country, 
    values_from=value_color
  ) %>%
  left_join(indicator_names_df)

combined_wide_df %>%
  rename(Indicator_Name=`Indicator Name`) %>%
  haven::write_dta(  paste0(confidential_dir, "General/combined_indicators.dta")) %>%
  haven::write_dta( paste0(shared_loc, "/Data/combined_indicators.dta"))


```


# Introduction

[The next three paragraphs are pulled verbatim from technical note.  This is just a placeholder, as we should add custom motivation]

Many countries, despite having significantly increased access to education for their children and youth, now realize that they are facing a learning crisis. In low- and middle-income countries, where enrollment in primary school is nearly universal, even before the COVID-19 pandemic hit, 53% of children suffered from Learning Poverty—meaning that they could not read and understand a short age-appropriate story by age 10. This reality underlines that schooling is not the same as learning, even though education policy often assumes that it is. The learning crisis has only deepened with the extended school closures and the sharp recessions caused by the pandemic.

The World Development Report 2018 argued that the learning crisis has multiple causes: poor service delivery in schools and communities, policies that are not aligned toward learning for all, and unhealthy politics and low bureaucratic capacity. To tackle the crisis and improve student learning for all, countries need to know where they stand on these three key dimensions—practices (or service delivery), policies, and politics. But providing such a systemwide overview requires better measurement. Many drivers of learning are not captured by existing administrative systems. And although new measurement tools capture some of these drivers well, no single instrument pulls together data on all these areas. This gap leaves policymakers in the dark about what is working and what isn’t.

To fill this gap, the World Bank, with support from the Bill and Melinda Gates Foundation, the UK’s Department for International Development, and the Government of Japan, has launched a Global Education Policy Dashboard, which measures the key drivers of learning outcomes in basic education around the world. In doing so, the GEPD highlights where systems are falling short in providing quality education for all children,  identifies gaps between current practice and what evidence suggests would be most effective in promoting learning for all, and helps governments in setting priorities and tracking progress as they work to close those gaps.  

[@filmer2018learning]

[@azevedo2021will]

What is the key message from this work?   
  - 
  
![](plots/gepd_framework.png)  

# Methodology

The Dashboard project collects new data in each country using three new instruments: A School Survey, a Policy Survey, and a Survey of Public Officials. Data collection involves school visits, classroom observations, legislative reviews, teacher and student assessments, and interviews with teachers, principals, and public officials. In addition, the project draws on some existing data sources to complement the new data it collects. A major objective of the GEPD project was to develop focused, cost-effective instruments and data-collection procedures, so that the dashboard can be inexpensive enough to be implemented (and re-implemented) in many countries. The team achieved this by streamlining and simplifying existing instruments, and thereby reducing the time required for data collection and training of enumerators.

![](plots/cost_fig.png)

## Instruments 

A detailed description of the GEPD instruments is available in the [GEPD Technical Note](https://www.educationpolicydashboard.org/sites/epd/files/resources-documents/GEPD%20Technical%20Note.pdf).  Additionally, all code used to construct the indicators is available in the Global Education Policy Dashboard [Github page](https://github.com/worldbank/GEPD).  A shorter description pertaining to each of the three instruments can be found below:

•	School Survey: The School Survey collects data primarily on Practices (the quality of service delivery in schools), but also on some de facto Policy indicators.  It consists of streamlined versions of existing instruments used by the World Bank and partners—including Service Delivery Indicators (SDI) Surveys on teachers and inputs/infrastructure, TEACH on pedagogical practice, Global Early Child Development Database (GECDD) and Measuring Early Learning Quality and Outcomes (MELQO) on school readiness of young children, and the Development World Management Survey (D-WMS) on management quality—together with new questions to fill gaps in those instruments. Though the number of modules in the School Survey is similar to the full version of the Service Delivery Indicators (SDI) Survey, the number of items and the complexity of the questions within each module have been reduced to streamline the survey, while additional items and assessments have been added from other instruments. The School Survey includes 8 short modules: School Information, Teacher Presence, Teacher Survey, Classroom Observation, Teacher Assessment, 1st-Grade Direct Assessment, School Management Survey, and 4th-Grade Student Assessment. 

•	Policy Survey: The Policy Survey collects information to feed into the Policy de jure indicators. This survey is filled out by key informants in each country, drawing on their knowledge to identify key elements of the policy framework (as in the SABER approach to policy-data collection that the Bank has used over the past 9 years).  The survey includes questions on policies related to teachers, school management, inputs and infrastructure, and learners. 

•	Survey of Public Officials: The Survey of Public Officials collects information about the capacity and orientation of the bureaucracy, as well as political factors affecting education outcomes. This survey is a streamlined and education-focused version of the civil-servant surveys that the Bureaucracy Lab (a joint initiative of the Governance Global Practice and the Development Impact Evaluation unit of the World Bank) has implemented recently in several countries. The survey includes questions about technical and leadership skills, work environment, stakeholder engagement, impartial decision-making, and attitudes and behaviors. 

## Sampling

The aim of the GEPD surveys is to produce nationally representative estimates with enough precision to allow detection of changes over time at a minimum power of 80% and at a 0.05 significance level. The GEPD also sets aims to detect differences by urban/rural location and by gender on relevant indicators.  In some cases, we can provide statistics by region, but this will depend on the geography of the country and the number of regions making up that country.  

For the GEPD School Survey, a two-stage random sample design is used.  In the first stage, Bank staff select a random sample of around 200 schools.  The sample is stratified based on urban/rural classification and the region in which schools are located. When stratifying by region, the GEPD team works with partners within the country to make sure all relevant geographical divisions are included. In the second stage, a random sample of teachers and students is selected to answer questions from the survey modules; this sampling is done by enumerators in the field at each school. Ten teachers per school are sampled for attendance checks, and five teachers are interviewed and given a teacher assessment. Three randomly selected 1st grade students are assessed, as is a randomly selected classroom of 4th grade students.  We could only interview three 1st grade students, compared to an entire 4th grade classroom, because the 1st grade assessment is done face to face by our enumerators and takes a considerable amount of time per student (~15-20 minutes).  The 4th grade assessment can be given to an entire class simultaneously.

For the GEPD Survey of Public Officials, 200 public education officials in each country are randomly selected for interviews.  These public officials are typically professional staff at the Ministry of Education central office, as well as from the regional or district offices. Roughly 60 officials are surveyed at the federal (or central-government) level, while 140 officials are surveyed at the regional/district level.  To select officials at the regional and district level, the team employs a cluster sampling strategy, where 10 regional offices are chosen at random from among the regions in which schools were sampled. Among these 10 regions, 10 districts are selected (one in each region) from among the districts in which schools are sampled. The result of this sampling approach is that for 10 clusters, the GEPD captures the links from the school to the district office, to the regional office, and then to the central office. In each regional/district office, 7 officials are sampled: the head of the office, the HR director, and 5 officials working in finance and planning chosen at random.  At the federal level, the GEPD team works with the Ministry of Education to identify the offices that should be included in the sample according to the functions they serve. In each office, the director of the office is interviewed along with a randomly selected number of public officials. The team aims to maintain roughly the same sampling strategy for the Survey of Public Officials for all countries, with some adaptation to country characteristics. For instance, in countries with smaller district offices, a larger number of district offices will be sampled, with fewer public officials interviewed at each of them. In countries with smaller offices at the federal level, fewer public officials will be interviewed at the federal level and more will be interviewed at the decentralized level. Ultimately, these adaptations are the result of extensive dialogue with the country counterparts. 


Before producing the sample using the stratification approach, the sampling frame is defined. Typically, the sampling frame includes all schools with at least three 1st-grade and at least three 4th-grade students, according to the latest school census. This minimum size was set to ensure that enough teachers and students would be interviewed on the limited budget available for each country.  To develop this sampling frame, the GEPD team works with the World Bank country teams and the country counterparts to compile an up-to-date and detailed database containing information on schools. Depending on the country, the sampling frame may include private schools, typically because a large share of students attends private schools. This sampling decision is jointly made by World Bank and country counterparts. As an example, in Peru only public schools were sampled, because private schools represent a small share of the schools in the country. Alternatively, in Jordan, the percentage of private schools was larger, and so a decision was made to include both public and private schools. 

For the stratified sampling, the stratification variables used are the rural/urban status of each school as well as the 1st- or 2nd-level administrative division (while the denomination changes, in most cases, the 1st administrative division is the province/department-level and the 2nd division corresponds to districts). For example, in Peru, the department and urban/rural status of the school made up the stratification variables. In cases where private schools are also included in the sampling frame, as in Jordan, the public/private status of the school is also included as a stratification variable.

In each country, the sampling strategy is slightly customized to reflect ongoing efforts and meet country needs. This is discussed further in the Data section below.




![](plots/GEPD_comprehensive.png)






# Data

Table 1: GEPD Data Collection Overview


| Country | Dates | Number of Schools | Description |
|---|---|---|---|
| Peru | November 2019 | 205 |     MELQO data was merged with the Peru school sampling frame to allow optimal stratification. The stratification was done on the basis of urban/rural   location and department. There are 25 departments in Peru. In 2017, Peru   conducted an examination of around 4,500 children aged 5-8, with a median age   of 6. The MELQO assessment is quite similar to the GEPD 1st-Grade Direct   Assessment. Using data from this 2017 survey, the team calculated means and   standard deviations by province and fed this information into the optimal   stratification algorithm. Provinces with low standard deviations among   students in terms of their MELQO development scores are allocated fewer   schools compared to an allocation that is simply based on population, and   provinces with high standard deviations are allocated more schools. 205   schools were chosen for the GEPD School Survey after optimally stratifying.    |
| Jordan | December 2019 | 250 |     For the GEPD School Survey, both public and private schools that are supervised   by the Ministry or Education were included in the sampling frame. Schools   supervised by Ministry of Defense, Ministry of Endowments, Ministry of Higher   Education, or Ministry of Social Development were excluded from the sampling   frame. This left a sampling frame containing 3,330 schools, with 1297 private   schools and 2003 public schools. Schools kept needed to have at least three 1st-grade   students, three 4th-grade students, and three teachers. Southern   schools were oversampled (to reach a total of 50 Southern schools) to allow regional   comparisons. Additionally, second-shift (evening) schools were oversampled,   for a total of 40 second-shift schools, to allow reporting on this unique   type of school.   Second-shift schools   make up around 16% of our total sample, while they make up 7.6% of the   schools in our sampling frame.  When   producing a national estimate, we reweight the schools to be reflective of   their totals in the population. 250 schools were sampled for the School   Survey after the discussed adaptations.     |
| Rwanda | February 2020 | 200 |     In the case of Rwanda, the GEPD team tested the possibility of each field team   visiting 2 schools per day. To allow visits to two schools per day, the team clustered   at the sector level and chose two schools per cluster. With a sample of 200   schools, this means that 100 PSUs had to be allocated. This clustering was   combined with stratification by district and by the urban/rural status of the   schools. The number of PSUs allocated to each stratum is proportionate to the   number of schools in each stratum (i.e., the district X urban/rural status   combination).    |
| Ethiopia | March 2020, June 2021 | 300 | In Ethiopia, a sample of 300 public schools from each of the provinces of Ethiopia was taken.  As a comparison to the total number of schools in Ethiopia, this constitutes an approximately 1% sample.  Because of the large size of the country, and because there can be very large distances between Woredas within the same province, a cluster sampling approach was chosen.  In this approach, 100 woredas were chosen with probability proportional to 4th grade size, with the number of woredas chosen within each province proportional to the regional 4th grade population.  Then within each woreda two rural and one urban school were chosen with probability proportional to 4th grade size.  Data collection started in March 2020, but because of school closures related to COVID, only 128 schools were visited at this time.  In June 2021, data collection was resumed for the other 182 schools.  During the June 2021 data collection, security issues in Tigray meant that 6 schools out of 15 originally chosen in the original sample could not be visited.  These 6 schools were replaced by schools in Amhara province. |
| Madagascar | June 2021 | 200 | In Madagascar, the sample for the GEPD school survey was drawn to be representative of primary schools at the national and regional levels, using EMIS data of 2019. The sampling frame consisted of 33,120 public and private primary schools – 25,869 public and 7,251 private schools - across the 1,567 communes covered by EMIS data in Madagascar’s 22 regions. 200 schools were selected for the GEPD survey, where the strata are regions and urban/rural status of schools. |



 GDP per square kilometer data is produced by World Bank staff originally for the the Global Assessment Report on Risk Reduction (GAR) for the year 2010.  The data can be found at https://datacatalog.worldbank.org/dataset/gross-domestic-product-2010.

# Findings

## Overview of Indicators


```{r countrytabfn}
#create function for creating country comparison tables
country_tab_fn <- function(variables, title) {
  
  
tab_df <- combined_wide_df %>%
  filter(Series %in% variables) %>%
  arrange(factor(Series, levels=variables))

#set colors
tab_color_df <- combined_wide_color %>%
  filter(Series %in% variables) %>%
  arrange(factor(Series, levels=variables))

Peru_col <- tab_color_df$Peru
Jordan_col <- tab_color_df$Jordan
Rwanda_col <- tab_color_df$Rwanda
Ethiopia_col <- tab_color_df$Ethiopia
Madagascar_col <- tab_color_df$Madagascar


#build table
tab_df <- tab_df  %>%
  select(`Indicator Name`, Peru, Jordan, Rwanda, Ethiopia, Madagascar)


ovr_table <- flextable(tab_df) %>%
  add_header_lines(title) %>%
  add_footer_lines('Source: UIS, GLAD, GEPD, World Bank. 
 Green indicates indicator "on-target", yellow indicates "requires caution", red indicates "needs improvement"' ) %>%
  theme_vanilla()

#colors
ovr_table <- ovr_table %>%
  bg(j = c('Peru'),
     bg = Peru_col) %>%
  bg(j = c('Jordan'),
     bg = Jordan_col) %>%
  bg(j = c('Ethiopia'),
     bg = Ethiopia_col) %>%
  bg(j = c('Rwanda'),
     bg = Rwanda_col) %>%
  bg(j = c('Madagascar'),
     bg = Madagascar_col)   


FitFlextableToPage(ovr_table) %>%
  set_table_properties(layout = "autofit")

  
}
```


```{r outtab}
# Produce a table showing means by country for select practice indicators
outcome_indicators <- c(
  'SE.GEPD.PRIM',
  'SE.GEPD.PRIM.BMP',
  'SE.PRM.TENR'

)
country_tab_fn(outcome_indicators, 'GEPD Outcome Indicators') %>%
  add_footer_lines('Rwanda does not have an internationally comparable learning assessment to report on Learning Poverty.')
```


```{r}
#pull data on other outcomes, GNI per capita, Population, HCI, poverty, stunting

dev_out_df <- WDI::WDI(
    country=c('ET','RW','PE','JO','MG'),
    indicator=c("SP.POP.TOTL","SP.POP.0014.TO", "NY.GNP.PCAP.PP.KD","SI.POV.DDAY", "HD.HCI.OVRL", "SH.STA.STNT.ZS"  ),
    start=2010,
    end=2020,
    latest=1,
    extra = TRUE
  ) %>%
  fill(c("SP.POP.TOTL", "SP.POP.0014.TO", "NY.GNP.PCAP.PP.KD","SI.POV.DDAY", "HD.HCI.OVRL", "SH.STA.STNT.ZS"  )) %>%
  group_by(iso3c) %>%
  arrange(year) %>%
  filter(row_number()==n()) %>%
  ungroup() %>%
  select(country, c("SP.POP.TOTL","SP.POP.0014.TO", "NY.GNP.PCAP.PP.KD","SI.POV.DDAY", "HD.HCI.OVRL", "SH.STA.STNT.ZS"  )) 


names <- setNames(stack(lapply(dev_out_df, label))[2:1], c("Varcode", "Variables"))

dev_out_df <- dev_out_df %>%
  mutate(across(c("SP.POP.TOTL","SP.POP.0014.TO", "NY.GNP.PCAP.PP.KD","SI.POV.DDAY", "HD.HCI.OVRL", "SH.STA.STNT.ZS"  ), scales::comma))

dev_out_tab <- t(dev_out_df) %>%
  as_tibble()

colnames(dev_out_tab) <- dev_out_tab[1,]

dev_out_tab <- dev_out_tab[-1,]
rownames(dev_out_tab) <- names$Variables[-1]

dev_out_tab %>%
  rownames_to_column(var = 'Outcome') %>%
  select("Outcome", "Peru", "Jordan", "Rwanda", "Ethiopia", "Madagascar") %>%
  flextable() %>%
  colformat_int(j=2:6,big.mark = ",") %>%
  add_header_lines('Development Context for GEPD Countries.') %>%
  add_footer_lines("Source: World Bank World Development Indicators") %>%
  autofit()

```


Below is a table showing the means by country on the GEPD Practice Indicators.  We use the following system for categorizing our main indicators into three levels: On Target, Caution, and Needs Improvement.

For our indicators ranging from 0-100, we use the following system:

1. On Target - Values at least 90%  
2. Caution - Values between 85-90  
3. Needs Improvement - Values under 85%  

For our indicators ranging 1-5, we use the following system:

1. On Target - Values at least 4  
2. Caution - Values between 3 and 4  
3. Needs Improvement - Values 3 and under  

In the tables below, indicators shared in green are "On Target", indicators shared in yellow are "Caution", and indicators shaded in red are "Needs Improvement".

The tables reveals major issues across countries in terms of 4th grade student proficiency on the GEPD assessment, teacher content knowledge, teacher pedagogical skills, and student readiness as measured using the 1st grade assessment.  In every country, conditions at the average school need improvement, according to the GEPD standards.  Additionally, teacher presence at the school and basic infrastructure are the need improvement area in Ethiopia and Madagascar.  Basic inputs need improvement in Madagascar, as do operational management and instructional leadership.  

Areas where schools tend to be relatively stronger, receiving a score of "On Target", are in the areas of principal management skills, except in Madagascar, and in operational management in Peru, Jordan, and Ethiopia.  Teacher presence, basic inputs, and student attendance are also on target in Peru and Jordan.



```{r ovltab}
# Produce a table showing means by country for select practice indicators
practice_indicators <- c(
  'SE.PRM.LERN',
  'SE.PRM.EFFT',
  'SE.PRM.CONT',
  'SE.PRM.PEDG',
  'SE.PRM.INPT',
  'SE.PRM.INFR',
  'SE.PRM.LCAP',
  'SE.PRM.ATTD',
  'SE.PRM.OPMN',
  'SE.PRM.ILDR',
  'SE.PRM.PKNW',
  'SE.PRM.PMAN'
)
country_tab_fn(practice_indicators, 'GEPD Practice Indicators')
```


```{r}

tab_df_ovrl <- combined_wide_df %>%
  filter(Series %in% practice_indicators) %>%
  arrange(factor(Series, levels=practice_indicators))

#urban rural split
practice_indicators_R <- c(
  'SE.PRM.LERN.1.R',
  'SE.PRM.EFFT.2.R',
  'SE.PRM.CONT.1.R',
  'SE.PRM.PEDG.1.R',
  'SE.PRM.INPT.1.R',
  'SE.PRM.INFR.1.R',
  'SE.PRM.LCAP.1.R',
  'SE.PRM.ATTD.1.R',
  'SE.PRM.OPMN.1.R',
  'SE.PRM.ILDR.1.R',
  'SE.PRM.PKNW.1.R',
  'SE.PRM.PMAN.1.R'
)

title <- 'GEPD Practice Indicators Urban/Rural'
  
tab_df_R <- combined_wide_df %>%
  filter(Series %in% practice_indicators_R) %>%
  arrange(factor(Series, levels=practice_indicators_R))

#set colors
tab_color_df_R <- combined_wide_color %>%
  filter(Series %in% practice_indicators_R) %>%
  arrange(factor(Series, levels=practice_indicators_R))

Peru_col_R <- tab_color_df_R$Peru
Jordan_col_R <- tab_color_df_R$Jordan
Rwanda_col_R <- tab_color_df_R$Rwanda
Ethiopia_col_R <- tab_color_df_R$Ethiopia
Madagascar_col_R <- tab_color_df_R$Madagascar


#build table
tab_df_R <- tab_df_R  %>%
  select(`Indicator Name`, Peru, Jordan, Rwanda, Ethiopia, Madagascar) %>%
  rename(Peru_R=Peru, 
         Jordan_R=Jordan, 
         Rwanda_R=Rwanda,
         Ethiopia_R=Ethiopia, 
         Madagascar_R=Madagascar)

tab_df_R$`Indicator Name` <- tab_df_ovrl$`Indicator Name`
tab_df_R$`Indicator Name`[7] <- "Student Readiness (percentage correct)"


# urban 
practice_indicators_U <- c(
  'SE.PRM.LERN.1.U',
  'SE.PRM.EFFT.2.U',
  'SE.PRM.CONT.1.U',
  'SE.PRM.PEDG.1.U',
  'SE.PRM.INPT.1.U',
  'SE.PRM.INFR.1.U',
  'SE.PRM.LCAP.1.U',
  'SE.PRM.ATTD.1.U',
  'SE.PRM.OPMN.1.U',
  'SE.PRM.ILDR.1.U',
  'SE.PRM.PKNW.1.U',
  'SE.PRM.PMAN.1.U'
)


tab_df_U <- combined_wide_df %>%
  filter(Series %in% practice_indicators_U) %>%
  arrange(factor(Series, levels=practice_indicators_U))

#set colors
tab_color_df_U <- combined_wide_color %>%
  filter(Series %in% practice_indicators_U) %>%
  arrange(factor(Series, levels=practice_indicators_U))

Peru_col_U <- tab_color_df_U$Peru
Jordan_col_U <- tab_color_df_U$Jordan
Rwanda_col_U <- tab_color_df_U$Rwanda
Ethiopia_col_U <- tab_color_df_U$Ethiopia
Madagascar_col_U <- tab_color_df_U$Madagascar


#build table
tab_df_U <- tab_df_U  %>%
  select(`Indicator Name`, Peru, Jordan, Rwanda, Ethiopia, Madagascar) %>%
  rename(Peru_U=Peru, 
         Jordan_U=Jordan, 
         Rwanda_U=Rwanda,
         Ethiopia_U=Ethiopia, 
         Madagascar_U=Madagascar)

tab_df_U$`Indicator Name` <- tab_df_ovrl$`Indicator Name`
tab_df_U$`Indicator Name`[7] <- "Student Readiness (percentage correct)"



#combined
tab_df_comb <- tab_df_R %>%
  left_join(tab_df_U) %>%
  select(`Indicator Name`, Peru_R, Peru_U, Jordan_R, Jordan_U, Rwanda_R, Rwanda_U, Ethiopia_R, Ethiopia_U, Madagascar_R, Madagascar_U)

ovr_table <- flextable(tab_df_comb) %>%
  bg(j = c('Peru_R'),
     bg = Peru_col_R) %>%
  bg(j = c('Jordan_R'),
     bg = Jordan_col_R) %>%
  bg(j = c('Ethiopia_R'),
     bg = Ethiopia_col_R) %>%
  bg(j = c('Rwanda_R'),
     bg = Rwanda_col_R) %>%
  bg(j = c('Madagascar_R'),
     bg = Madagascar_col_R) %>%
  bg(j = c('Peru_U'),
     bg = Peru_col_U) %>%
  bg(j = c('Jordan_U'),
     bg = Jordan_col_U) %>%
  bg(j = c('Ethiopia_U'),
     bg = Ethiopia_col_U) %>%
  bg(j = c('Rwanda_U'),
     bg = Rwanda_col_U) %>%
  bg(j = c('Madagascar_U'),
     bg = Madagascar_col_U)   %>%
  set_header_labels(
         Peru_U='Urban', 
         Jordan_U='Urban', 
         Rwanda_U='Urban',
         Ethiopia_U='Urban', 
         Madagascar_U='Urban',
         Peru_R='Rural', 
         Jordan_R='Rural', 
         Rwanda_R='Rural',
         Ethiopia_R='Rural', 
         Madagascar_R='Rural' 
  ) %>%
  add_header(
         Peru_U='Peru', 
         Jordan_U='Jordan', 
         Rwanda_U='Rwanda',
         Ethiopia_U='Ethiopia', 
         Madagascar_U='Madagascar',
         Peru_R='Peru', 
         Jordan_R='Jordan', 
         Rwanda_R='Rwanda',
         Ethiopia_R='Ethiopia', 
         Madagascar_R='Madagascar'         
  ) %>%
  merge_h( part = "header") %>%
  add_header_lines(title) %>%
  add_footer( Group = paste0('Source: UIS, GLAD, GEPD, World Bank. 
(1) Proficiency on GEPD assessment means % students with knowledge 80%.\n  (2) Proficiency by end of primary uses threshold as per Minimum Proficiency Levels set by GAML(UIS).\n (3) All indicators are on a scale of 0-5 unless measured in %. \n (4) Green indicates indicator "on-target", yellow indicates "requires caution", red indicates "needs improvement"' )) %>%
  merge_at( j = 1:4, part = "footer") %>%
  theme_vanilla() %>%
  vline(j=1) %>%
  vline(j=3) %>%
  vline(j=5) %>%
  vline(j=7)%>%
  vline(j=9) 




```


```{r alttab, eval=FALSE, include=FALSE}



value_plotter_100  <- function(variables) {
  
  data <- data.frame(x=1,y=variables) 
  colr <- ifelse(variables <85, "#FF0000", ifelse((variables >=85 & variables<90), "#FCD606", ifelse(variables >=90, "#85C546","#808080")))
  

  
  ggplot(data, aes(x=x,y=y)) +
    geom_col(fill=colr) +
    geom_text(aes(label=y,y=50), size=4) +
    theme_void() +
    expand_limits(y=c(0,100))
  }

value_plotter_5  <- function(variables) {
  
  data <- data.frame(x=1,y=variables) 
  colr <- ifelse(variables <3, "#FF0000", ifelse((variables >=3 & variables<4), "#FCD606", ifelse(variables >=4, "#85C546","#808080")))
  

  
  ggplot(data, aes(x=x,y=y)) +
    geom_col(fill=colr) +
    geom_text(aes(label=y, y=3), size=4) +
    theme_void() +
    expand_limits(y=c(0,5))
}


list_100 <-  c(
    "Proficiency on GEPD Assessment",
    "Teacher Presence",
    "Teacher Pedagogical Skills",
    "Teacher Content Knowledge",
    "Student Readiness (percentage correct)",
    "Student Attendance")

gg_df <- tab_df_comb %>%
  group_by(`Indicator Name`) %>%
  mutate(Peru_R_gg_100=map(Peru_R,value_plotter_100),
         Peru_U_gg_100=map(Peru_U,value_plotter_100),
         Jordan_R_gg_100=map(Jordan_R,value_plotter_100),
         Jordan_U_gg_100=map(Jordan_U,value_plotter_100),
         Rwanda_R_gg_100=map(Rwanda_R,value_plotter_100),
         Rwanda_U_gg_100=map(Rwanda_U,value_plotter_100),
         Ethiopia_R_gg_100=map(Ethiopia_R,value_plotter_100),
         Ethiopia_U_gg_100=map(Ethiopia_U,value_plotter_100),
         Madagascar_R_gg_100=map(Madagascar_R,value_plotter_100),
         Madagascar_U_gg_100=map(Madagascar_U,value_plotter_100),
         
         Peru_R_gg_5=map(Peru_R,value_plotter_5),
         Peru_U_gg_5=map(Peru_U,value_plotter_5),
         Jordan_R_gg_5=map(Jordan_R,value_plotter_5),
         Jordan_U_gg_5=map(Jordan_U,value_plotter_5),
         Rwanda_R_gg_5=map(Rwanda_R,value_plotter_5),
         Rwanda_U_gg_5=map(Rwanda_U,value_plotter_5),
         Ethiopia_R_gg_5=map(Ethiopia_R,value_plotter_5),
         Ethiopia_U_gg_5=map(Ethiopia_U,value_plotter_5),
         Madagascar_R_gg_5=map(Madagascar_R,value_plotter_5),
         Madagascar_U_gg_5=map(Madagascar_U,value_plotter_5)) %>%
  ungroup() %>%
  mutate(
    Peru_R=if_else(`Indicator Name` %in% list_100, Peru_R_gg_100, Peru_R_gg_5),
    Peru_U=if_else(`Indicator Name` %in% list_100, Peru_U_gg_100, Peru_U_gg_5),
    Jordan_R=if_else(`Indicator Name` %in% list_100, Jordan_R_gg_100, Jordan_R_gg_5),
    Jordan_U=if_else(`Indicator Name` %in% list_100, Jordan_U_gg_100, Jordan_U_gg_5),
    Rwanda_R=if_else(`Indicator Name` %in% list_100, Rwanda_R_gg_100, Rwanda_R_gg_5),
    Rwanda_U=if_else(`Indicator Name` %in% list_100, Rwanda_U_gg_100, Rwanda_U_gg_5),
    Ethiopia_R=if_else(`Indicator Name` %in% list_100, Ethiopia_R_gg_100, Ethiopia_R_gg_5),
    Ethiopia_U=if_else(`Indicator Name` %in% list_100, Ethiopia_U_gg_100, Ethiopia_U_gg_5),
    Madagascar_R=if_else(`Indicator Name` %in% list_100, Madagascar_R_gg_100, Madagascar_R_gg_5),
    Madagascar_U=if_else(`Indicator Name` %in% list_100, Madagascar_U_gg_100, Madagascar_U_gg_5)
  ) %>%
  select(-contains("_gg_"))
  # mutate(Peru_R=map(Peru_R, .f=if_else(`Indicator Name` %in% c(
  #   "Proficiency on GEPD Assessment",
  #   "Teacher Presence",
  #   "Teacher Pedagogical Skills",
  #   "Teacher Content Knowledge",
  #   "Student Readiness (percentage correct)",
  #   "Student Attendance"), value_plotter_100, value_plotter_5)))

# gg_df[] <- lapply(gg_df, function(x) value_plotter_100(x))

flextable(gg_df) %>%
  compose(j=c("Peru_R", "Peru_U", "Jordan_R", "Jordan_U", "Rwanda_R", "Rwanda_U", "Ethiopia_R", "Ethiopia_U", "Madagascar_R", "Madagascar_U"),
          value = as_paragraph(gg_chunk(value = ., height = .3, width = .5)),
              use_dot = TRUE) %>%
  set_header_labels(
         Peru_U='Urban', 
         Jordan_U='Urban', 
         Rwanda_U='Urban',
         Ethiopia_U='Urban', 
         Madagascar_U='Urban',
         Peru_R='Rural', 
         Jordan_R='Rural', 
         Rwanda_R='Rural',
         Ethiopia_R='Rural', 
         Madagascar_R='Rural' 
  ) %>%
  add_header(
         Peru_U='Peru', 
         Jordan_U='Jordan', 
         Rwanda_U='Rwanda',
         Ethiopia_U='Ethiopia', 
         Madagascar_U='Madagascar',
         Peru_R='Peru', 
         Jordan_R='Jordan', 
         Rwanda_R='Rwanda',
         Ethiopia_R='Ethiopia', 
         Madagascar_R='Madagascar'         
  ) %>%
  merge_h( part = "header") %>%
  add_header_lines(title) %>%
  add_footer( Group = paste0('Source: UIS, GLAD, GEPD, World Bank. 
(1) Proficiency on GEPD assessment means % students with knowledge 80%.\n  (2) Proficiency by end of primary uses threshold as per Minimum Proficiency Levels set by GAML(UIS).\n (3) All indicators are on a scale of 0-5 unless measured in %. \n (4) Green indicates indicator "on-target", yellow indicates "requires caution", red indicates "needs improvement"' )) %>%
  merge_at( j = 1:4, part = "footer") %>%
  theme_vanilla() %>%
  vline(j=1) %>%
  vline(j=3) %>%
  vline(j=5) %>%
  vline(j=7)%>%
  vline(j=9) 



```




```{r urdif}

ur_diff_df <- data.frame(
  Peru=tab_df_R$Peru_R-tab_df_U$Peru_U,
  Jordan=tab_df_R$Jordan_R-tab_df_U$Jordan_U,
  Rwanda=tab_df_R$Rwanda_R-tab_df_U$Rwanda_U,
  Ethiopia=tab_df_R$Ethiopia_R-tab_df_U$Ethiopia_U,
  Madagascar=tab_df_R$Madagascar_R-tab_df_U$Madagascar_U
)

ur_diff_df$`Indicator Name` <- tab_df_ovrl$`Indicator Name`
ur_diff_df$`Indicator Name`[7] <- "Student Readiness (percentage correct)"

ur_diff_df <- ur_diff_df %>%
  select(`Indicator Name`, everything()) %>%
  mutate(Average=rowMeans(ur_diff_df[1:5], na.rm=T))

```


There are also major differences within countries, particularly between urban and rural schools. The table below shows the scores disaggregated by urban and rural in each country.  On average across countries, the gap between the urban and rural schools in the proficiency on the GEPD assessment is `r -round(ur_diff_df$Average[1],1)` points.  For student readiness it is `r -round(ur_diff_df$Average[7],1)` points.  For teacher content knowledge it is `r -round(ur_diff_df$Average[3],1)` points.  For teacher pedagogical skills it is `r -round(ur_diff_df$Average[4],1)` points.  In all the indicators, except for teacher presence, urban areas have higher scores than rural areas in the aggregate.  For teacher presence, the rates in rural areas are higher in Peru and Ethiopia, but are higher in urban areas for the other countries.



```{r}
FitFlextableToPage(ovr_table) %>%
  set_table_properties(layout = "autofit")
```

Figure. Breakdown of of GEPD Practice Indicators by Urban/Rural Status
```{r spider1}

#list of indicaors with scale 0-100
list_100 <-  c(
    "Proficiency on GEPD Assessment",
    "Teacher Presence",
    "Teacher Pedagogical Skills",
    "Teacher Content Knowledge",
    "Student Readiness (percentage correct)",
    "Student Attendance")

list_1_5 <- c(
  "Basic Inputs",
  "Basic Infrastructure" 
)

spider_df <- tab_df_comb %>%
  pivot_longer(
    cols=2:11,
    names_to=c("Country", "Type"),
    names_pattern="(.*)_(.)",
    values_to="value"
  ) %>%
  mutate(Type=if_else(Type=="R", "Rural", "Urban")) %>%
  mutate(
    value=case_when(
      `Indicator Name` %in% list_100 ~ value/100, #scale indicators with scale 0-100
      `Indicator Name` %in% list_1_5 ~ value/5, #scale indicators with scale 0-5
      TRUE ~ (value-1)/4 #scale indicators with scale 1-5
    )) %>%
  ungroup()
  # pivot_wider(
  #   names_from='Type',
  #   values_from='value'
  # ) %>% #now scale all indicators to 0 to 1
  # mutate(
  #   Rural=case_when(
  #     `Indicator Name` %in% list_100 ~ Rural/100, #scale indicators with scale 0-100
  #     `Indicator Name` %in% list_1_5 ~ Rural/5, #scale indicators with scale 0-5
  #     TRUE ~ (Rural-1)/4 #scale indicators with scale 1-5
  #   ),
  #   Urban=case_when(
  #     `Indicator Name` %in% list_100 ~ Urban/100, #scale indicators with scale 0-100
  #     `Indicator Name` %in% list_1_5 ~ Urban/5, #scale indicators with scale 0-5
  #     TRUE ~ (Urban-1)/4 #scale indicators with scale 1-5
  #   )
  # )


p1 <- spider_df %>%
  mutate(`Indicator Name`=str_wrap(`Indicator Name`, width=20)) 

p1 <- p1 %>%
  mutate(`Indicator Name`=factor(`Indicator Name`, levels=c(
            str_wrap("Principal Management Skills" , width=20),
            str_wrap( "Principal School Knowledge"   , width=20),
            str_wrap( "Instructional Leadership"     , width=20),  
            str_wrap("Operational Management"       , width=20),
            str_wrap("Student Attendance"           , width=20), 
            str_wrap("Student Readiness (percentage correct)", width=20), 
            str_wrap("Basic Infrastructure"         , width=20), 
            str_wrap("Basic Inputs"                 , width=20), 
            str_wrap("Teacher Pedagogical Skills"   , width=20),  
            str_wrap("Teacher Content Knowledge"      , width=20), 
            str_wrap("Teacher Presence"                , width=20),  
            str_wrap("Proficiency on GEPD Assessment"  , width=20)     

          )
                                 )) %>%
  ggplot(aes(x=`Indicator Name`, y=value, color=Type, group=`Indicator Name`)) +
  facet_wrap(~Country, ncol=5) +
  geom_point(size=3) +
  geom_line(color='black') +
  theme_bw() +
  theme(legend.position = 'top',
        axis.text.x=element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.title = element_blank(),
        panel.grid.major.y = element_blank()
           # explicitly set the horizontal lines (or they will disappear too)
        #panel.grid.major.x = element_line( size=.1, color="grey" ) 
        ) +
  coord_flip() 

p1
```


### Policy Indicators

Below is a table showing the means by country on the GEPD Policy Indicators. For each of the GEPD policy indicators, two scores are reported: one for *de jure* policy existence and one for *de facto* policy implementation.  *De jure* and *de facto* policies are both scored on a 1-5 scale with 1 indicating a total lack of the policy or implementation and 5 representing the best possible policy environment or implementation.  More details on the definitions for *de jure* and *de facto* policies can be found in the GEPD reference guide.

The scores in the table below are the *de facto* scores across countries.  These indicators are largely formed by interviewing teachers and principals in a random sample of schools within each countries about their experience and understanding of policies.  The exception is for the *de facto* indicators for learners, which are based on other data sources such as the UNICEF MICS survey or other household surveys fielded in the country.  

Weak areas for countries tend to be in policies related to teacher support, teacher monitoring and accountability, center based care for learners, and support for school management.  Countries tended to perform best in terms of school management clarity of functions, attraction, and selection and deployment.  Several indicators were rated in the yellow, "Caution", area including teacher attraction, selection and deployment, and intrinsic motivation, also inputs and infrastructure monitoring, and school management support.

```{r poltab}
# Produce a table showing means by country for select practice indicators
policy_indicators <- c(
'SE.PRM.TATT',
'SE.PRM.TSDP',
'SE.PRM.TSUP',
'SE.PRM.TEVL',
'SE.PRM.TMNA',
'SE.PRM.TINM',
'SE.PRM.ISTD',
'SE.PRM.IMON',
'SE.PRM.LNTN',
'SE.PRM.LHTH',
'SE.PRM.LCBC',
'SE.PRM.LFCP',
'SE.PRM.LSKC',
'SE.PRM.SCFN',
'SE.PRM.SATT',
'SE.PRM.SSLD',
'SE.PRM.SSUP',
'SE.PRM.SEVL'
)
country_tab_fn(policy_indicators, 'GEPD Policy Indicators')
```



For each of the GEPD policy indicators, two scores are reported: one for *de jure* policy existence and one for *de facto* policy implementation.  *De jure* and *de facto* policies are both scored on a 1-5 scale with 1 indicating a total lack of the policy or implementation and 5 representing the best possible policy environment or implementation.  More details on the definitions for *de jure* and *de facto* policies can be found in the GEPD reference guide.

```{r defadejudf}
#gather defacto and de jure indicators

defact_df <- combined_wide_df %>%
  filter(grepl(".DF",Series)) %>%
  mutate(`Indicator Name`=str_remove_all(`Indicator Name`, "\\(De Facto\\) ")) %>%
  pivot_longer(cols=c("Peru", "Jordan", "Ethiopia", "Rwanda", "Madagascar"),
               names_to='country',
               values_to='defacto') %>%
  select(-Series)

dejur_df <-combined_wide_df %>%
  filter(grepl(".DJ",Series)) %>%
  mutate(`Indicator Name`=str_remove_all(`Indicator Name`, "\\(De Jure\\) ")) %>%
    pivot_longer(cols=c("Peru", "Jordan", "Ethiopia", "Rwanda", "Madagascar"),
               names_to='country',
               values_to='dejure') %>%
  select(-Series)

defact_dejure_df <- defact_df %>%
  left_join(dejur_df) %>%
  mutate(`Indicator Name` = str_wrap(`Indicator Name`, 30))


means_dfdj <- defact_dejure_df %>%
  group_by(country) %>%
  summarise(defacto=mean(defacto, na.rm=TRUE),
            dejure=mean(dejure, na.rm=TRUE))

mn_low_defacto <- min(means_dfdj$defacto)
mn_low_defacto_nm <- means_dfdj$country[which(means_dfdj$defacto==mn_low_defacto)]

mn_low_dejure <- min(means_dfdj$dejure)
mn_low_dejure_nm <- means_dfdj$country[which(means_dfdj$dejure==mn_low_dejure)]

mn_high_defacto <- max(means_dfdj$defacto)
mn_high_defacto_nm <- means_dfdj$country[which(means_dfdj$defacto==mn_high_defacto)]

mn_high_dejure <- max(means_dfdj$dejure)
mn_high_dejure_nm <- means_dfdj$country[which(means_dfdj$dejure==mn_high_dejure)]

```




The figure below shows the *de facto* versus *de jure* policy scores for the policy indicators for each of the GEPD countries.  Points colored in purple represent the *de facto* and points colored in blue represent the *de jure*.  One finding that stands out is that in general the *de jure* policy environment tends to be strong in most countries.  The average *de jure* score across policy indicators ranges from a low of `r round(mn_low_dejure,1)` in `r mn_low_dejure_nm` to a high of `r round(mn_high_dejure,1)` in `r mn_high_dejure_nm`.  The average *de facto* score ranges from a low of `r round(mn_low_defacto,1)` in `r mn_low_defacto_nm` to a high of `r round(mn_high_defacto,1)` in `r mn_high_defacto_nm`.

```{r}

means_dfdj %>%
  mutate(defacto=round(defacto,1),
         dejure=round(dejure,1)) %>%
  rename(`De Facto`=defacto,
         `De Jure`=dejure) %>%
  flextable() %>%
    add_header_lines('Average De Facto and De Jure scores across GEPD policy indicators.')

```



```{r defactodejure, fig.width=10, fig.height=10}




ggplot(defact_dejure_df, aes(y=`Indicator Name`, x=defacto)) +
  facet_wrap(~country, ncol=5) +
  geom_point(aes(color='De Facto'), size=4) +
  geom_point(aes(x=dejure, color="De Jure"), size=4) +
  geom_segment(aes( yend=`Indicator Name`, xend=dejure)) +
  xlab('Value') +
  scale_color_manual(
    values=c('De Facto'='#7209b7',
             'De Jure'='#4361ee')
  ) +
  labs(color="Legend") +
  theme_bw() +
  theme(
    legend.position="bottom"
  )



```




### Politics Indicators

Below is a table showing the means by country on the GEPD Bureaucracy or Politics Indicators.  These indicators are largely produced using the GEPD Survey of Public Officials, where a sample of 200 public officials in the central government, regional offices, and district offices are asked their experiences in managing the education system.  Impartial decision making is an area where all countries tended to rate in the "Caution" area.  Public officials reported better performance in mandates and accountability and to some extent the characteristics of the bureaucracy, which measures public officials knowledge of the schools they are supervising, the work environment, merit, and motivation of public employees.

```{r ptictab}
# Produce a table showing means by country for select practice indicators
politics_indicators <- c(
'SE.PRM.BQBR',
'SE.PRM.BIMP',
'SE.PRM.BMAC',
'SE.PRM.BNLG',
'SE.PRM.BFIN'
)
country_tab_fn(politics_indicators, 'GEPD Politics Indicators')
```


```{r bur_dat}

bur_indicators <- c(
   #"responsible_finance_planning"   ,      
         #"responsible_hiring_teachers"       ,   
         #"responsible_monitoring_performance"   ,
         #"responsible_none"                   , 
         #"education"                           ,
         "gender"                               ,
         #"director_hr"    ,
         "national_learning_goals",              
         "targeting"               ,            
         "monitoring"               ,       
         "incentives"                ,     
         "community_engagement"       ,      
         "mandates_accountability"     ,      
         "coherence"     ,
         "transparency"   ,               
         "accountability"  ,              
         "quality_bureaucracy",           
         "knowledge_skills"    ,           
         "work_environment"     ,               
         "merit"                 ,          
         "motivation_attitudes"   ,          
         "impartial_decision_making",        
         "politicized_personnel_management", 
         "politicized_policy_making"        ,   
         "politicized_policy_implementation" ,   
         "employee_unions_as_facilitators"    , 
         "avg_class_size_guess"                ,
         "avg_absence_guess"                   ,
         "motivation_relative_start"           
         #"proportion_reported_underperformance",
         #"proportion_broke_rules"            ,
         #"proportion_contracts_political"     , 
         #"proportion_producement_political" 
)


########
# Peru
#######
#read in anonymized school data
country <- "PER"
year <- "2019"
PER_bur_df <- haven::read_dta(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/Public_Officials/data/public_officials_dta_clean_anon.dta", sep="/")) %>%
  mutate(iso3c=country) %>%
  select(iso3c,govt_tier, bur_indicators) %>%
  mutate(govt_tier=factor(govt_tier, levels=c(1,2,3), labels=c("Ministry of Education (or equivalent)","Regional office (or equivalent)", "District office (or equivalent)" )))

########
# Jordan
#######
#read in anonymized school data
country <- "JOR"
year <- "2019"
JOR_bur_df <- haven::read_dta(file=paste(anonymized_dir,"CNT", paste0(country,"-19"),paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/Public_Officials/data/public_officials_dta_clean_anon.dta", sep="/")) %>%
  mutate(iso3c=country) %>%
  select(iso3c,govt_tier, bur_indicators) %>%
  mutate(govt_tier=factor(govt_tier, levels=c(1,2,3), labels=c("Ministry of Education (or equivalent)","Regional office (or equivalent)", "District office (or equivalent)" )))
########
# Rwanda
#######
#read in anonymized school data
country <- "RWA"
year <- "2020"
RWA_bur_df <- haven::read_dta(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/Public_Officials/data/public_officials_dta_clean_anon.dta", sep="/")) %>%
  mutate(iso3c=country) %>%
  select(iso3c,govt_tier, bur_indicators) %>%
  mutate(govt_tier=factor(govt_tier, levels=c(1,2,3), labels=c("Ministry of Education (or equivalent)","Regional office (or equivalent)", "District office (or equivalent)" )))
########
# Ethiopia
#######
#read in anonymized school data
country <- "ETH"
year <- "2020_2021"
ETH_bur_df <- read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/Public_Officials/data/public_officials_dta_clean_anon.csv", sep="/")) %>%
  mutate(iso3c=country) %>%
  select(iso3c, govt_tier, bur_indicators) %>%
  mutate(govt_tier=factor(govt_tier,  levels=c("Ministry of Education (or equivalent)","Regional office (or equivalent)", "District office (or equivalent)" )))

########
# Madagascar
#######
#read in anonymized school data
country <- "MDG"
year <- "2021"
MDG_bur_df <- read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/Public_Officials/data/public_officials_dta_clean_anon.csv", sep="/")) %>%
  mutate(iso3c=country) %>%
  select(iso3c,govt_tier, bur_indicators) %>%
  mutate(govt_tier=factor(govt_tier, levels=c("Ministry of Education (or equivalent)","Regional office (or equivalent)", "District office (or equivalent)" )))
########
#combined
########
combined_bur_df <- bind_rows(PER_bur_df, JOR_bur_df, RWA_bur_df, ETH_bur_df, MDG_bur_df) %>%
  mutate(iso3c=factor(iso3c, levels=c("MDG", "ETH", "RWA", "JOR", "PER")))


combined_bur_df %>%
  rename(pol_policy_implementation=politicized_policy_implementation) %>%
  haven::write_dta(  paste0(confidential_dir, "General/combined_public_officials.dta")) %>%
  haven::write_dta(  paste0(shared_loc, "/Data/combined_public_officials.dta"))
```


The figure below breaks up these scores further by looking at the tier of government (Central, Regional, or District level).  On average across countries there is not a large difference between tiers for the politics indicators.  For instance, for Characteristics of the Bureaucracy, the average across Peru, Jordan, Rwanda, and Ethiopia is 4.0 at the ministry level, 3.8 at the regional level, and 4.1 at the district level.  However, this hides sometimes large variation at the country level between tiers.  In Jordan, the Characteristics of the Bureaucracy at the ministry level and district level is around 3.6, but only 3.1 at the regional level, suggesting significantly weaker performance at the regional level.  For Impartial Decision making, district offices (3.6) tend to perform slightly better than at the ministry and regional level (3.2, 3.3), but in Rwanda the scores are 3.4 for ministry level, 4.0 for the regional level, and 4.3 at the district level, suggesting impartial decision making improves at more localized levels of government.  In Jordan, impartial decision making is best at the ministry level, so the country context is important for drawing conclusions about the performance of the bureuacracy at different levels.

```{r buranalysis, fig.width=8, fig.height=6}

mn_bur <- combined_bur_df %>%
  group_by(iso3c, govt_tier) %>%
  summarise(across(c('quality_bureaucracy', 'mandates_accountability', 'impartial_decision_making', 'national_learning_goals'), mean, na.rm=TRUE)) %>%
  filter(!is.na(govt_tier)) %>%
  pivot_longer(
    cols=c('quality_bureaucracy', 'mandates_accountability', 'impartial_decision_making', 'national_learning_goals'),
    names_to='indicator',
    values_to='value'
  ) %>%
  mutate(Indicator=case_when(
    indicator=="quality_bureaucracy" ~ 'Characteristics of Bureaucracy',
    indicator=="mandates_accountability" ~ 'Mandates and Accountability',
    indicator=="impartial_decision_making" ~ "Impartial Decision Making",
    indicator=="national_learning_goals" ~ 'National Learning Goals'
  ),
  Country=iso3c,
  govt_tier=str_wrap(govt_tier,20))

mn_bur_ovrl <- combined_bur_df %>%
  group_by(iso3c, govt_tier) %>%
  summarise(across(c('quality_bureaucracy', 'mandates_accountability', 'impartial_decision_making', 'national_learning_goals'), mean, na.rm=TRUE)) %>%  
  group_by(govt_tier) %>%
  summarise(across(c('quality_bureaucracy', 'mandates_accountability', 'impartial_decision_making', 'national_learning_goals'), mean, na.rm=TRUE)) %>%
  filter(!is.na(govt_tier)) %>%
  pivot_longer(
    cols=c('quality_bureaucracy', 'mandates_accountability', 'impartial_decision_making', 'national_learning_goals'),
    names_to='indicator',
    values_to='value'
  ) %>%
  mutate(Indicator=case_when(
    indicator=="quality_bureaucracy" ~ 'Characteristics of Bureaucracy',
    indicator=="mandates_accountability" ~ 'Mandates and Accountability',
    indicator=="impartial_decision_making" ~ "Impartial Decision Making",
    indicator=="national_learning_goals" ~ 'National Learning Goals'
  ),
  Country='Average',
  govt_tier=str_wrap(govt_tier,20))

ggplot(mn_bur, aes(x=govt_tier, y=value, color=Country)) +
  facet_wrap(~Indicator) +
  geom_text(aes(label=Country)) +
  geom_segment(data=mn_bur_ovrl, aes(xend=(..x..-.15), y=value, yend=value), color='black') +
  geom_segment(data=mn_bur_ovrl, aes(xend=(..x..+.15), y=value, yend=value), color='black') +
  theme_bw() +
  scale_x_discrete(limits=c(str_wrap("Ministry of Education (or equivalent)",20),str_wrap("Regional office (or equivalent)",20), str_wrap("District office (or equivalent)",20))) +
  xlab("Government Tier") +
  expand_limits(y=c(1,5)) +
  theme(legend.position="none") +
  labs(
    title='GEPD Politics Scores by Government Tier',
    notes='Solid black line is the unweighted average across countries'
  )

```


## Systems View of Indicators
```{r}
# read in the microdata
########
## Peru
########
#read in anonymized school data
country <- "PER"
year <- "2019"
confidential_folder <- file.path(paste(confidential_dir,"CNT",country,paste(country,year,"GEPD", sep="_"),paste(country,year,"GEPD_v01_RAW", sep="_"),"Data/confidential/", sep="/"))
PER_school_anon_df <- read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/school_dta_short_anon.csv", sep="/"))
PER_school_office_linkages <- read_csv(file=paste0(confidential_folder, "/School/linked_po_school_data_",country,".csv"))
#load gdp info
PER_school_gdp <-read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/school_gdp_anon.csv", sep="/"))
PER_school_size <-read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/school_dta_anon.csv", sep="/")) %>%
  select(hashed_school_code, students_enrolled) %>%
  filter(!is.na(students_enrolled))
PER_school_office_link_df <- PER_school_anon_df %>%
  left_join(PER_school_gdp) %>%
  left_join(PER_school_office_linkages) %>%
  left_join(PER_school_size) %>%
  mutate(country="Peru") %>%
  mutate(dist=distHaversine(.[,c('school_lon', 'school_lat')], .[c('office_lon', 'office_lat')]),
         dist_km=dist/1000,
         dist_log=log(dist_km),
         bureau_index=(quality_bureaucracy + national_learning_goals + impartial_decision_making + mandates_accountability )/4,
         # rural2=if_else(urban_rural=="Rural",1,0),
         # rural=if_else(is.na(rural),rural2,rural ),
         students_enrolled=case_when(
           students_enrolled=="Under 25" ~1, 
           students_enrolled=="25-50" ~2 , 
           students_enrolled=="50-75" ~3, 
           students_enrolled=="75-100" ~4, 
           students_enrolled=="100-150" ~5, 
           students_enrolled=="150-300" ~6, 
           students_enrolled=="300-500" ~7, 
           students_enrolled=="Over 500" ~8),
         students_enrolled=factor(students_enrolled, 
                                  levels=c(1:8),
                                  labels= c("Under 25", "25-50", "50-75", "75-100", "100-150", "150-300", "300-500", "Over 500"))) 
########
########
## Jordan
########
#read in anonymized school data
country <- "JOR"
year <- "2019"
confidential_folder <- file.path(paste(confidential_dir,"CNT",country,paste(country,year,"GEPD", sep="_"),paste(country,year,"GEPD_v01_RAW", sep="_"),"Data/confidential/", sep="/"))
JOR_school_anon_df <- haven::read_dta(file=paste(anonymized_dir,"CNT", 'JOR-19',paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/school_dta_short_anon.dta", sep="/"))
JOR_school_office_linkages <- read_csv(file=paste0(confidential_folder, "/School/linked_po_school_data_",country,".csv"))
#load gdp info
JOR_school_gdp <-haven::read_dta(file=paste(anonymized_dir,"CNT", 'JOR-19',paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/school_gdp_anon.dta", sep="/")) %>%
  select(hashed_school_code, GDP)
#load school size info
JOR_school_size <-haven::read_dta(file=paste(anonymized_dir,"CNT", 'JOR-19',paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/school_dta_anon.dta", sep="/")) %>%
  select(hashed_school_code, students_enrolled) %>%
  mutate(students_enrolled=factor(students_enrolled, levels=c(1,2,3,4,5,6,7,8), labels = c("Under 25", "25-50", "50-75", "75-100", "100-150", "150-300", "300-500", "Over 500")),
         students_enrolled=as.character(students_enrolled)) %>%
  filter(!is.na(students_enrolled))
JOR_school_office_link_df <- JOR_school_anon_df %>%
  left_join(JOR_school_gdp) %>%
  left_join(JOR_school_office_linkages) %>%
  left_join(JOR_school_size) %>%
  mutate(country="Jordan") %>%
  mutate(dist=distHaversine(.[,c('school_lon', 'school_lat')], .[c('office_lon', 'office_lat')]),
         dist_km=dist/1000,
         dist_log=log(dist_km),
         rural=if_else(rural==1, TRUE,FALSE),
         bureau_index=(quality_bureaucracy + national_learning_goals + impartial_decision_making + mandates_accountability )/4,
         # rural2=if_else(urban_rural=="Rural",1,0),
         # rural=if_else(is.na(rural),rural2,rural ),
         students_enrolled=case_when(
           students_enrolled=="Under 25" ~1, 
           students_enrolled=="25-50" ~2 , 
           students_enrolled=="50-75" ~3, 
           students_enrolled=="75-100" ~4, 
           students_enrolled=="100-150" ~5, 
           students_enrolled=="150-300" ~6, 
           students_enrolled=="300-500" ~7, 
           students_enrolled=="Over 500" ~8),
         students_enrolled=factor(students_enrolled, 
                                  levels=c(1:8),
                                  labels= c("Under 25", "25-50", "50-75", "75-100", "100-150", "150-300", "300-500", "Over 500"))) 
########
########
## Rwanda
########
#read in anonymized school data
country <- "RWA"
year <- "2020"
confidential_folder <- file.path(paste(confidential_dir,"CNT",country,paste(country,year,"GEPD", sep="_"),paste(country,year,"GEPD_v01_RAW", sep="_"),"Data/confidential/", sep="/"))
RWA_school_anon_df <- read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/school_dta_short_anon.csv", sep="/"))
RWA_school_office_linkages <- read_csv(file=paste0(confidential_folder, "/School/linked_po_school_data_",country,".csv"))
#load gdp info
RWA_school_gdp <-read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/school_gdp_anon.csv", sep="/"))
#load school size info
RWA_school_size <-read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/school_dta_anon.csv", sep="/")) %>%
  select(hashed_school_code, students_enrolled) %>%
  filter(!is.na(students_enrolled))
RWA_school_office_link_df <- RWA_school_anon_df %>%
  left_join(RWA_school_gdp) %>%
  left_join(RWA_school_office_linkages) %>%
  left_join(RWA_school_size) %>%
  mutate(country="Rwanda") %>%
  mutate(dist=distHaversine(.[,c('school_lon', 'school_lat')], .[c('office_lon', 'office_lat')]),
         dist_km=dist/1000,
         dist_log=log(dist_km),
         bureau_index=(quality_bureaucracy + national_learning_goals + impartial_decision_making + mandates_accountability )/4,
         # rural2=if_else(urban_rural=="Rural",1,0),
         # rural=if_else(is.na(rural),rural2,rural ),
         students_enrolled=case_when(
           students_enrolled=="Under 25" ~1, 
           students_enrolled=="25-50" ~2 , 
           students_enrolled=="50-75" ~3, 
           students_enrolled=="75-100" ~4, 
           students_enrolled=="100-150" ~5, 
           students_enrolled=="150-300" ~6, 
           students_enrolled=="300-500" ~7, 
           students_enrolled=="Over 500" ~8),
         students_enrolled=factor(students_enrolled, 
                                  levels=c(1:8),
                                  labels= c("Under 25", "25-50", "50-75", "75-100", "100-150", "150-300", "300-500", "Over 500"))) 
########
########
########
## Ethiopia
########
#read in anonymized school data
country <- "ETH"
year <- "2020_2021"
confidential_folder <- file.path(paste(confidential_dir,"CNT",country,paste(country,year,"GEPD", sep="_"),paste(country,year,"GEPD_v01_RAW", sep="_"),"Data/confidential/", sep="/"))
ETH_school_anon_df <- read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/school_dta_short_anon.csv", sep="/"))
ETH_school_office_linkages <- read_csv(file=paste0(confidential_folder, "/School/linked_po_school_data_",country,".csv"))
#load gdp info
ETH_school_gdp <-read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/school_gdp_anon.csv", sep="/"))
#load school size info
ETH_school_size <-read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/school_dta_anon.csv", sep="/")) %>%
  select(hashed_school_code, students_enrolled) %>%
  filter(!is.na(students_enrolled))
ETH_school_office_link_df <- ETH_school_anon_df %>%
  left_join(ETH_school_gdp) %>%
  left_join(ETH_school_office_linkages) %>%
  left_join(ETH_school_size) %>%
  mutate(country="Ethiopia")  %>%
  mutate(dist=distHaversine(.[,c('school_lon', 'school_lat')], .[c('office_lon', 'office_lat')]),
         dist_km=dist/1000,
         dist_log=log(dist_km),
         bureau_index=(quality_bureaucracy + national_learning_goals + impartial_decision_making + mandates_accountability )/4,
         rural=if_else(urban_rural=="Rural",TRUE,FALSE),
         students_enrolled=case_when(
           students_enrolled=="Under 25" ~1, 
           students_enrolled=="25-50" ~2 , 
           students_enrolled=="50-75" ~3, 
           students_enrolled=="75-100" ~4, 
           students_enrolled=="100-150" ~5, 
           students_enrolled=="150-300" ~6, 
           students_enrolled=="300-500" ~7, 
           students_enrolled=="Over 500" ~8),
         students_enrolled=factor(students_enrolled, 
                                  levels=c(1:8),
                                  labels= c("Under 25", "25-50", "50-75", "75-100", "100-150", "150-300", "300-500", "Over 500"))) 
########
########
## Madagascar
########
#read in anonymized school data
country <- "MDG"
year <- "2021"
confidential_folder <- file.path(paste(confidential_dir,"CNT",country,paste(country,year,"GEPD", sep="_"),paste(country,year,"GEPD_v01_RAW", sep="_"),"Data/confidential/", sep="/"))
MDG_school_anon_df <- read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/school_dta_short_anon.csv", sep="/"))
MDG_school_office_linkages <- read_csv(file=paste0(confidential_folder, "/School/linked_po_school_data_",country,".csv"))
#load gdp info
MDG_school_gdp <-read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/school_gdp_anon.csv", sep="/"))
MDG_school_office_link_df <- MDG_school_anon_df %>%
  left_join(MDG_school_gdp) %>%
  left_join(MDG_school_office_linkages) %>%  
  select(-district) %>%
  mutate(country="Madagascar") %>%
  mutate(
    presence_rate=100-absence_rate,
    dist=distHaversine(.[,c('school_lon', 'school_lat')], .[c('office_lon', 'office_lat')]),
         dist_km=dist/1000,
         dist_log=log(dist_km),
         bureau_index=(quality_bureaucracy + national_learning_goals + impartial_decision_making + mandates_accountability )/4,
         rural=if_else(urban_rural=="Rural",TRUE,FALSE)
  )



###########
# Combined
##########
combined_school_office_df <- bind_rows(PER_school_office_link_df, JOR_school_office_link_df, RWA_school_office_link_df, ETH_school_office_link_df, MDG_school_office_link_df) 
combined_school_office_df %>%
  rename(pol_policy_implementation=politicized_policy_implementation) %>%
  haven::write_dta( paste0(confidential_dir, "General/combined_school_office_df.dta")) %>%
  haven::write_dta(  paste0(shared_loc, "Data/combined_school_office_df.dta"))
  

```




### Interrelations between Indicators

In the next section provides an examination of how correlated the practice indicators are with one another.  For instance, do schools that perform well along one of the GEPD indicators (for example, school management) tend to perform well along the other indicators?  To examine this, the correlation between the GEPD practice indicators is examined.  Also, principal components  analysis is used to calculate the share of variation between the indicators that can be explained by a single factor, which can provide a sense of how well aligned the various GEPD practice indicators are with each other.


To begin the a correlation plot is produced for each of the GEPD practice indicators.  The correlations are based on school data pooled from Peru, Jordan, Rwanda, Ethiopia, and Madagascar.  





```{r c1}

indicators_list <- c("student_knowledge"="4th Grade Student Knowledge",
               "presence_rate"  = "Teacher Presence",
               "content_knowledge" = "Teacher Content Knowledge",
               "teach_score" = "Teacher Pedagogy",
               "inputs" = "Basic Inputs",
               "infrastructure" = "Basic Infrastructure",
               "ecd_student_knowledge" = "1st Grade Student Knowledge",
               "student_attendance" = "Student Attendance",
               "operational_management" = "Operational Management",
               "instructional_leadership" = "Instructional Leadership",
               "principal_knowledge_score" = "Principal Knowledge",
               "principal_management" = "Principal Management"
               )

#create a function for correlation plots
cor_fun <- function(indicators) {
 
  
    cor_df <- combined_school_office_df %>%
      select(country, rural, names(indicators)) %>%
      group_by(country,rural) %>%
      mutate(across(names(indicators),~if_else(is.na(.),mean(.,na.rm=T),.))) %>%#impute with mean by country and urban/rural
      ungroup() %>%
      select(names(indicators))
    
    res <- rcorr(as.matrix(cor_df)) 
    
    pval <- res$P
    res <- res$r
    
    ## trunctuate the correlation matrix to two decimal
    res <- format(round(cbind(rep(-1.11, ncol(as.matrix(cor_df))), res), 3))[,-1]
    
    mystars <- ifelse(pval < .001, "***", ifelse(pval < .01, "** ", ifelse(pval < .05, "*  ", ifelse(pval < .1, "+   ", "    "))))
    res <- matrix(paste(res, mystars, sep=""), ncol=ncol(as.matrix(cor_df)))
    
    res[upper.tri(res)] <- NA # erase the upper triangle
    diag(res) <- NA     
        
    
    res <- res %>%
      as_tibble() 
    
    colnames(res) <- indicators
    
    res$var <- indicators
    
    
    
    
    ovr_table <- res %>% 
      select(var, everything()) %>%
      flextable() %>%
      bg(j = 2:ncol(res), 
                    bg = function(x){
                      out <- rep("transparent", length(x))
                      out[as.numeric(str_sub(x,1,4)) < 0] <- "#e76f51"
                      out[as.numeric(str_sub(x,1,4)) >= 0 & as.numeric(str_sub(x,1,4)) < 0.2] <- "#f4a261"
                      out[as.numeric(str_sub(x,1,4)) >= 0.2 & as.numeric(str_sub(x,1,4)) < 0.4] <- "#e9c46a"
                      out[as.numeric(str_sub(x,1,4)) >= 0.4 & as.numeric(str_sub(x,1,4)) < 0.6] <- "#2a9d8f"
                      out[as.numeric(str_sub(x,1,4)) >= 0.6 ] <- "#264653"
                      out
                    })
    
  FitFlextableToPage(ovr_table) %>%
  add_footer_lines("*** significant at 0.1% level. 
                   ** significant at 1% level. 
                   * significant at 5% level.  
                   + significant at 10% level.  ") %>%
  set_table_properties(layout = "autofit")

   
}

cor_fun(indicators_list)

```

The strongest correlation is between the availability of basic school inputs and the operational management.  Operational management is measured in the school management module of the School Survey, which is directed to the principal, head teacher, or most senior teacher includes 2 vignettes describing hypothetical scenarios related to (i) infrastructure repair/maintenance, and (ii) school material availability. Other core functions – like teacher hiring, supervision, and training – are being captured through other indicators. Each vignette has 4-6 questions asking how the function would be handle or if handled at all. These school management qualities correlate strongly with the availability of school inputs.  

This correlation holds up after accounting for country fixed effects, the urban/rural status of the school, school size, and the GDP within 1 square kilometer of the school using OLS regression.^[
Data downloaded from:
https://datacatalog.worldbank.org/dataset/gross-domestic-product-2010 also see
https://preview.grid.unep.ch/index.php?preview=data&events=socec&evcat=1&lang=eng
 In the distributed global GDP dataset sub-national GRP and national GDP data are allocated to 
 30 arc second (approximately 1km) grid cells in proportion to the population residing in that cell. 
 The method also distinguishes between rural and urban population, assuming the latter to have a higher 
 GDP per capita. Input data are from 1) a global time-series dataset of GDP, with subnational gross regional 
 product (GRP) for 74 countries, compiled by the World Bank Development Economics Research Group (DECRG). 2) 
 Gridded population projections for the year 2009, based on a population grid for the year 2005 provided by 
 LandScanTM Global Population Database (Oak Ridge, TN: Oak Ridge National Laboratory). This dataset has been 
 extrapolated to year 2010 by UNEP/GRID-Geneva. Unit is estimated value of production per cell, in thousand of 
 constant 2000 USD. Cell level anomalies may occur due to poor alignment of multiple input data sources, and it 
 is strongly recommended that users attempt to verify information, or consult original sources, in order to determine 
 suitability for a particular application. This product was compiled by DECRG for the Global Assessment Report on Risk 
 Reduction (GAR). It was modeled using global data. Credit: GIS processing World Bank DECRG, Washington, DC, 
 extrapolation UNEP/GRID-Geneva.].  The regression estimates suggest that a 1 point increase in a schools operational management score (scale 1-5) is associated with a 0.2 point increase on the availability of basic inputs score (scale 0-5).  This relationship appears strongest for the availability of textbooks with a 1 point increase in the operational management score associated with a 12 percentage point increase in the availability of textbooks.  There is a statistically significant relationship with the availability of internet connected technology (ICT) as well.
 
 

```{r}
models <- list(
  
'Availability of Basic Inputs' = feols(inputs ~   operational_management   + log(GDP) + rural + students_enrolled | country, data=combined_school_office_df, se='hetero'),

'Availability of Functional Blackboard' = feols(blackboard_functional ~   operational_management   + log(GDP) + rural + students_enrolled | country, data=combined_school_office_df, se='hetero'),

'Availability of Writing Utencils' = feols(pens_etc ~   operational_management   + log(GDP) + rural + students_enrolled | country, data=combined_school_office_df, se='hetero'),

'Availability of Textbooks' = feols(textbooks ~   operational_management   + log(GDP) + rural + students_enrolled | country, data=combined_school_office_df, se='hetero'),

'Availability of Desks' = feols(share_desk ~   operational_management   + log(GDP) + rural + students_enrolled | country, data=combined_school_office_df, se='hetero'),

'Availability of ICT' = feols(access_ict ~   operational_management   + log(GDP) + rural + students_enrolled | country, data=combined_school_office_df, se='hetero')

)



modelsummary(models,
             estimate= "{estimate}{stars}",
             coef_rename = c("presence_rate"  = "Teacher Presence",
                             "content_knowledge" = "Teacher Content Knowledge",
                             "teach_score" = "Teacher Pedagogy",
                             "inputs" = "Basic Inputs",
                             "infrastructure" = "Basic Infrastructure",
                             "ecd_student_knowledge" = "1st Grade Student Knowledge",
                             "student_attendance" = "Student Attendance",
                             "operational_management" = "Operational Management",
                             "instructional_leadership" = "Instructional Leadership",
                             "principal_knowledge_score" = "Principal Knowledge",
                             "principal_management" = "Principal Management"),
             coef_omit="GDP|rural|students_enrolled",
             gof_map = gm,
             notes="Regressions also include country fixed effects, the log GDP within 1km of school, urban rural status, and total school enrollment as covariates.",
             escape = FALSE
             )
```

Their is also a statistically significant relationship between operational management and the availability of infrastructure.  A 1 point increase in the school's operational management score is associated with a 0.33 point increase in the availability of infrastructure.  This relationship is statistically significant for the availability of drinking water, functional toilets, electricity in the classroom and the availability of internet connectivity at the school as well. 


```{r}
models <- list(
  
'Availability of Basic Infrastructure' = feols(infrastructure ~   operational_management   + log(GDP) + rural + students_enrolled | country, data=combined_school_office_df, se='hetero'),

'Availability of Drinking Water' = feols(drinking_water ~   operational_management   + log(GDP) + rural + students_enrolled | country, data=combined_school_office_df, se='hetero'),

'Availability of Functional Toilet' = feols(functioning_toilet ~   operational_management   + log(GDP) + rural + students_enrolled | country, data=combined_school_office_df, se='hetero'),

'Availability of internet' = feols(internet ~   operational_management   + log(GDP) + rural + students_enrolled | country, data=combined_school_office_df, se='hetero'),

'Availability of Electricity' = feols(class_electricity ~   operational_management   + log(GDP) + rural + students_enrolled | country, data=combined_school_office_df, se='hetero'),

'Access for the Disabled' = feols(disability_accessibility ~   operational_management   + log(GDP) + rural + students_enrolled | country, data=combined_school_office_df, se='hetero')

)



modelsummary(models,
             estimate= "{estimate}{stars}",
             coef_rename = c("presence_rate"  = "Teacher Presence",
                             "content_knowledge" = "Teacher Content Knowledge",
                             "teach_score" = "Teacher Pedagogy",
                             "inputs" = "Basic Inputs",
                             "infrastructure" = "Basic Infrastructure",
                             "ecd_student_knowledge" = "1st Grade Student Knowledge",
                             "student_attendance" = "Student Attendance",
                             "operational_management" = "Operational Management",
                             "instructional_leadership" = "Instructional Leadership",
                             "principal_knowledge_score" = "Principal Knowledge",
                             "principal_management" = "Principal Management"),
             coef_omit="GDP|rural|students_enrolled",
             gof_map = gm,
             notes="Regressions also include country fixed effects, the log GDP within 1km of school, urban rural status, and total school enrollment as covariates.",
             escape = FALSE             
             )
```


Next, principal components analysis is used to examine how much a single factor can explain variation between the indicators.  This can tell us the extent that schools that perform well in one dimension tend to perform well in all dimensions.  In the case that the first principal component explains a very large share of the variation between indicators, this will be true.  If the variation explained by the first principal component is low, then schools that tend to do well in one indicator may not be tending to do well in all areas.

The scree plot below suggests that the 1st principal component explains a little over 25% of the variation between practice indicators.  This suggests that the large majority of variation in the practice indicators cannot be explained by a single factor and that there are many cases where schools performing well in one dimension may perform less well in others.

```{r}
indicators_list <- c("student_knowledge"="4th Grade Student Knowledge",
               "presence_rate"  = "Teacher Presence",
               "content_knowledge" = "Teacher Content Knowledge",
               "teach_score" = "Teacher Pedagogy",
               "inputs" = "Basic Inputs",
               "infrastructure" = "Basic Infrastructure",
               "ecd_student_knowledge" = "1st Grade Student Knowledge",
               "student_attendance" = "Student Attendance",
               "operational_management" = "Operational Management",
               "instructional_leadership" = "Instructional Leadership",
               "principal_knowledge_score" = "Principal Knowledge",
               "principal_management" = "Principal Management"
               )

    cor_df <- combined_school_office_df %>%
      select(country, rural, names(indicators_list)) %>%
      group_by(country,rural) %>%
      mutate(across(names(indicators_list),~if_else(is.na(.),mean(.,na.rm=T),.))) %>%#impute with mean by country and urban/rural
      ungroup() %>%
      select(names(indicators_list))


pca_df <- na.omit(cor_df)

res.pca <- prcomp(pca_df, scale = TRUE, center=TRUE)

fviz_eig(res.pca) +
  expand_limits(y=c(0,100)) +
  ggtitle("Scree plot using data from All Countries")

```


```{r}

indicators_list <- c("student_knowledge"="4th Grade Student Knowledge",
               "presence_rate"  = "Teacher Presence",
               "content_knowledge" = "Teacher Content Knowledge",
               "teach_score" = "Teacher Pedagogy",
               "inputs" = "Basic Inputs",
               "infrastructure" = "Basic Infrastructure",
               "ecd_student_knowledge" = "1st Grade Student Knowledge",
               "student_attendance" = "Student Attendance",
               "operational_management" = "Operational Management",
               "instructional_leadership" = "Instructional Leadership",
               "principal_knowledge_score" = "Principal Knowledge",
               "principal_management" = "Principal Management"
               )

indicators_list2 <- c("student_knowledge"="4th Grade Student Knowledge",
               "presence_rate"  = "Teacher Presence",
               "content_knowledge" = "Teacher Content Knowledge",
#               "teach_score" = "Teacher Pedagogy",
               "inputs" = "Basic Inputs",
               "infrastructure" = "Basic Infrastructure",
               "ecd_student_knowledge" = "1st Grade Student Knowledge",
               "operational_management" = "Operational Management",
               "instructional_leadership" = "Instructional Leadership",
               "principal_knowledge_score" = "Principal Knowledge",
               "principal_management" = "Principal Management"
               )

scree_fun <- function(cntry, indicators) {
  
     cor_df <- combined_school_office_df %>%
      filter(country==cntry) %>%
      select(country, rural, names(indicators)) %>%
      group_by(country,rural) %>%
      mutate(across(names(indicators),~if_else(is.na(.),mean(.,na.rm=T),.))) %>%#impute with mean by country and urban/rural
      ungroup() %>%
      select(names(indicators))


pca_df <- na.omit(cor_df)

res.pca <- prcomp(pca_df, scale = TRUE, center=TRUE)

fviz_eig(res.pca) +
  expand_limits(y=c(0,100)) +
  ggtitle(paste0("Scree plot using data from ",cntry))

  
}

p1 <- scree_fun("Peru", indicators_list) 
p2 <- scree_fun("Jordan", indicators_list) 
p3 <- scree_fun("Rwanda", indicators_list) 
p4 <- scree_fun("Ethiopia", indicators_list) 
p5 <- scree_fun("Madagascar", indicators_list2) 

(p1 + p2 + p3)/(p4 + p5)


```


### Learning

The next section highlights the crisis in learning taking place in classrooms as measured by the GEPD 4th grade assessment and highlights the relationships between the practices taking place in the school and student learning.

In the GEPD 4th grade assessment, students in a randomly chosen class were given an assessment containing math and language items. More details on this examination is in the GEPD Technical Note.  A students score is the sum of the literacy sub-score and the math sub-score.  Proficiency is then based on whether the student correctly answered a set number of questions (20/24 items correct in literacy, 14/17 in math), which was determined by consulting a set of experts on whether a minimally proficient 4th grader should be able to answer the questions correctly.  

The table above highlights the low levels of learning seen in children in 4th grade in even middle income countries, such as Peru and Jordan.  In Peru, only around 33% of students reached the proficiency threshold on the 4th grade assessment.  In Jordan, the number is even lower, although schools in Jordan had recently switched to using Arabic numerals, and the children performed particularly badly in the math portion of the GEPD assessment. The low income countries (Rwanda, Ethiopia, and Madagascar) fare even worse with less than 5% of students being considered proficient. 
```{r g4dat}
########
# Peru
#######
#read in anonymized school data
country <- "PER"
year <- "2019"
PER_g4_df <- read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/assess_4th_grade_anon_anon.csv", sep="/")) %>%
  mutate(iso3c=country) %>%
   mutate(student_proficient=100*as.numeric(student_knowledge>=86.6), #26/30
         student_proficient_70=100*as.numeric(student_knowledge>=70),
         student_proficient_75=100*as.numeric(student_knowledge>=75),
         literacy_student_proficient=100*as.numeric(literacy_student_knowledge>=92), #12/13 points
         literacy_student_proficient_70=100*as.numeric(literacy_student_knowledge>=70),
         literacy_student_proficient_75=100*as.numeric(literacy_student_knowledge>=75),
         math_student_proficient=100*as.numeric(math_student_knowledge>=82), #14/17 points
         math_student_proficient_70=100*as.numeric(math_student_knowledge>=70),
         math_student_proficient_75=100*as.numeric(math_student_knowledge>=75),
         math_student_proficient_60=100*as.numeric(math_student_knowledge>=60))
########
# Jordan
#######
#read in anonymized school data
country <- "JOR"
year <- "2019"
JOR_g4_df <- haven::read_dta(file=paste(anonymized_dir,"CNT", 'JOR-19',paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/assess_4th_grade_anon_anon.dta", sep="/")) %>%
  mutate(iso3c=country)
########
# Rwanda
#######
#read in anonymized school data
country <- "RWA"
year <- "2020"
RWA_g4_df <- read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/assess_4th_grade_anon_anon.csv", sep="/")) %>%
  mutate(iso3c=country)
########
# Ethiopia
#######
#read in anonymized school data
country <- "ETH"
year <- "2020_2021"
ETH_g4_df_2020 <- read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/assess_4th_grade_anon_2020.csv", sep="/")) %>%
  mutate(iso3c=country)
ETH_g4_df_2021 <- read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/assess_4th_grade_anon_2021.csv", sep="/")) %>%
  mutate(iso3c=country)
########
# Madagascar
#######
#read in anonymized school data
country <- "MDG"
year <- "2021"
MDG_g4_df <- read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/assess_4th_grade_anon_anon.csv", sep="/")) %>%
  mutate(iso3c=country) %>%
  select(-district)
########
#combined
########
combined_g4_df <- bind_rows(PER_g4_df, JOR_g4_df, RWA_g4_df, ETH_g4_df_2020, ETH_g4_df_2021, MDG_g4_df) %>%
  mutate(iso3c=factor(iso3c, levels=c("MDG", "ETH", "RWA", "JOR", "PER")),
         `Student Proficient`=if_else(student_proficient==100,"Yes", "No"),
         `Student Proficient Math`=if_else(math_student_proficient==100,"Yes", "No"),
         `Student Proficient Literacy`=if_else(literacy_student_proficient==100,"Yes", "No"))
weights_df <- combined_g4_df %>%
  group_by(iso3c, hashed_school_code) %>%
  summarise(ipw=mean(ipw, na.rm=T))


combined_g4_df %>%
  select(-contains('nogiraffe'), -`Student Proficient`, -`Student Proficient Math`, -`Student Proficient Literacy`) %>%
  haven::write_dta(  paste0(confidential_dir, "General/combined_g4.dta")) %>%
  haven::write_dta(  paste0(shared_loc, "Data/combined_g4.dta"))

```

In figure XX, the distribution of raw scores are shown for each country.  The raw scores are scaled to be between 0 and 100, where a student receiving 0 points got none of the questions correct, and a student scoring 100 got all of the questions correct. Overall scores combine literacy and math are shown.  Each point on the plot represents one student's set of responses.  Within each country there is a large dispersion of scores with at least some students scoring nearly 0 points out of 100 and at least some students scoring proficient.

```{r}
indicators <- c("student_knowledge", "math_student_knowledge", "literacy_student_knowledge")
combined_g4_mn <- combined_g4_df %>% 
  mutate(m8saq2_id=if_else(m8saq2_id==1,1,0)) %>%
  group_by(iso3c) %>%
  mutate(ipw=if_else(is.na(ipw),mean(ipw, na.rm=T),ipw)) %>%
  summarise(across(indicators, wtd.mean, weights=ipw, na.rm=T)) %>%
  ungroup() 
p1 <- ggplot(combined_g4_df, aes(x=iso3c, y=student_knowledge, color=`Student Proficient`)) +
  geom_quasirandom() +
  geom_segment(data=combined_g4_mn, aes( xend=..x..+.3, yend=..y..), color='black', size=1)  +
  geom_segment(data=combined_g4_mn, aes( xend=..x..-.3, yend=..y..), color='black', size=1)  +
  geom_text(data=combined_g4_mn, aes(label=paste0(round(student_knowledge, 1), "%")), vjust=-4, color='black', size=3) +
  coord_flip() +
  scale_color_manual(
    values=c("#ef476f", "#06d6a0")
  ) +
  theme_bw() +
  xlab("") +
  ylab("GEPD 4th Grade Assessment Score") +
  labs(
    title="Percentage of Items Correct on GEPD 4th Grade Assessment",
    caption="Solid black lines represent country weighted average. \n Summary Statistics Weighted using Inverse Propensity Weights."
  ) +
  theme(
    axis.text = element_text(size=12),
    title=element_text(size=14),
    legend.position = 'bottom'
  )
p1
p2 <- ggplot(combined_g4_df, aes(x=iso3c, y=math_student_knowledge, color=`Student Proficient Math`)) +
  geom_quasirandom() +
  geom_segment(data=combined_g4_mn, aes( xend=..x..+.3, yend=..y..), color='black', size=1)  +
  geom_segment(data=combined_g4_mn, aes( xend=..x..-.3, yend=..y..), color='black', size=1)  +
  geom_text(data=combined_g4_mn, aes(label=paste0(round(math_student_knowledge, 1), "%")), vjust=-4, color='black', size=3) +
  coord_flip() +
  scale_color_manual(
    values=c("#ef476f", "#06d6a0")
  ) +
  theme_bw() +
  xlab("") +
  ylab("GEPD 4th Grade Math Assessment Score") +
  labs(
    title="Percentage of Items Correct on GEPD 4th Grade Math Assessment",
    caption="Solid black lines represent country weighted average. \n Summary Statistics Weighted using Inverse Propensity Weights."
  ) +
  theme(
    axis.text = element_text(size=12),
    title=element_text(size=14),
    legend.position = 'bottom'
  )
p3 <- ggplot(combined_g4_df, aes(x=iso3c, y=literacy_student_knowledge, color=`Student Proficient Literacy`)) +
  geom_quasirandom() +
  geom_segment(data=combined_g4_mn, aes( xend=..x..+.3, yend=..y..), color='black', size=1)  +
  geom_segment(data=combined_g4_mn, aes( xend=..x..-.3, yend=..y..), color='black', size=1)  +
  geom_text(data=combined_g4_mn, aes(label=paste0(round(literacy_student_knowledge, 1), "%")), vjust=-4, color='black', size=3) +
  coord_flip() +
  scale_color_manual(
    values=c("#ef476f", "#06d6a0")
  ) +
  theme_bw() +
  xlab("") +
  ylab("GEPD 4th Grade Literacy Assessment Score") +
  labs(
    title="Percentage of Items Correct on GEPD 4th Grade Literacy Assessment",
    caption="Solid black lines represent country weighted average. \n Summary Statistics Weighted using Inverse Propensity Weights."
  ) +
  theme(
    axis.text = element_text(size=12),
    title=element_text(size=14),
    legend.position = 'bottom'
  )
```

```{r g4_gender}

indicators <- c("student_knowledge", "math_student_knowledge", "literacy_student_knowledge")
combined_g4_gend_mn <- combined_g4_df %>% 
  mutate(gender=if_else(student_male==1, "Male", "Female")) %>%
  filter(!is.na(gender)) %>%
  group_by(iso3c, gender) %>%
  mutate(ipw=if_else(is.na(ipw),mean(ipw, na.rm=T),ipw)) %>%
  summarise(across(indicators, wtd.mean, weights=ipw, na.rm=T)) %>%
  ungroup() 

p1 <- combined_g4_df %>%
  mutate(gender=if_else(student_male==1, "Male", "Female")) %>%
  filter(!is.na(gender)) %>%
  ggplot( aes(x=gender, y=student_knowledge, color=`Student Proficient`)) +
    facet_wrap(~iso3c) +
    geom_quasirandom() +
    geom_segment(data=combined_g4_gend_mn, aes( xend=..x..+.3, yend=..y..), color='black', size=1)  +
    geom_segment(data=combined_g4_gend_mn, aes( xend=..x..-.3, yend=..y..), color='black', size=1)  +
    geom_text(data=combined_g4_gend_mn, aes(label=paste0(round(student_knowledge, 1), "%")), hjust=-.15, color='black', size=3) +
    coord_flip() +
    scale_color_manual(
      values=c("#ef476f", "#06d6a0")
    ) +
    theme_bw() +
    xlab("") +
    ylab("GEPD 4th Grade Assessment Score") +
    labs(
      title="Percentage of Items Correct on GEPD 4th Grade Assessment by Gender",
      caption="Solid black lines represent country weighted average. \n Summary Statistics Weighted using Inverse Propensity Weights."
    ) +
    theme(
      axis.text = element_text(size=12),
      title=element_text(size=14),
      legend.position = 'bottom'
    )
p1

```


Figure XX below breaks down the 4th Grade Learning Assessment scores further highlighting four items that were on the assessment: whether the student can identify 3 words from a list (e.g. respect, green, bananas), whether the student can answer a question about a short paragraph of text, whether the student can answer correctly 8+7, and whether the student can correctly answer 7x8.  In Madagascar, the percentage of children able to identify three short words was only 63.2%.  The percentage able to solve 7x8 in Madagascar was only 26.7%, while in Peru, the best performing country, the rate was only around 73%.  




```{r}
indicators <- c("m8saq3_id", "m8saq5_story", "m8sbq3a_arithmetic", "m8sbq3f_arithmetic")
indicator_desc <- c("Identify Three Words", "Answer Story Question", "8+7", "7x8")
combined_g4_mn <- combined_g4_df %>% 
  mutate(m8saq2_id=if_else(m8saq3_id==1,1,0)) %>%
  group_by(iso3c) %>%
  mutate(ipw=if_else(is.na(ipw),mean(ipw, na.rm=T),ipw)) %>%
  summarise(across(indicators, wtd.mean, weights=ipw, na.rm=T)) %>%
  ungroup() 
colnames(combined_g4_mn) <- c('country', indicator_desc)
combined_g4_mn <- combined_g4_mn %>%
  pivot_longer(
    cols = c(2:5),
    names_to='Item',
    values_to="Mean"
  )
ggplot(combined_g4_mn, aes(x=Item, y=Mean, color=country, shape=country)) +
  geom_point(size=3) +
  geom_text_repel(aes(label=paste0(country,": ",round(100*Mean, 1), "%")), size=5) +
  expand_limits(y=c(0,1)) +
  scale_y_continuous(
    labels=scales::percent
  ) +
  coord_flip() +
  theme_bw() +
  labs(
    title="Country Performance on Select 4th Grade Items",
    caption="Summary Statistics Weighted using Inverse Propensity Weights."
  ) +
  theme(
    axis.text = element_text(size=12),
    title=element_text(size=14),
    legend.position = 'none'
  )
  
```


```{r eval=FALSE, include=FALSE}
### Calling data 
 
 ########
 # Peru
 #######
 #read in anonymized school data
 country <- "PER"
 year <- "2019"
 PER_g4_df <- read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/assess_4th_grade_anon_anon.csv", sep="/")) %>%
   mutate(iso3c=country) %>%
   mutate(student_proficient=100*as.numeric(student_knowledge>=86.6), #26/30
          student_proficient_70=100*as.numeric(student_knowledge>=70),
          student_proficient_75=100*as.numeric(student_knowledge>=75),
          literacy_student_proficient=100*as.numeric(literacy_student_knowledge>=92), #12/13 points
          literacy_student_proficient_70=100*as.numeric(literacy_student_knowledge>=70),
          literacy_student_proficient_75=100*as.numeric(literacy_student_knowledge>=75),
          math_student_proficient=100*as.numeric(math_student_knowledge>=82), #14/17 points
          math_student_proficient_70=100*as.numeric(math_student_knowledge>=70),
          math_student_proficient_75=100*as.numeric(math_student_knowledge>=75),
          math_student_proficient_60=100*as.numeric(math_student_knowledge>=60))
 ########
 # Jordan
 #######
 #read in anonymized school data
 country <- "JOR"
 year <- "2019"
 JOR_g4_df <- haven::read_dta(file=paste(anonymized_dir,"CNT", 'JOR-19',paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/assess_4th_grade_anon_anon.dta", sep="/")) %>%
   mutate(iso3c=country)
 ########
 # Rwanda
 #######
 #read in anonymized school data
 country <- "RWA"
 year <- "2020"
 RWA_g4_df <- read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/assess_4th_grade_anon_anon.csv", sep="/")) %>%
   mutate(iso3c=country)
 ########
 # Ethiopia
 #######
 #read in anonymized school data
 country <- "ETH"
 year <- "2020_2021"
 ETH_g4_df_2020 <- read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/assess_4th_grade_anon_2020.csv", sep="/")) %>%
   mutate(iso3c=country)
 ETH_g4_df_2021 <- read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/assess_4th_grade_anon_2021.csv", sep="/")) %>%
   mutate(iso3c=country)
 ########
 # Madagascar
 #######
 #read in anonymized school data
 country <- "MDG"
 year <- "2021"
 MDG_g4_df <- read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/assess_4th_grade_anon_anon.csv", sep="/")) %>%
   mutate(iso3c=country) %>%
   select(-district)
 ########
 #combined
 ########
 combined_g4_df <- bind_rows(PER_g4_df, JOR_g4_df, RWA_g4_df, ETH_g4_df_2020, ETH_g4_df_2021, MDG_g4_df) %>%
   mutate(iso3c=factor(iso3c, levels=c("MDG", "ETH", "RWA", "JOR", "PER")),
          `Student Proficient`=if_else(student_proficient==100,"Yes", "No"),
          `Student Proficient Math`=if_else(math_student_proficient==100,"Yes", "No"),
          `Student Proficient Literacy`=if_else(literacy_student_proficient==100,"Yes", "No"))
 weights_df <- combined_g4_df %>%
   group_by(iso3c, hashed_school_code) %>%
   summarise(ipw=mean(ipw, na.rm=T))
 
```



```{r echo=FALSE}

 
 ### Grade 4 assessment breaking up  -------------------
 library(skimr)
 
 breaking_up_all_g4 <- combined_g4_df %>%
   skim() %>% 
   filter(str_detect(skim_variable, "m8saq2_id|m8saq3_id|m8saq4_id|m8saq5_story|m8saq6_story|m8sbq3c_arithmetic|m8sbq3b_arithmetic|m8sbq3g_arithmetic|m8sbq5_word_problem")) %>% 
   
   mutate(iso3c = "ALL") %>% 
   
   mutate(
     
     across(where(is.numeric),
            
            ~ round(., digits = 2)),
     
     skim_variable = case_when(
       
       skim_variable == "m8saq2_id" ~ "Letters identification",
       skim_variable == "m8saq3_id" ~ "Words identification",
       skim_variable == "m8saq4_id" ~ "Pictures identification",
       skim_variable == "m8saq5_story" ~ "Understanding story 1",
       skim_variable == "m8saq6_story" ~ "Understanding story 2",
       
       skim_variable == "m8sbq3b_arithmetic" ~ "Can add double digits ",
       skim_variable == "m8sbq3c_arithmetic" ~ "Can subtract double digits",
       skim_variable == "m8sbq3g_arithmetic" ~ "Can multiply double digits",
       skim_variable == "m8sbq5_word_problem" ~ "Can solve simple math story problem"
       
       
     )
   ) %>% select(skim_variable, iso3c, numeric.mean) %>% rename(mean_country= iso3c, mean_var = numeric.mean) %>% arrange(skim_variable)
 
 
 
 
 breaking_up_g4 <- combined_g4_df %>%
   group_by(iso3c) %>% 
    skim() %>% 
   filter(str_detect(skim_variable, "m8saq2_id|m8saq3_id|m8saq4_id|m8saq5_story|m8saq6_story|m8sbq3c_arithmetic|m8sbq3b_arithmetic|m8sbq3g_arithmetic|m8sbq5_word_problem")) %>% 
   
   
   group_by(skim_variable) %>% 
 
 
   summarise(min_var = min(numeric.mean), min_country = iso3c[which.min(numeric.mean)], 
             max_var = max(numeric.mean), max_country = iso3c[which.max(numeric.mean)]) %>% 
   
   mutate(
     
     across(where(is.numeric),
            
            ~ round(., digits = 2)),
     
     across(ends_with("country"),
            
            ~ case_when(str_detect(., "MDG") ~ "Madagascar",
                        str_detect(., "ETH") ~ "Ethiopia",
                        str_detect(., "PER") ~ "Peru",
                        str_detect(., "RWA") ~ "Rwanda",
                        str_detect(., "JOR") ~ "Jordan")),
            
      skim_variable = case_when(
        
        skim_variable == "m8saq2_id" ~ "Letters identification",
        skim_variable == "m8saq3_id" ~ "Words identification",
        skim_variable == "m8saq4_id" ~ "Pictures identification",
        skim_variable == "m8saq5_story" ~ "Understanding story 1",
        skim_variable == "m8saq6_story" ~ "Understanding story 2",
        
        skim_variable == "m8sbq3b_arithmetic" ~ "Can add double digits ",
        skim_variable == "m8sbq3c_arithmetic" ~ "Can subtract double digits",
        skim_variable == "m8sbq3g_arithmetic" ~ "Can multiply double digits",
        skim_variable == "m8sbq5_word_problem" ~ "Can solve simple math story problem"
        
      )
   ) %>% 
   
arrange(skim_variable) %>% bind_cols(breaking_up_all_g4 %>% select(-skim_variable)) %>% 
   
   mutate(
     
     All = paste0(mean_var*100, "%"),
     Min = paste0(min_var*100, "%", " (", min_country, ")"),
     Max = paste0(max_var*100, "%", " (", max_country, ")"),
     
   ) %>% rename(`Sub-tasks` = skim_variable) %>% 
   select(`Sub-tasks`, All, Min, Max) %>% 
   
   mutate(Tasks= case_when(
     
     
     str_detect(`Sub-tasks`, "digits|math") ~ "Math",
     !str_detect(`Sub-tasks`, "digits|maths") ~ "Literacy"
     
     
   )) %>% 
 as_grouped_data(., groups = c("Tasks")) %>% 
   flextable() %>% 
   bold(j = c("Tasks"), bold = TRUE) %>% 
   italic(j = c("Tasks"), italic = TRUE) %>% 
   add_footer(Tasks= paste0('Notes: The table presents the percentage of students in Grade 4 that were able to perform on various language and math tasks.All individual country statistics are calculated using country-specific sampling weights. The average for all countries, reported under the heading. “All,” is taken by averaging over the country averages. Names of the countries with the lowest (Min) and highest (Max) score for each item are given in parentheses.' )) %>% 
   merge_at( j = 1:5, part = "footer") %>%
   add_header_lines("Comparison across countries of sub-indicators for 4th Grade students") %>%
  set_table_properties(layout = "autofit")
 
 breaking_up_g4
 
```


Next the relationships between 4th grade learning outcomes and practices in the school are shown. The 4th grade assessment scores are the percentage of items correct on the assessment.  The practices considered are teacher presence (0-100%), teacher content knowledge (based on teacher assessment which are represented as percentage correct), teacher pedagogical skills (Teach scores 1-5), availability of basic inputs (0-5), basic infrastructure (0-5), student readiness (1st grade assessment scores which are represented as the percentage correct), operational management scores (1-5), instructional leadership (1-5), principal school knowledge (1-5), and principal management skills (1-5).  Relationships are estimated using OLS regression.  The urban/rural status of the school, the total number of students enrolled in the school, and the log GDP within 1km of the school are included in the regressions.  Additionally, a dummy variable for each country is included in the regression to adjust for between country differences in variables.

The table shows 1st grade student knowledge, teacher content knowledge, basic inputs, and basic infrastructure as some of the best predictors of 4th grade student knowledge  The coefficient on teacher content knowledge implies that a 10 percentage point improvement in teacher content knowledge at a school is associated with a 1.26 percentage point increase in 4th grade student knowledge A 10 percentage point increase in the 1st grade assessment scores is associated with a 2.4 percentage point increase in 4th grade student knowledge.  These two impacts are similar for both the reading and math components of the 4th grade examination. The availability of one more basic input (out of 5 examined) is associated with a 1.1 percentage point increase in 4th grade knowledge, and the availability of one more piece of basic infrastructure is associated with around a 2 percentage point increase in 4th grade knowledge.  

```{r}
models <- list(
  
'4th Grade Student Knowledge' = feols(student_knowledge ~  presence_rate + content_knowledge + teach_score + inputs + infrastructure + ecd_student_knowledge + student_attendance + operational_management + instructional_leadership + principal_knowledge_score + principal_management  + log(GDP) + rural + students_enrolled | country, data=combined_school_office_df, se='hetero'),

'4th Grade Reading Score' = feols(literacy_student_knowledge ~ presence_rate + content_knowledge + teach_score + inputs + infrastructure + ecd_student_knowledge + student_attendance + operational_management + instructional_leadership + principal_knowledge_score + principal_management + log(GDP) + rural + students_enrolled | country, data=combined_school_office_df, se='hetero'),

'4th Grade Math Score' = feols(math_student_knowledge ~  presence_rate + content_knowledge + teach_score + inputs + infrastructure + ecd_student_knowledge + student_attendance + operational_management + instructional_leadership + principal_knowledge_score + principal_management + log(GDP) + rural + students_enrolled  | country, data=combined_school_office_df, se='hetero')
)



modelsummary(models,
             estimate= "{estimate}{stars}",
             coef_rename = c("presence_rate"  = "Teacher Presence",
                             "content_knowledge" = "Teacher Content Knowledge",
                             "teach_score" = "Teacher Pedagogy",
                             "inputs" = "Basic Inputs",
                             "infrastructure" = "Basic Infrastructure",
                             "ecd_student_knowledge" = "1st Grade Student Knowledge",
                             "student_attendance"="Student Attendance",
                             "operational_management" = "Operational Management",
                             "instructional_leadership" = "Instructional Leadership",
                             "principal_knowledge_score" = "Principal Knowledge",
                             "principal_management" = "Principal Management"),
             coef_omit="GDP|rural|students_enrolled",
             gof_map = gm,
             notes="Regressions also include country fixed effects, the log GDP within 1km of school, urban rural status, and total school enrollment as covariates.",
             escape = FALSE
             )
```

The table below shows the relationships for each individual country to see how the relationships between the practice indicators may differ by  country context.  The most consistent indicator that is predictive is the student readiness indicator measuring 1st grade student knowledge.  Teacher content knowledge is a statistically significant predictor in Peru, Rwanda, and Madagascar.  Either basic inputs or basic infrastructure are statistically significant predictors in Peru, Jordan, Ethiopia, and Madagascar.  Operational management is a statistically significant predictor in Rwanda and Madagascar.  


```{r, fig.height=8, fig.width=8}
models <- list(
  
'4th Grade Student Knowledge - Peru' = feols(student_knowledge ~  presence_rate + content_knowledge + teach_score + inputs + infrastructure + ecd_student_knowledge + student_attendance + operational_management + instructional_leadership + principal_knowledge_score + principal_management  + log(GDP) + rural + students_enrolled, data=PER_school_office_link_df, se='hetero'),

'4th Grade Student Knowledge - Jordan' = feols(student_knowledge ~  presence_rate + content_knowledge + teach_score + inputs + infrastructure + ecd_student_knowledge + student_attendance + operational_management + instructional_leadership + principal_knowledge_score + principal_management  + log(GDP) + rural + students_enrolled, data=JOR_school_office_link_df, se='hetero'),

'4th Grade Student Knowledge - Rwanda' = feols(student_knowledge ~  presence_rate + content_knowledge + teach_score + inputs + infrastructure + ecd_student_knowledge + student_attendance + operational_management + instructional_leadership + principal_knowledge_score + principal_management  + log(GDP) + rural + students_enrolled, data=RWA_school_office_link_df, se='hetero'),

'4th Grade Student Knowledge - Ethiopia' = feols(student_knowledge ~ presence_rate + content_knowledge + teach_score + inputs + infrastructure + ecd_student_knowledge + student_attendance + operational_management + instructional_leadership + principal_knowledge_score + principal_management  + log(GDP) + rural + students_enrolled, data=ETH_school_office_link_df, se='hetero'),

'4th Grade Student Knowledge - Madagascar' = feols(student_knowledge ~  presence_rate + content_knowledge  + inputs + infrastructure + ecd_student_knowledge + operational_management + instructional_leadership + principal_knowledge_score + principal_management  + log(GDP) + rural + students_enrolled, data=MDG_school_office_link_df, se='hetero')
)

# coefplot(models,
#          keep=c('presence_rate' , 'content_knowledge' , 'teach_score' , 'inputs' , 'infrastructure' , 'ecd_student_knowledge' , 'operational_management' , 'instructional_leadership' , 'principal_knowledge_score' , 'principal_management')
#          )
# 
# legend("topright", col = 1:2, pch = 20, lwd = 1, lty = 1:2,
#        legend = c("Peru", "Jordan", "Rwanda", "Ethiopia", "Madagascar"), title = "Countries")

modelsummary(models,
             estimate= "{estimate}{stars}",
             coef_rename = c("presence_rate"  = "Teacher Presence",
                             "content_knowledge" = "Teacher Content Knowledge",
                             "teach_score" = "Teacher Pedagogy",
                             "inputs" = "Basic Inputs",
                             "infrastructure" = "Basic Infrastructure",
                             "ecd_student_knowledge" = "1st Grade Student Knowledge",
                             "student_attendance"="Student Attendance",
                             "operational_management" = "Operational Management",
                             "instructional_leadership" = "Instructional Leadership",
                             "principal_knowledge_score" = "Principal Knowledge",
                             "principal_management" = "Principal Management"),
             coef_omit="GDP|rural|students_enrolled",
             gof_map = gm,
             notes="Regressions also include country fixed effects, the log GDP within 1km of school, urban rural status, and total school enrollment as covariates.",
             escape = FALSE             
             )
```

### Learners


Student Readiness, as measured by the GEPD 1st grade assessment, is another area where countries could improve. 

The first grade assessment tool was derived mostly from the MELQO assessment and covers the domains of numeracy, literacy, socio-emotional skills and executive functioning.

The sub-domains for the literacy section are:

*	Expressive Vocabulary
* Letter Identification
*	Word Recognition
*	Sentence Reading
*	Listening Comprehension Story 
*	Name Writing
*	Print Awareness


The sub-domains for the math section are:

*	Verbal Counting
*	Producing a Set
*	Number Identification
*	Number Comparison
*	Simple Addition


The sub-domains for the socio-emotional section are:

*	Perspective Taking/Empathy
*	Conflict Resolution

The sub-domains for the executive functioning section are:

*	Working Memory/Backward Digit Spans
*	Follow Instructions/Head, Toes, Knees, Shoulders Task

The threshold for proficiency on our 1st grade assessment is to score at least 80% of the items correctly. This approach was validated by calculating the percent correct in the top 25% highest scoring schools in Peru on our 4th grade dashboard assessment and found that students in these schools answered around this percentage of items correct.


```{r g1dat}
########
# Peru
#######
#read in anonymized school data
country <- "PER"
year <- "2019"
PER_g1_df <- read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/ecd_dta_anon.csv", sep="/")) %>%
  mutate(iso3c=country) 
########
# Jordan
#######
#read in anonymized school data
country <- "JOR"
year <- "2019"
JOR_g1_df <- haven::read_dta(file=paste(anonymized_dir,"CNT", 'JOR-19',paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/ecd_dta_anon.dta", sep="/")) %>%
  mutate(iso3c=country)
########
# Rwanda
#######
#read in anonymized school data
country <- "RWA"
year <- "2020"
RWA_g1_df <- read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/ecd_dta_anon.csv", sep="/")) %>%
  mutate(iso3c=country) %>%
  filter(!is.na(ecd_student_knowledge))
########
# Ethiopia
#######
#read in anonymized school data
country <- "ETH"
year <- "2020_2021"
ETH_g1_df_2020 <- read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/ecd_dta_anon_2020.csv", sep="/")) %>%
  mutate(iso3c=country)
ETH_g1_df_2021 <- read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/ecd_dta_anon_2021.csv", sep="/")) %>%
  mutate(iso3c=country)
########
# Madagascar
#######
#read in anonymized school data
country <- "MDG"
year <- "2021"
MDG_g1_df <- read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/ecd_dta_anon.csv", sep="/")) %>%
  mutate(iso3c=country) %>%
  select(-district)
########
#combined
########
combined_g1_df <- bind_rows(PER_g1_df, JOR_g1_df, RWA_g1_df, ETH_g1_df_2020, ETH_g1_df_2021, MDG_g1_df) %>%
  mutate(iso3c=factor(iso3c, levels=c("MDG", "ETH", "RWA", "JOR", "PER"))) %>%
  left_join(weights_df) %>%
  mutate(`Student Proficient`=if_else(ecd_student_knowledge>=80,"Yes","No"),
         Rural=case_when(
           rural==1 ~ "Rural",
           rural==0 ~ "Urban",
           urban_rural=="Rural" ~ "Rural", 
           urban_rural=="Urban" ~ "Urban",
           TRUE ~ "Rural"))

combined_g1_df %>%
  select(-`Student Proficient`) %>%
  haven::write_dta(  paste0(confidential_dir, "General/combined_g1.dta")) %>%
  haven::write_dta(  paste0(shared_loc, "Data/combined_g1.dta"))

```

In Peru, more than half of students met this proficiency level, and in Madagascar, the number was only around 5%.  In most countries there are large differences between students in urban and rural schools (shown in Figure XX below).  For instance in Peru, the average raw score on the 1st grade assessment was around 80% for urban schools, while it was around 64% for rural schools.  In Madagascar that gap was 59% to 47%.  Only in Jordan was there little observable difference in student readiness between children in urban and rural schools.



```{r}
indicators <- c("ecd_student_knowledge", "ecd_math_student_knowledge", "ecd_literacy_student_knowledge")
combined_g1_mn <- combined_g1_df %>% 
  group_by(iso3c, Rural) %>%
  mutate(ipw=if_else(is.na(ipw),mean(ipw, na.rm=T),ipw)) %>%
  summarise(across(indicators, wtd.mean, weights=ipw, na.rm=T)) %>%
  ungroup() 
p1 <- ggplot(combined_g1_df, aes(x=Rural, y=ecd_student_knowledge, color=`Student Proficient`)) +
  facet_wrap(~iso3c) +
  geom_quasirandom() +
  geom_segment(data=combined_g1_mn, aes( xend=..x..+.3, yend=..y..), color='black', size=1)  +
  geom_segment(data=combined_g1_mn, aes( xend=..x..-.3, yend=..y..), color='black', size=1)  +
  geom_text(data=combined_g1_mn, aes(label=paste0(round(ecd_student_knowledge, 1), "%")), vjust=-4, color='black', size=3) +
  coord_flip() +
  scale_color_manual(
    values=c("#ef476f", "#06d6a0")
  ) +
  theme_bw() +
  xlab("") +
  ylab("GEPD 1st Grade Assessment Score") +
  labs(
    title="Percentage of Items Correct on GEPD 1st Grade Assessment",
    caption="Solid black lines represent country weighted average. \n Summary Statistics Weighted using Inverse Propensity Weights."
  ) +
  theme(
    axis.text = element_text(size=12),
    title=element_text(size=14),
    legend.position = 'bottom'
  )
p1
```


```{r}
indicators <- c("ecd_student_knowledge", "ecd_math_student_knowledge", "ecd_literacy_student_knowledge")
combined_g1_mn <- combined_g1_df %>% 
  group_by(iso3c, Rural) %>%
  mutate(ipw=if_else(is.na(ipw),mean(ipw, na.rm=T),ipw)) %>%
  summarise(across(indicators, wtd.mean, weights=ipw, na.rm=T)) %>%
  ungroup() 
p1 <- ggplot(combined_g1_df, aes(x=Rural, y=ecd_student_knowledge, color=`Student Proficient`)) +
  facet_wrap(~iso3c) +
  geom_quasirandom() +
  geom_segment(data=combined_g1_mn, aes( xend=..x..+.3, yend=..y..), color='black', size=1)  +
  geom_segment(data=combined_g1_mn, aes( xend=..x..-.3, yend=..y..), color='black', size=1)  +
  geom_text(data=combined_g1_mn, aes(label=paste0(round(ecd_student_knowledge, 1), "%")), vjust=-4, color='black', size=3) +
  coord_flip() +
  scale_color_manual(
    values=c("#ef476f", "#06d6a0")
  ) +
  theme_bw() +
  xlab("") +
  ylab("GEPD 1st Grade Assessment Score") +
  labs(
    title="Percentage of Items Correct on GEPD 1st Grade Assessment",
    caption="Solid black lines represent country weighted average. \n Summary Statistics Weighted using Inverse Propensity Weights."
  ) +
  theme(
    axis.text = element_text(size=12),
    title=element_text(size=14),
    legend.position = 'bottom'
  )
p1
```

When looking at the scores on the underlying domains in figure XX below, children were typically scoring highest on the numeracy section.  Children in Peru, Jordan, and Ethiopia answered close to 90% of the math items correctly.  On the literacy component, the average for all countries was below the 80% threshold set for proficiency.  The averages for the executive functioning and socio-emotional components were also below the 80% threshold.


```{r}
indicators <- c("ecd_student_knowledge", "ecd_literacy_student_knowledge", "ecd_math_student_knowledge", "ecd_exec_student_knowledge", "ecd_soc_student_knowledge")
indicator_desc <- c("Overall Score", "Literacy", "Numeracy", "Executive Functioning", "Socio-Emotional")
combined_g1_mn <- combined_g1_df %>% 
  group_by(iso3c) %>%
  mutate(ipw=if_else(is.na(ipw),mean(ipw, na.rm=T),ipw)) %>%
  summarise(across(indicators, wtd.mean, weights=ipw, na.rm=T)) %>%
  ungroup() 
colnames(combined_g1_mn) <- c('country', indicator_desc)
combined_g1_mn <- combined_g1_mn %>%
  pivot_longer(
    cols = c(2:6),
    names_to='Domain',
    values_to="Mean"
  ) %>%
  mutate(Mean=Mean/100) %>%
  mutate(Domain=factor(Domain, levels=indicator_desc))
ggplot(combined_g1_mn, aes(x=Domain, y=Mean, color=country, shape=country)) +
  geom_point(size=3) +
  geom_text_repel(aes(label=paste0(country,": ",round(100*Mean, 1), "%")), size=5) +
  geom_hline(aes(yintercept=.80), alpha=0.7) +
  expand_limits(y=c(0,1)) +
  scale_x_discrete(limits=rev) +
  scale_y_continuous(
    labels=scales::percent
  ) +
  coord_flip() +
  theme_bw() +
  labs(
    title="Country Performance on 1st Grade Assessment",
    caption="Summary Statistics Weighted using Inverse Propensity Weights."
  ) +
  theme(
    axis.text = element_text(size=12),
    title=element_text(size=14),
    legend.position = 'none'
  )
```


```{r eval=FALSE, include=FALSE}

 ### 1st grade  -------------------
 
 
 ########
 # Peru
 #######
 #read in anonymized school data
 country <- "PER"
 year <- "2019"
 PER_g1_df <- read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/ecd_dta_anon.csv", sep="/")) %>%
   mutate(iso3c=country) %>% mutate(across(.cols =  everything(), ~ as.character(.)))
 ########
 # Jordan
 #######
 #read in anonymized school data
 country <- "JOR"
 year <- "2019"
 JOR_g1_df <- haven::read_dta(file=paste(anonymized_dir,"CNT", 'JOR-19',paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/ecd_dta_anon.dta", sep="/")) %>%
   mutate(iso3c=country)%>% mutate(across(.cols =  everything(), ~ as.character(.)))
 ########
 # Rwanda
 #######
 #read in anonymized school data
 country <- "RWA"
 year <- "2020"
 RWA_g1_df <- read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/ecd_dta_anon.csv", sep="/")) %>%
   mutate(iso3c=country)%>% mutate(across(.cols =  everything(), ~ as.character(.)))
 ########
 # Ethiopia
 #######
 #read in anonymized school data
 country <- "ETH"
 year <- "2020_2021"
 ETH_g1_df_2020 <- read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/ecd_dta_anon_2020.csv", sep="/")) %>%
   mutate(iso3c=country)%>% mutate(across(.cols =  everything(), ~ as.character(.)))
 ETH_g1_df_2021 <- read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/ecd_dta_anon_2021.csv", sep="/")) %>%
   mutate(iso3c=country)%>% mutate(across(.cols =  everything(), ~ as.character(.)))
 ########
 # Madagascar
 #######
 #read in anonymized school data
 country <- "MDG"
 year <- "2021"
 MDG_g1_df <- read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/ecd_dta_anon.csv", sep="/")) %>%
   mutate(iso3c=country) %>%
   select(-district) %>% mutate(across(.cols =  everything(), ~ as.character(.)))
 ########
 
 ########
 #combined
 ########
 combined_g1_df <- bind_rows(PER_g1_df, JOR_g1_df, RWA_g1_df, ETH_g1_df_2020, ETH_g1_df_2021, MDG_g1_df) %>%
   mutate(iso3c=factor(iso3c, levels=c("MDG", "ETH", "RWA", "JOR", "PER")))

```

The table below highlights student performance on specific items in the 1st grade assessment.

```{r echo=FALSE}

 
 
 breaking_up_all_g1 <- combined_g1_df %>%
   
   select(starts_with("hashed"), iso3c, ends_with("vocabn"), ends_with("_comprehension"), ends_with("_words"), ends_with("_letters"), ends_with("_sentence"), ends_with("_nm_writing"), ends_with("_produce_set"), ends_with("_number_ident"),
          ends_with("_backward_digit"), ends_with("_number_compare"), ends_with("counting"), ends_with("_simple_add"), ends_with("_head_shoulders"), ends_with("_perspective"), ends_with("conflict_resol")) %>% 
   
   mutate_at(c(5:length(.)), ~ as.numeric(.)) %>% 
   
   mutate(
     ecd_vocabn = rowMeans(select(., ends_with("vocabn"))),
     ecd_comprehension = rowMeans(select(., ends_with("_comprehension"))),
     ecd_words = rowMeans(select(., ends_with("_words"))),
     ecd_letters = rowMeans(select(., ends_with("_letters"))),
     ecd_sentence = rowMeans(select(., ends_with("_sentence"))),
     ecd_name_writing= rowMeans(select(., ends_with("_nm_writing"))),
     
     ecd_counting = rowMeans(select(., ends_with("counting")), na.rm = T),
     ecd_produce_set = rowMeans(select(., ends_with("_produce_set")), na.rm = T),
     ecd_number_ident = rowMeans(select(., ends_with("_number_ident")), na.rm = T),
     ecd_number_compare = rowMeans(select(., ends_with("_number_compare")), na.rm = T),
     ecd_simple_add = rowMeans(select(., ends_with("_simple_add")), na.rm = T),
     ecd_head_shoulderss = rowMeans(select(., ends_with("_head_shoulders")), na.rm = T),
     ecd_backward_digit = rowMeans(select(., ends_with("_backward_digit")), na.rm = T),
     ecd_perspective = rowMeans(select(., ends_with("_perspective")), na.rm = T),
     ecd_conflict_resol = rowMeans(select(., ends_with("conflict_resol")), na.rm = T)
     
     
     
   ) %>% 
   
   skim() %>% 
   filter(str_detect(skim_variable, "ecd_")) %>% 
   
   mutate(iso3c = "ALL") %>% 
   
   mutate(
     
     across(where(is.numeric),
            
            ~ round(., digits = 2)),
     
     skim_variable = case_when(
       skim_variable == "ecd_vocabn" ~ "Basic vocabulary",
       skim_variable == "ecd_comprehension" ~ "Basic comprehension",
       skim_variable == "ecd_words" ~ "Words identification",
       skim_variable == "ecd_letters" ~ "Letters identification",
       skim_variable == "ecd_sentence" ~ "Sentence understanding",
       skim_variable == "ecd_name_writing" ~ "Name writing",
       
       skim_variable == "ecd_counting" ~ "Basic counting",
       skim_variable == "ecd_produce_set" ~ "Set production",
       skim_variable == "ecd_number_ident" ~ "Number identification",
       skim_variable == "ecd_number_compare" ~ "Number comparison",
       skim_variable == "ecd_simple_add" ~ "Simple addition",
       
       skim_variable == "ecd_backward_digit" ~ "Backward digit counting",
       skim_variable == "ecd_head_shoulderss" ~ "Head-Shoulders coordination",
       
       skim_variable == "ecd_perspective" ~ "Perspective taking",
       skim_variable == "ecd_conflict_resol" ~ "Conflict resolution"
       
     )
   ) %>% select(skim_variable, iso3c, numeric.mean) %>% rename(mean_country= iso3c, mean_var = numeric.mean) %>% arrange(skim_variable)
 
 
 
 
 breaking_up_g1 <- combined_g1_df %>%
   
   
   select(starts_with("hashed"), iso3c, ends_with("vocabn"), ends_with("_comprehension"), ends_with("_words"), ends_with("_letters"), ends_with("_sentence"), ends_with("_nm_writing"), ends_with("_produce_set"), ends_with("_number_ident"),
          ends_with("_backward_digit"), ends_with("_number_compare"), ends_with("counting"), ends_with("_simple_add"), ends_with("_head_shoulders"), ends_with("_perspective"), ends_with("conflict_resol")) %>% 
     
   mutate_at(c(5:length(.)), ~ as.numeric(.)) %>% 
   
   mutate(
     
     ecd_vocabn = rowMeans(select(., ends_with("vocabn"))),
     ecd_comprehension = rowMeans(select(., ends_with("_comprehension"))),
     ecd_words = rowMeans(select(., ends_with("_words"))),
     ecd_letters = rowMeans(select(., ends_with("_letters"))),
     ecd_sentence = rowMeans(select(., ends_with("_sentence"))),
     ecd_name_writing= rowMeans(select(., ends_with("_nm_writing")), na.rm = T),
     
     ecd_counting = rowMeans(select(., ends_with("counting")), na.rm = T),
     ecd_produce_set = rowMeans(select(., ends_with("_produce_set")), na.rm = T),
     ecd_number_ident = rowMeans(select(., ends_with("_number_ident")), na.rm = T),
     ecd_number_compare = rowMeans(select(., ends_with("_number_compare")), na.rm = T),
     ecd_simple_add = rowMeans(select(., ends_with("_simple_add")), na.rm = T),
     ecd_head_shoulderss = rowMeans(select(., ends_with("_head_shoulders")), na.rm = T),
     ecd_backward_digit = rowMeans(select(., ends_with("_backward_digit")), na.rm = T),
     ecd_perspective = rowMeans(select(., ends_with("_perspective")), na.rm = T),
     ecd_conflict_resol = rowMeans(select(., ends_with("conflict_resol")), na.rm = T)
     
   ) %>% 
   
   
   group_by(iso3c) %>% 
   skim() %>% 
   filter(str_detect(skim_variable, "ecd_")) %>% 
   
   
   group_by(skim_variable) %>% 
   
   
   summarise(min_var = min(numeric.mean), min_country = iso3c[which.min(numeric.mean)], 
             max_var = max(numeric.mean), max_country = iso3c[which.max(numeric.mean)]) %>% 
   
   mutate(
     
     across(where(is.numeric),
            
            ~ round(., digits = 2)),
     
     across(ends_with("country"),
            
            ~ case_when(str_detect(., "MDG") ~ "Madagascar",
                        str_detect(., "ETH") ~ "Ethiopia",
                        str_detect(., "PER") ~ "Peru",
                        str_detect(., "RWA") ~ "Rwanda",
                        str_detect(., "JOR") ~ "Jordan")),
     
     skim_variable = case_when(
       
       skim_variable == "ecd_vocabn" ~ "Basic vocabulary",
       skim_variable == "ecd_comprehension" ~ "Basic comprehension",
       skim_variable == "ecd_words" ~ "Words identification",
       skim_variable == "ecd_letters" ~ "Letters identification",
       skim_variable == "ecd_sentence" ~ "Sentence understanding",
       skim_variable == "ecd_name_writing" ~ "Name writing",
       
       skim_variable == "ecd_counting" ~ "Basic counting",
       skim_variable == "ecd_produce_set" ~ "Set production",
       skim_variable == "ecd_number_ident" ~ "Number identification",
       skim_variable == "ecd_number_compare" ~ "Number comparison",
       skim_variable == "ecd_simple_add" ~ "Simple addition",
       
       skim_variable == "ecd_backward_digit" ~ "Backward digit counting",
       skim_variable == "ecd_head_shoulderss" ~ "Head-Shoulders coordination",
       
       skim_variable == "ecd_perspective" ~ "Perspective taking",
       skim_variable == "ecd_conflict_resol" ~ "Conflict resolution"
       
     )
   ) %>% 
   
   arrange(skim_variable) %>% bind_cols(breaking_up_all_g1 %>% select(-skim_variable)) %>% 
   
   mutate(
     
     All = paste0(mean_var*100, "%"),
     Min = paste0(min_var*100, "%", " (", min_country, ")"),
     Max = paste0(max_var*100, "%", " (", max_country, ")"),
     
   ) %>% rename(`Sub-tasks` = skim_variable) %>% 
   select(`Sub-tasks`, All, Min, Max) %>% 
   
   mutate(Tasks= case_when(
     
     
     str_detect(`Sub-tasks`, "vocabulary|comprehension|Words|Letters|Name") ~ "Literacy",
     str_detect(`Sub-tasks`, "Perspective|Conflict") ~ "Socio-emotional",
     str_detect(`Sub-tasks`, "coordination|Backward") ~ "Executive Functioning",
     TRUE ~ "Math"),
     Tasks=factor(Tasks, levels=c("Literacy", "Math", "Executive Functioning", "Socio-emotional"))
   ) %>% 
   arrange(Tasks, `Sub-tasks`) %>% 
   as_grouped_data(., groups = c("Tasks")) %>% 
   flextable() %>% 
   bold(j = c("Tasks"), bold = TRUE) %>% 
   italic(j = c("Tasks"), italic = TRUE) %>% 
   add_footer(Tasks= paste0('Notes: The table presents the percentage of students in Grade 1 that were able to perform on various language, math and socio-emotional tasks.All individual country statistics are calculated using country-specific sampling weights. The average for all countries, reported under the heading. “All,” is taken by averaging over the country averages. Names of the countries with the lowest (Min) and highest (Max) score for each item are given in parentheses.' )) %>% 
   merge_at( j = 1:5, part = "footer") %>%
   add_header_lines("Comparison across countries of sub-indicators for 1st Grade students") %>% 
   
   autofit()
 
 
 breaking_up_g1
 
```






```{r regfun}

#create function to create regression output
reg_fun <- function(indicators) {
  
  #create formula
  out <- names(indicators[1])
  out_lab <- indicators[1]
  
  cov <- names(indicators[2:length(indicators)])
  cov_lab <- indicators[2:length(indicators)]
  
  form <- as.formula(paste0(paste(out, paste(cov, collapse=" + "), sep=" ~ "),"  + log(GDP) + rural + students_enrolled | country"))
  
  models <- list(
  
   " " = feols(form, data=combined_school_office_df, se='hetero')

  )



  modelsummary(models,
               estimate= "{estimate}{stars}",
               coef_rename = cov_lab,
               coef_omit="GDP|rural|students_enrolled",
               gof_map = gm,
               notes="Regressions also include country fixed effects, the log GDP within 1km of school, urban rural status, and total school enrollment as covariates.",
               escape = FALSE,
               title=paste(out_lab)
               )
  
}

```


### Teachers



```{r pedgcont}
#read in teacher pedagogy scores and link to content knowledge
####### 
# Peru
#######
country <- "PER"
year <- "2019"
PER_pedg_df <- read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/final_indicator_data_PEDG_anon.csv", sep="/")) %>%
  mutate(iso3c=country,
         teacher_id=m4saq1_number) 
PER_cont_df <- read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/teacher_assessment_dta_anon.csv", sep="/")) %>%
  mutate(iso3c=country,
         teacher_id=m5sb_tnum) 
PER_teachers_df <- PER_pedg_df %>%
  left_join(PER_cont_df) %>%
  mutate(content_knowledge=if_else(is.na(literacy_content_knowledge),math_content_knowledge, literacy_content_knowledge)) %>%
  select(-starts_with('s_'))
####### 
# Jordan
#######
country <- "JOR"
year <- "2019"
JOR_teach_code_df <- haven::read_dta(file=paste(anonymized_dir,"CNT", 'JOR-19',paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/school_dta_anon.dta", sep="/")) %>%
  filter(!is.na(m4saq1_number)) %>%
  select(hashed_school_code, m4saq1_number, territory, governorate, ipw) 
JOR_pedg_df <- haven::read_dta(file=paste(anonymized_dir,"CNT", 'JOR-19',paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/final_indicator_data_PEDG_anon.dta", sep="/")) %>%
  left_join(JOR_teach_code_df) %>%
  mutate(iso3c=country,
         teacher_id=m4saq1_number) 
JOR_cont_df <- haven::read_dta(file=paste(anonymized_dir,"CNT", 'JOR-19',paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/teacher_assessment_dta_anon.dta", sep="/")) %>%
  mutate(iso3c=country,
         teacher_id=m5sb_tnum) 
JOR_teachers_df <- JOR_pedg_df %>%
  left_join(JOR_cont_df) %>%
  mutate(content_knowledge=if_else(is.na(literacy_content_knowledge),math_content_knowledge, literacy_content_knowledge)) %>%
  select(-starts_with('s_'))
####### 
# Rwanda
#######
country <- "RWA"
year <- "2020"
RWA_pedg_df <- read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/final_indicator_data_PEDG_anon.csv", sep="/")) %>%
  mutate(iso3c=country,
         teacher_id=m4saq1_number) 
RWA_cont_df <- read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/teacher_assessment_dta_anon.csv", sep="/")) %>%
  mutate(iso3c=country,
         teacher_id=m5sb_tnum) 
RWA_teachers_df <- RWA_pedg_df %>%
  left_join(RWA_cont_df) %>%
  mutate(content_knowledge=if_else(is.na(literacy_content_knowledge),math_content_knowledge, literacy_content_knowledge)) %>%
  select(-starts_with('s_'))
####### 
# Ethiopia
#######
country <- "ETH"
year <- "2020_2021"
ETH_teach_code_df <- read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/school_dta_anon.csv", sep="/")) %>%
  filter(!is.na(m4saq1_number)) %>%
  select(hashed_school_code, m4saq1_number, ipw) 
ETH_pedg_df_2020 <- read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/final_indicator_data_PEDG_anon_2020.csv", sep="/")) %>%
  filter(!is.na(hashed_school_code) ) %>%
  left_join(ETH_teach_code_df) %>%
  mutate(iso3c=country,
         teacher_id=m4saq1_number) 
ETH_cont_df_2020 <- read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/teacher_assessment_dta_anon_2020.csv", sep="/")) %>%
  mutate(iso3c=country,
         teacher_id=m5sb_tnum) 
ETH_teachers_df_2020 <- ETH_pedg_df_2020 %>%
  left_join(ETH_cont_df_2020) %>%
  mutate(content_knowledge=if_else(is.na(literacy_content_knowledge),math_content_knowledge, literacy_content_knowledge)) %>%
  select(-starts_with('s_'))
ETH_pedg_df_2021 <- read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/final_indicator_data_PEDG_anon_2021.csv", sep="/")) %>%
    filter(!is.na(hashed_school_code) ) %>%
  left_join(ETH_teach_code_df) %>%
  mutate(iso3c=country,
         teacher_id=m4saq1_number) 
ETH_cont_df_2021 <- read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/teacher_assessment_dta_anon_2021.csv", sep="/")) %>%
  mutate(iso3c=country,
         teacher_id=m5sb_tnum) 
ETH_teachers_df_2021 <- ETH_pedg_df_2021 %>%
  left_join(ETH_cont_df_2021) %>%
  mutate(content_knowledge=if_else(is.na(literacy_content_knowledge),math_content_knowledge, literacy_content_knowledge)) %>%
  select(-starts_with('s_'))


######
# Combined
######
combined_teachers_df <- bind_rows(PER_teachers_df, JOR_teachers_df, RWA_teachers_df, ETH_teachers_df_2020, ETH_teachers_df_2021) %>%
  mutate(iso3c=factor(iso3c, levels=c("ETH","RWA", "JOR", "PER")))


haven::write_dta(combined_teachers_df,  paste0(confidential_dir, "General/combined_teacher_cont_pedg.dta"))
haven::write_dta(combined_teachers_df,  paste0(shared_loc, "Data/combined_teacher_cont_pedg.dta"))  

```


Teacher pedagogical skill and content knowledge are two other areas where countries consistently struggle.  Teacher pedagogical skill is measured through the Teach assessment (ADD CITATION FOR TEACH Paper), and teacher content knowledge is measured through a teacher content examination, where teachers are asked to grade a hypothetical students work in language in mathematics.  

To be rated as proficient on the teacher pedagogical assessment, teachers must score at least 3 out 5 possible points on the Teach scale.  Few teachers managed to meet this threshold.  No country had more than 40% of teachers score proficient on the assessment.  In Ethiopia, only 19% of teachers managed to do so.  

To be rated proficient on the teacher content knowledge exam, teachers needed to get at least 80% of the items correct on the examination.  Again, relatively few teachers managed to do this.  In Peru, the highest scoring country, less than 40% of teachers managed to do so.  In Ethiopia, only 6% of teachers managed to do so.

Figure XX below shows that the teachers scoring well (or poorly) on the teacher pedagogical examination are not always the same as the teachers scoring well (or poorly) on the teacher content knowledge exam.  In the figure, each point on the scatterplot represents a single teachers content knowledge and pedagogy score.  The teacher's country is color coded in the figure.  There is only a weak relationship between the two measures, with an R squrared of only 0.08, meaning that policies targeted at teachers struggling in terms of content knowledge may have to target different teachers than a policy targeting teachers struggling in pedagogy. 

```{r pedgcontplt, cache=TRUE}
lab1 <- eq_plot_txt('content_knowledge', 'teach_score', combined_teachers_df)
  
ggplot(combined_teachers_df, aes(x=teach_score, y=content_knowledge, color=iso3c)) +
  geom_point() +
  geom_smooth(method='lm', color='blue') +
  geom_richtext(
   aes(x = 2, y = 20,label = lab1, hjust=0.2), color='black'
  ) +
  theme_bw() +
  xlab('Teacher Content Knowledge') +
  ylab("Teacher Pedagogical Skill") +
  expand_limits(x=c(1,5),y=c(0,100)) +
  labs(
    title='Scatterplot between Teacher Pedagogical Skill and Teacher Content Knowledge'
  ) +
  theme(
    legend.position = 'bottom',
    axis.text=element_text(size=12),
    title=element_text(size=14)
  )
```


```{r echo=FALSE}

 
 ######################################################
 ### Teaching breaking up -------------------
 
 
 ########
 # Peru
 #######
 #read in anonymized school data
 country <- "PER"
 year <- "2019"
 PER_df <- read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/teacher_questionnaire_anon.csv", sep="/")) %>%
    mutate(iso3c=country) %>% mutate(across(.cols =  everything(), ~ as.character(.)))
 ########
 # Jordan
 #######
 #read in anonymized school data
 country <- "JOR"
 year <- "2019"
 JOR_df <- haven::read_dta(file=paste(anonymized_dir,"CNT", 'JOR-19',paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/teacher_questionnaire_anon.dta", sep="/")) %>%
    mutate(iso3c=country)%>% mutate(across(.cols =  everything(), ~ as.character(.)))
 ########
 # Rwanda
 #######
 #read in anonymized school data
 country <- "RWA"
 year <- "2020"
 RWA_df <- read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/teacher_questionnaire_anon.csv", sep="/")) %>%
    mutate(iso3c=country)%>% mutate(across(.cols =  everything(), ~ as.character(.)))
 ########
 # Ethiopia
 #######
 #read in anonymized school data
 country <- "ETH"
 year <- "2020_2021"
 ETH_df_2020 <- read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/teacher_questionnaire_anon_2020.csv", sep="/")) %>%
    mutate(iso3c=country)%>% mutate(across(.cols =  everything(), ~ as.character(.)))
 ETH_df_2021 <- read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/teacher_questionnaire_anon_2021.csv", sep="/")) %>%
    mutate(iso3c=country)%>% mutate(across(.cols =  everything(), ~ as.character(.)))
 ########
 # Madagascar
 #######
 #read in anonymized school data
 country <- "MDG"
 year <- "2021"
 MDG_df <- read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/teacher_questionnaire_dta_anon.csv", sep="/")) %>%
    mutate(iso3c=country) %>%
    select(-district) %>% mutate(across(.cols =  everything(), ~ as.character(.)))
 ########
 
 ########
 #combined
 ########
 combined_teacher_df <- bind_rows(PER_df, JOR_df, RWA_df, ETH_df_2020, ETH_df_2021, MDG_df) %>%
    mutate(iso3c=factor(iso3c, levels=c("MDG", "ETH", "RWA", "JOR", "PER")))
 

haven::write_dta(combined_teacher_df,  paste0(confidential_dir, "General/combined_teachers.dta"))
#haven::write_dta(combined_teacher_df,  paste0(shared_loc, "Data/combined_teachers.dta"))  
```



Below regression coefficients will be shown between a school practice indicator and its respective policy indicators. For example, teacher content knowledge is regressed on the teacher attraction, selection and deployment, support, and evaluation indicators. Once again, to help account for other factors that might bias these relationships, the urban/rural status of the school, total number of students, and log GDP in the vicinity of the school are included in the regressions.

Teacher support has a positive relationship with teacher content knowledge at the 10% level.  A one unit increase in teacher support (on a 1-5 scale) is assocaited with a 1 percentage point improvement in teacher content knowledge.  

```{r}

indicators_list <- c(
               "content_knowledge" = "Teacher Content Knowledge",
               "teacher_attraction" = "Teacher Attraction",
               "teacher_selection_deployment" = "Teacher Selection & Deployment",
               "teacher_support" = "Teacher Support",
               "teaching_evaluation" = "Teacher Evaluation"

               )


reg_fun(indicators_list)

```

Concrete examples of teacher policies related to teacher support and teacher evaluation are shown in the table below.  

```{r echo=FALSE}

 
 breaking_up_all_teacher <- combined_teacher_df %>%
    mutate_at(c(2:length(.)), ~ as.numeric(.)) %>% 
    mutate(
       m3bq10_tmna =if_else(m3bq10_tmna__7 ==1, 0, 1),
       m3sbq9_tmna =if_else(m3sbq9_tmna__7 ==1, 0, 1)
       
    ) %>% 
    skim() %>% 
    filter(str_detect(skim_variable, "m3sdq14_ildr|m3sdq3_tsup|m3sdq9_tsup|m3sbq6_tmna|m3sbq9_tmna|m3bq10_tmna")) %>% 
    filter(!str_detect(skim_variable, "__")) %>% 
    
    mutate(iso3c = "ALL") %>% 
    
    mutate(
       
       across(where(is.numeric),
              
              ~ round(., digits = 2)),
       
       skim_variable = case_when(
          
          skim_variable == "m3sdq14_ildr" ~ "Opportunities to share ways of improving",
          skim_variable == "m3sdq3_tsup" ~ "Induction or mentorship program",
          skim_variable == "m3sdq9_tsup" ~ "In service training",
          skim_variable == "m3sbq6_tmna" ~ "Formally evaluated",
          skim_variable == "m3sbq9_tmna" ~ "Negative consequence if bad evaluation",
          skim_variable == "m3bq10_tmna" ~ "Positive consequence if good evaluation"
          
          
       )
    ) %>% select(skim_variable, iso3c, numeric.mean) %>% rename(mean_country= iso3c, mean_var = numeric.mean) %>% arrange(skim_variable)


 
 
 breaking_up_teacher <- combined_teacher_df %>%
    relocate(iso3c) %>% 
    mutate_at(c(2:length(.)), ~ as.numeric(.)) %>% 
    mutate(
       m3bq10_tmna =if_else(m3bq10_tmna__7 ==1, 0, 1),
       m3sbq9_tmna =if_else(m3sbq9_tmna__7 ==1, 0, 1)
       
    ) %>% 
 
    group_by(iso3c) %>% 
    skim() %>% 
    filter(str_detect(skim_variable, "m3sdq14_ildr|m3sdq3_tsup|m3sdq9_tsup|m3sbq6_tmna|m3sbq9_tmna|m3bq10_tmna")) %>% 
    filter(!str_detect(skim_variable, "__")) %>% 

   
 
#  
# x <- breaking_up_teacher %>% 
   
   filter(!str_detect(iso3c, "MDG")) %>% 
    
    group_by(skim_variable) %>% 
    
    
    summarise(min_var = min(numeric.mean), min_country = iso3c[which.min(numeric.mean)], 
              max_var = max(numeric.mean), max_country = iso3c[which.max(numeric.mean)]) %>% 
    
    mutate(
       
       across(where(is.numeric),
              
              ~ round(., digits = 2)),
       
       across(ends_with("country"),
              
              ~ case_when(str_detect(., "MDG") ~ "Madagascar",
                          str_detect(., "ETH") ~ "Ethiopia",
                          str_detect(., "PER") ~ "Peru",
                          str_detect(., "RWA") ~ "Rwanda",
                          str_detect(., "JOR") ~ "Jordan")),
       
       skim_variable = case_when(
          
          skim_variable == "m3sdq14_ildr" ~ "Opportunities to share ways of improving",
          skim_variable == "m3sdq3_tsup" ~ "Induction or mentorship program",
          skim_variable == "m3sdq9_tsup" ~ "In service training",
          skim_variable == "m3sbq6_tmna" ~ "Formally evaluated",
          skim_variable == "m3sbq9_tmna" ~ "Negative consequence if bad evaluation",
          skim_variable == "m3bq10_tmna" ~ "Positive consequence if good evaluation"
          
       )
    ) %>% 
    
    arrange(skim_variable) %>% bind_cols(breaking_up_all_teacher %>% select(-skim_variable)) %>% 
    
    mutate(
       
       All = paste0(mean_var*100, "%"),
       Min = paste0(min_var*100, "%", " (", min_country, ")"),
       Max = paste0(max_var*100, "%", " (", max_country, ")"),
       
    ) %>% 
    
    rename(`Sub-tasks` = skim_variable) %>% 
    select(`Sub-tasks`, All, Min, Max) %>% 
    
    mutate(Tasks= case_when(
       
       
       str_detect(`Sub-tasks`, "training|mentorship|Opportunity") ~ "Teacher Support",
       !str_detect(`Sub-tasks`, "training|mentorship|Opportunity") ~ "Teacher Evaluation"
       
       
    )) %>% 
   relocate(Tasks, `Sub-tasks`) %>% 
    arrange(Tasks, `Sub-tasks`) %>% 
    as_grouped_data(., groups = c("Tasks")) %>% 
    flextable() %>% 
    bold(j = c("Tasks"), bold = TRUE) %>% 
    italic(j = c("Tasks"), italic = TRUE) %>% 
    add_footer(Tasks= paste0('Notes: The table presents the percentage of teachers that responded positively to this question.All individual country statistics are calculated using country-specific sampling weights. The average for all countries, reported under the heading. “All,” is taken by averaging over the country averages. Names of the countries with the lowest (Min) and highest (Max) score for each item are given in parentheses. Madagascar is not included in the data presented above as data were not consistently available for these indicators.' )) %>% 
    merge_at( j = 1:5, part = "footer") %>%
    add_header_lines("Comparison across countries of sub-indicators for primary school teachers") %>% 
    set_table_properties(layout = "autofit")
 
 
 
 
    breaking_up_teacher

 
 
```

Teacher pedagogy has no statistically significant relationships to the underlying policy indicators.

```{r}

indicators_list <- c(
               "teach_score" = "Teacher Pedagogy Skill",
               "teacher_attraction" = "Teacher Attraction",
               "teacher_selection_deployment" = "Teacher Selection & Deployment",
               "teacher_support" = "Teacher Support",
               "teaching_evaluation" = "Teacher Evaluation"

               )


reg_fun(indicators_list)

```


Teacher monitoring and accountability and teacher intrinsic motivation are both statistically significantly related to teacher presence at the 5% significance level.  A one unit increase (1-5 scale) on teacher intrinsic motivation is associated with an almost 5 percentage point increase in teacher presence.  A one unit increase in monitoring and accountability is associated with a 2.4 percentage point increase in presence.

```{r}

indicators_list <- c(
               "presence_rate" = "Teacher Presence",
               "teacher_monitoring" = "Teacher Monitoring & Accountability",
               "intrinsic_motivation" = "Teacher Intrinsic Motivation"

               )


reg_fun(indicators_list)

```

### School Inputs

Below regression coefficients will be shown between a school practice indicator and its respective policy indicators. For example, teacher content knowledge is regressed on the teacher attraction, selection and deployment, support, and evaluation indicators. Once again, to help account for other factors that might bias these relationships, the urban/rural status of the school, total number of students, and log GDP in the vicinity of the school are included in the regressions.

Standards and monitoring are both statistically significant at the 10% level with the availability of basic inputs.  A one unit increase in standards is associated with a 0.04 increase in the availability of basic inputs (0-5 scale).  A one unit increase in monitoring is related to 0.83 increase in inputs.  

```{r}

indicators_list <- c(
               "inputs" = "Basic Inputs",
               "standards_monitoring" = "Standards",
               "sch_monitoring" = "Monitoring"

               )


reg_fun(indicators_list)

```


Monitoring is statistically significantly related to the availability of basic infrastructure.  A one unit increase in monitoring is associated with a .3 unit increase in the basic infrastructure availability index (0-5 scale).

```{r}

indicators_list <- c(
               "infrastructure" = "Basic Infrastructure",
               "standards_monitoring" = "Standards",
               "sch_monitoring" = "Monitoring"

               )


reg_fun(indicators_list)

```

### School Management


The table below breaks down the underlying school management policies.  Next these policies are related to the school manamagement practice indicators.

```{r}

 ######################################################
 ### School Management breaking up -------------------
 
 
 ########
 # Peru
 #######
 #read in anonymized school data
 country <- "PER"
 year <- "2019"
 PER_df <- read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/school_dta_short_anon.csv", sep="/")) %>%
    mutate(iso3c=country) %>% mutate(across(.cols =  everything(), ~ as.character(.)))
 ########
 # Jordan
 #######
 #read in anonymized school data
 country <- "JOR"
 year <- "2019"
 JOR_df <- haven::read_dta(file=paste(anonymized_dir,"CNT", 'JOR-19',paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/school_dta_short_anon.dta", sep="/")) %>%
    mutate(iso3c=country)%>% mutate(across(.cols =  everything(), ~ as.character(.)))
 ########
 # Rwanda
 #######
 #read in anonymized school data
 country <- "RWA"
 year <- "2020"
 RWA_df <- read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/school_dta_short_anon.csv", sep="/")) %>%
    mutate(iso3c=country)%>% mutate(across(.cols =  everything(), ~ as.character(.)))
 ########
 # Ethiopia
 #######
 #read in anonymized school data
 country <- "ETH"
 year <- "2020_2021"
 ETH_df <- read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/school_dta_short_anon.csv", sep="/")) %>%
    mutate(iso3c=country)%>% mutate(across(.cols =  everything(), ~ as.character(.)))
 
 ########
 # Madagascar
 #######
 #read in anonymized school data
 country <- "MDG"
 year <- "2021"
 MDG_df <- read_csv(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/School/data/school_dta_short_anon.csv", sep="/")) %>%
    mutate(iso3c=country) %>%
    select(-district) %>% mutate(across(.cols =  everything(), ~ as.character(.)))
 ########
 
 ########
 #combined
 ########
 combined_school_df <- bind_rows(PER_df, JOR_df, RWA_df, ETH_df, MDG_df) %>%
    mutate(iso3c=factor(iso3c, levels=c("MDG", "ETH", "RWA", "JOR", "PER")))
 
 
 haven::write_dta(combined_school_df,  paste0(confidential_dir, "General/combined_school.dta"))
haven::write_dta(combined_school_df,  paste0(shared_loc, "Data/combined_school.dta"))

 
```

The table below breaks down the principal knowledge and school instructional leadership

```{r}

 
 breaking_up_all_principal <- combined_school_df %>%
    
    select(starts_with("hashed"), iso3c, principal_training, principal_formally_evaluated, principal_positive_consequences, 
           principal_negative_consequences, sch_goals_exist, classroom_observed, discussed_observation, lesson_plan_w_feedback,
           add_triple_digit_pknw, multiply_double_digit_pknw, complete_sentence_pknw, experience_pknw) %>% 
    
    mutate_at(c(4:length(.)), ~ as.numeric(.)) %>% 
    
    skim() %>% 

    mutate(iso3c = "ALL") %>% 
    
    mutate(
       
       across(where(is.numeric),
              
              ~ round(., digits = 2)),
       
       skim_variable = case_when(
          
          skim_variable == "principal_training" ~ "Formally trained to be principal",
          skim_variable == "principal_formally_evaluated" ~ "Formally evaluated over the last year",
          skim_variable == "principal_positive_consequences" ~ "Reporting positive consequence for positive evaluation",
          skim_variable == "principal_negative_consequences" ~ "Reporting negative consequence for negative evaluation",
          
          skim_variable == "sch_goals_exist" ~ "Existence of school goals",
          skim_variable == "classroom_observed" ~ "Classroom observed over the last year",
          skim_variable == "discussed_observation" ~ "Observation were discussed",
          skim_variable == "lesson_plan_w_feedback" ~ "Lesson plan was discussed with someone beforehand",
          
          skim_variable == "add_triple_digit_pknw" ~ "Can add triple digits",
          skim_variable == "multiply_double_digit_pknw" ~ "Can multiply double digits",
          skim_variable == "complete_sentence_pknw" ~ "Can complete a simple sentence",
          skim_variable == "experience_pknw" ~ "Has less than 3 year of experience in position"
          
          
       )
    ) %>% select(skim_variable, iso3c, numeric.mean) %>% rename(mean_country= iso3c, mean_var = numeric.mean) %>% arrange(skim_variable) %>% filter(!is.na(.))
 
 
 
 
 breaking_up_principal <- combined_school_df %>%
    
    select(starts_with("hashed"), iso3c, principal_training, principal_formally_evaluated, principal_positive_consequences, 
           principal_negative_consequences, sch_goals_exist, classroom_observed, discussed_observation, lesson_plan_w_feedback,
           add_triple_digit_pknw, multiply_double_digit_pknw, complete_sentence_pknw, experience_pknw) %>% 
    relocate(starts_with("hashed"), iso3c) %>% 
    
    mutate_at(c(5:length(.)), ~ as.numeric(.)) %>% 
    
    group_by(iso3c) %>% 
    skim() %>% 
    
    ## Delete only the data for Peru for the existence of schools goal since all obs are missing
    filter(iso3c!="PER" | skim_variable!="sch_goals_exist") %>% 
    
    group_by(skim_variable) %>% 
    
    
    summarise(min_var = min(numeric.mean), min_country = iso3c[which.min(numeric.mean)], 
              max_var = max(numeric.mean), max_country = iso3c[which.max(numeric.mean)]) %>% 
    
    mutate(
       
       across(where(is.numeric),
              
              ~ round(., digits = 2)),
       
       across(ends_with("country"),
              
              ~ case_when(str_detect(., "MDG") ~ "Madagascar",
                          str_detect(., "ETH") ~ "Ethiopia",
                          str_detect(., "PER") ~ "Peru",
                          str_detect(., "RWA") ~ "Rwanda",
                          str_detect(., "JOR") ~ "Jordan")),
       
       skim_variable = case_when(
          
          
          skim_variable == "principal_training" ~ "Formally trained to be principal",
          skim_variable == "principal_formally_evaluated" ~ "Formally evaluated over the last year",
          skim_variable == "principal_positive_consequences" ~ "Reporting positive consequence for positive evaluation",
          skim_variable == "principal_negative_consequences" ~ "Reporting negative consequence for negative evaluation",
          
          skim_variable == "sch_goals_exist" ~ "Existence of school goals *",
          skim_variable == "classroom_observed" ~ "Classroom observed over the last year",
          skim_variable == "discussed_observation" ~ "Observation were discussed",
          skim_variable == "lesson_plan_w_feedback" ~ "Lesson plan was discussed with someone beforehand",
          
          skim_variable == "add_triple_digit_pknw" ~ "Can add triple digits",
          skim_variable == "multiply_double_digit_pknw" ~ "Can multiply double digits",
          skim_variable == "complete_sentence_pknw" ~ "Can complete a simple sentence",
          skim_variable == "experience_pknw" ~ "Has less than 3 year of experience in position"
          
          
       )
    ) %>% 
    
    arrange(skim_variable) %>% bind_cols(breaking_up_all_principal %>% select(-skim_variable)) %>% 
    
    mutate(
       
       All = paste0(mean_var*100, "%"),
       Min = paste0(min_var*100, "%", " (", min_country, ")"),
       Max = paste0(max_var*100, "%", " (", max_country, ")"),
       
    ) %>% rename(`Sub-tasks` = skim_variable) %>% 
    select(`Sub-tasks`, All, Min, Max) %>% 
    
    mutate(Tasks= case_when(
       
       
       str_detect(`Sub-tasks`, "Can|experience") ~ "Principal Knowledge",
       str_detect(`Sub-tasks`, "trained") ~ "School Management Support",
       str_detect(`Sub-tasks`, "observed|discussed") ~ "School Instructional Leadership",
       str_detect(`Sub-tasks`, "goals") ~ "School Principal Management Skills",
       str_detect(`Sub-tasks`, "evaluated|consequence") ~ "School Management Evaluation"
       
    )) %>% 
    arrange(Tasks, `Sub-tasks`) %>% 
    as_grouped_data(., groups = c("Tasks")) %>% 
    flextable() %>% 
    bold(j = c("Tasks"), bold = TRUE) %>% 
    italic(j = c("Tasks"), italic = TRUE) %>% 
    add_footer(Tasks= paste0('Notes: The table presents the responses provided by the principal of each visited schools.All individual country statistics are calculated using country-specific sampling weights. The average for all countries, reported under the heading. “All,” is taken by averaging over the country averages. Names of the countries with the lowest (Min) and highest (Max) score for each item are given in parentheses.
                             * For this indicator, data from Peru are not included as there were not collected.' )) %>% 
    merge_at( j = 1:5, part = "footer") %>%
    add_header_lines("Comparison across countries of sub-indicators for Schools Principals") %>% 
    set_table_properties(layout = "autofit")
 
 
 breaking_up_principal
 
```

Below regression coefficients will be shown between a school practice indicator and its respective policy indicators. For example, teacher content knowledge is regressed on the teacher attraction, selection and deployment, support, and evaluation indicators. Once again, to help account for other factors that might bias these relationships, the urban/rural status of the school, total number of students, and log GDP in the vicinity of the school are included in the regressions.

Clarity of functions is not statistically significantly related to operational management.


```{r}

indicators_list <- c(
               "operational_management" = "Operational Management",
               "sch_management_clarity" = "Clarity of Functions"
               )


reg_fun(indicators_list)

```


Clarity of functions is negatively related to instructional leadership.

```{r}

indicators_list <- c(
               "instructional_leadership" = "Instructional Leadership",
               "sch_management_clarity" = "Clarity of Functions"
               )


reg_fun(indicators_list)

```



None of the school manamagement policy indicators are statistically related to school knowledge.

```{r}

indicators_list <- c(
               "principal_knowledge_score" = "School Knowledge",
               "sch_management_attraction" = "School Management Attraction",
               "sch_selection_deployment" = "School Management Selection & Deployment",
               "sch_support" = "School Management Support",
               "principal_evaluation" = "School Management Evaluation"

               )


reg_fun(indicators_list)

```


Selection and deployment, support, and evaluation are all statistically significantly related to management practices at least at the 5% significance level.  A one unit increase selection and deployment (1-5 scale), as well as support (1-5 scale), is associated with a 0.05 unit increase in management practices (1-5 scale).  A one unit increase in evaluation is associated with a 0.04 unit change.

```{r}

indicators_list <- c(
               "principal_management" = "Management Practices",
               "sch_management_attraction" = "School Management Attraction",
               "sch_selection_deployment" = "School Management Selection & Deployment",
               "sch_support" = "School Management Support",
               "principal_evaluation" = "School Management Evaluation"

               )


reg_fun(indicators_list)

```

### Bureaucracy


Next the relationships between an overall index of the functioning of the bureaucracy in the school district and school level outcomes are shown.  The index is formed by taking the unweighted average of the quality of bureaucracy score, the mandates and accountability score, the national learning goals score, and the impartial decision making score.  Relationships are estimated using OLS regression.  The urban/rural status of the school, the number of students enrolled in the school, and the log GDP within 1km of the school are included in the regressions.^[
Data downloaded from:
https://datacatalog.worldbank.org/dataset/gross-domestic-product-2010 also see
https://preview.grid.unep.ch/index.php?preview=data&events=socec&evcat=1&lang=eng
 In the distributed global GDP dataset sub-national GRP and national GDP data are allocated to 
 30 arc second (approximately 1km) grid cells in proportion to the population residing in that cell. 
 The method also distinguishes between rural and urban population, assuming the latter to have a higher 
 GDP per capita. Input data are from 1) a global time-series dataset of GDP, with subnational gross regional 
 product (GRP) for 74 countries, compiled by the World Bank Development Economics Research Group (DECRG). 2) 
 Gridded population projections for the year 2009, based on a population grid for the year 2005 provided by 
 LandScanTM Global Population Database (Oak Ridge, TN: Oak Ridge National Laboratory). This dataset has been 
 extrapolated to year 2010 by UNEP/GRID-Geneva. Unit is estimated value of production per cell, in thousand of 
 constant 2000 USD. Cell level anomalies may occur due to poor alignment of multiple input data sources, and it 
 is strongly recommended that users attempt to verify information, or consult original sources, in order to determine 
 suitability for a particular application. This product was compiled by DECRG for the Global Assessment Report on Risk 
 Reduction (GAR). It was modeled using global data. Credit: GIS processing World Bank DECRG, Washington, DC, 
 extrapolation UNEP/GRID-Geneva.].  Additionally, a dummy variable for each country is included in the regression to adjust for between country differences in variables.
 
 
```{r breg}

models <- list(
  
'4th Grade Student Knowledge' = feols(student_knowledge ~  bureau_index + log(GDP) + rural + students_enrolled | country, data=combined_school_office_df, se='hetero'),

'Teacher Presence' =  feols(presence_rate ~   bureau_index  + log(GDP) + rural + students_enrolled  | country, data=combined_school_office_df, se='hetero'),

'Teacher Pedagogy' =  feols(teach_score ~   bureau_index + log(GDP) + rural + students_enrolled  | country, data=combined_school_office_df, se='hetero'),

'School Inputs' =  feols(inputs ~   bureau_index + log(GDP) + rural + students_enrolled  | country, data=combined_school_office_df, se='hetero'),

'School Infrastructure' =  feols(infrastructure ~   bureau_index + log(GDP) + rural + students_enrolled  | country, data=combined_school_office_df, se='hetero'),

'Operations Management' =  feols(operational_management ~  bureau_index  + log(GDP) + rural + students_enrolled  | country, data=combined_school_office_df, se='hetero'),

'Principal Management Skills' =  feols(principal_management ~  bureau_index  + log(GDP) + rural + students_enrolled   | country, data=combined_school_office_df, se='hetero')

)



modelsummary(models,
             estimate= "{estimate}{stars}",
             coef_rename = c("bureau_index" = "Bureuacracy Index"),
             coef_omit="GDP|rural|students_enrolled",
             gof_map = gm,
             notes="Regressions also include country fixed effects, the log GDP within 1km of school, urban rural status, and total school enrollment as covariates.",
             escape = FALSE             
             )

```

The next table allows the effect of the bureaucracy index to vary by country.  When this is done the relationship between bureaucracy and 4th grade student knowledge differs between Madagascar and Peru.  The negative relationship between bureaucracy and teacher presence is only statistically significant in Madagascar.  

```{r breg3}

models <- list(
  
'4th Grade Student Knowledge' = feols(student_knowledge ~  bureau_index:country + log(GDP) + rural + students_enrolled | country, data=combined_school_office_df, se='hetero'),

'Teacher Presence' =  feols(presence_rate ~   bureau_index:country  + log(GDP) + rural + students_enrolled  | country, data=combined_school_office_df, se='hetero'),

'Teacher Pedagogy' =  feols(teach_score ~   bureau_index:country + log(GDP) + rural + students_enrolled  | country, data=combined_school_office_df, se='hetero'),

'School Inputs' =  feols(inputs ~   bureau_index:country + log(GDP) + rural + students_enrolled  | country, data=combined_school_office_df, se='hetero'),

'School Infrastructure' =  feols(infrastructure ~   bureau_index:country + log(GDP) + rural + students_enrolled  | country, data=combined_school_office_df, se='hetero'),

'Operations Management' =  feols(operational_management ~  bureau_index:country  + log(GDP) + rural + students_enrolled  | country, data=combined_school_office_df, se='hetero'),

'Principal Management Skills' =  feols(principal_management ~  bureau_index:country  + log(GDP) + rural + students_enrolled   | country, data=combined_school_office_df, se='hetero')

)



modelsummary(models,
             estimate= "{estimate}{stars}",
             coef_rename = c("bureau_index" = "Bureuacracy Index"),
             coef_omit="GDP|rural|students_enrolled",
             gof_map = gm,
             notes="Regressions also include country fixed effects, the log GDP within 1km of school, urban rural status, and total school enrollment as covariates.",
             escape = FALSE             
             )

```

The next table breaks out the effects into the underlying components of the bureaucracy index.

```{r breg2, echo=FALSE}

models <- list(
  
'Student Knowledge' = feols(student_knowledge ~ quality_bureaucracy + national_learning_goals + impartial_decision_making + mandates_accountability  + log(GDP) + rural + students_enrolled  | country, data=combined_school_office_df, se='hetero'),

'Teacher Presence' =  feols(presence_rate ~ quality_bureaucracy + national_learning_goals + impartial_decision_making + mandates_accountability  + log(GDP) + rural + students_enrolled  | country, data=combined_school_office_df, se='hetero'),

'Teacher Pedagogy' =  feols(teach_score ~ quality_bureaucracy + national_learning_goals + impartial_decision_making + mandates_accountability  + log(GDP) + rural + students_enrolled  | country, data=combined_school_office_df, se='hetero'),

'School Inputs' =  feols(inputs ~ quality_bureaucracy + national_learning_goals + impartial_decision_making + mandates_accountability  + log(GDP) + rural + students_enrolled  | country, data=combined_school_office_df, se='hetero'),

'School Infrastructure' =  feols(infrastructure ~ quality_bureaucracy + national_learning_goals + impartial_decision_making + mandates_accountability  + log(GDP) + rural + students_enrolled  | country, data=combined_school_office_df, se='hetero'),

'Operations Management' =  feols(operational_management ~ quality_bureaucracy + national_learning_goals + impartial_decision_making + mandates_accountability  + log(GDP) + rural + students_enrolled  | country, data=combined_school_office_df, se='hetero'),

'Principal Management Skills' =  feols(principal_management ~ quality_bureaucracy + national_learning_goals + impartial_decision_making + mandates_accountability  + log(GDP) + rural + students_enrolled  | country, data=combined_school_office_df, se='hetero')

)



modelsummary(models,
             estimate= "{estimate}{stars}",
             coef_omit="GDP|rural|students_enrolled",
             gof_map = gm,
             notes="Regressions also include country fixed effects, the log GDP within 1km of school, urban rural status, and total school enrollment as covariates.",
             escape = FALSE             
             )

```



# Conclusions

# References



# Supplemental Tables and Figures


The plots below show that the (geodesic) distance between a school and the district office managing the school.

In the first plot, the relationship between distance of the office and average 4th grade student knowledge, according to the 4th grade GEPD assessment, are shown.


```{r distscat, echo=FALSE, fig.width=10, cache=TRUE}

#scatterplot of distance between school and office
school_office_dist_df <- combined_school_office_df %>%
  select(student_knowledge, inputs, infrastructure, principal_management, quality_bureaucracy, bureau_index, dist, dist_km, dist_log, ADM0_NAME) %>%
  mutate(bi_on_target=if_else(bureau_index>=4, "Yes", "No")) %>%
  group_by(ADM0_NAME) %>% #demean outcomes by country
  mutate(student_knowledge_dm=student_knowledge-mean(student_knowledge, na.rm=T),
         dist_log_dm=dist_log-mean(dist_log, na.rm=T),
         inputs_dm=inputs-mean(inputs, na.rm=T),
         infrastructure_dm=infrastructure-mean(infrastructure, na.rm=T))



lab <- eq_plot_txt('student_knowledge', 'dist_log', school_office_dist_df)

p1 <- ggplot(data=school_office_dist_df, aes(x=dist_km, y=student_knowledge)) +
  geom_point() + 
  geom_smooth(method='lm') +
  theme_bw() +
  scale_x_log10(labels=scales::comma) +
  expand_limits(y=c(0,100)) +
  xlab('Log Distance between School and District Office (km)') +
  ylab('Average 4th Grade Student Knowledge Scores at School') +
  geom_richtext(
    aes(x = 20, y = 5,label = lab, hjust=0.2)
  ) +
  ggtitle(str_wrap('Unadjusted ', 100))





school_office_dist_df_on <- school_office_dist_df %>%
  filter(bi_on_target=="Yes")

school_office_dist_df_off <- school_office_dist_df %>%
  filter(bi_on_target=='No')

lab1 <- eq_plot_txt('student_knowledge', 'dist_log', school_office_dist_df_on)
lab2 <- eq_plot_txt('student_knowledge', 'dist_log', school_office_dist_df_off)

  col_pal <- c("#457b9d","#e63946")  
  names(col_pal) <- c( "Yes","No")
  
  
# p2 <- ggplot(data=school_office_dist_df, aes(x=dist_km, y=student_knowledge, color=bi_on_target)) +
#   geom_point() +
#   geom_smooth(method='lm') +
#   theme_bw() +
#   scale_x_log10(labels=scales::comma) +
#   expand_limits(y=c(0,100)) +
#   xlab('Log Distance between School and District Office (km)') +
#   ylab('Average 4th Grade Student Knowledge Scores at School') +
#   scale_color_manual(
#     name="Quality of Bureaucracy Score",
#     labels=c("No"="Caution/Needs Improvement","Yes"="On Target"),
#     values=col_pal,
#     na.translate = F
#   ) +
#   geom_richtext(
#    aes(x = 0.1, y = 5,label = lab2, hjust=0.2), color='#e63946'
#   ) +
#   geom_richtext(
#    aes(x = 10, y = 5,label = lab1, hjust=0.2), color='#457b9d'
#   ) +
#   theme(
#     legend.position = 'bottom'
#   )
# 
# 
# 
# p2

lab2 <- eq_plot_txt('student_knowledge_dm', 'dist_log_dm', school_office_dist_df)

p3 <- ggplot(data=school_office_dist_df, aes(x=dist_log_dm, y=student_knowledge_dm)) +
  geom_point() + 
  geom_smooth(method='lm') +
  theme_bw() +
  expand_limits(y=c(0,100)) +
  xlab('Log Distance between School and District Office (km)') +
  ylab('Average 4th Grade Student Knowledge Scores at School') +
  scale_color_manual(
    name="Bureaucracy Index",
    labels=c("No"="Caution/Needs Improvement","Yes"="On Target"),
    values=col_pal,
    na.translate = F
  )+
  geom_richtext(
   aes(x = 0.1, y = 5,label = lab2, hjust=0.2)
  ) +
  # geom_richtext(
  #  aes(x = 10, y = 5,label = lab1, hjust=0.2), color='#457b9d'
  # ) +
  theme(
    legend.position = 'bottom'
  ) +
  ggtitle(str_wrap(' Demeaned by Country ', 100))


p1 + p3 +
  plot_annotation(title='Scatterplot of Average 4th Grade Student Knowledge Against Distance of School to District Office',
                  caption='Distance is the geodesic distance between the school and office.')


```

In the second plot, the relationship between the distance to the office and school input availability is shown.  This indicator measures the availability of basic inputs in the average school. These inputs, based on the literature and general expectations, are (i) functioning blackboard and chalk, (ii) pens, pencils, and exercise books in 4th-grade classrooms, (iii) textbooks, (iv) basic classroom furniture, and (v) access to ICT.


```{r inputscat, eval=FALSE, fig.width=10, include=FALSE}
lab <- eq_plot_txt('inputs', 'dist_log', school_office_dist_df)

p1 <- ggplot(data=school_office_dist_df, aes(x=dist_km, y=inputs)) +
  geom_point() + 
  geom_smooth(method='lm') +
  theme_bw() +
  scale_x_log10(labels=scales::comma) +
  expand_limits(y=c(0,5)) +
  xlab('Log Distance between School and District Office (km)') +
  ylab('School Input Availability at School') +
  geom_richtext(
    aes(x = 10, y = 1,label = lab, hjust=0.2)
  ) +
  ggtitle(str_wrap('Unadjusted ', 100))






  
  
# p2 <- ggplot(data=school_office_dist_df, aes(x=dist_km, y=inputs, color=bi_on_target)) +
#   geom_point() +
#   geom_smooth(method='lm') +
#   theme_bw() +
#   scale_x_log10(labels=scales::comma) +
#   expand_limits(y=c(0,100)) +
#   xlab('Log Distance between School and District Office (km)') +
#   ylab('Average 4th Grade Student Knowledge Scores at School') +
#   scale_color_manual(
#     name="Quality of Bureaucracy Score",
#     labels=c("No"="Caution/Needs Improvement","Yes"="On Target"),
#     values=col_pal,
#     na.translate = F
#   ) +
#   geom_richtext(
#    aes(x = 0.1, y = 5,label = lab2, hjust=0.2), color='#e63946'
#   ) +
#   geom_richtext(
#    aes(x = 10, y = 5,label = lab1, hjust=0.2), color='#457b9d'
#   ) +
#   theme(
#     legend.position = 'bottom'
#   )
# 
# 
# 
# p2

lab2 <- eq_plot_txt('inputs_dm', 'dist_log_dm', school_office_dist_df)

p3 <- ggplot(data=school_office_dist_df, aes(x=dist_log_dm, y=inputs_dm)) +
  geom_point() + 
  geom_smooth(method='lm') +
  theme_bw() +
  expand_limits(y=c(5)) +
  xlab('Log Distance between School and District Office (km)') +
  ylab('School Input Availability at School') +

  geom_richtext(
   aes(x = -0.1, y = 1,label = lab2, hjust=0.2)
  ) +
  # geom_richtext(
  #  aes(x = 10, y = 5,label = lab1, hjust=0.2), color='#457b9d'
  # ) +
  theme(
    legend.position = 'bottom'
  ) +
  ggtitle(str_wrap(' Demeaned by Country ', 100))


p1 + p3 +
  plot_annotation(title='Scatterplot of Availability of School Inputs Against Distance of School to District Office',
                  caption='Distance is the geodesic distance between the school and office.')


```


In the third plot, the relationship between the distance to the office and school infrastructure availability is shown.  This indicator measures the availability of basic inputs in the average school. The infrastructure aspects included, based on the literature and general expectations, are availability of (i) drinking water, (ii) functioning toilets, (iii) electricity, (iv) internet connectivity, and (v) accessibility for people with disabilities.


```{r infrascat, eval=FALSE, fig.width=10, include=FALSE}
lab <- eq_plot_txt('infrastructure', 'dist_log', school_office_dist_df)

p1 <- ggplot(data=school_office_dist_df, aes(x=dist_km, y=infrastructure)) +
  geom_point() + 
  geom_smooth(method='lm') +
  theme_bw() +
  scale_x_log10(labels=scales::comma) +
  expand_limits(y=c(0,5)) +
  xlab('Log Distance between School and District Office (km)') +
  ylab('School Infrastructure Availability at School') +
  geom_richtext(
    aes(x = 10, y = 1,label = lab, hjust=0.2)
  ) +
  ggtitle(str_wrap('Unadjusted ', 100))






  
  
# p2 <- ggplot(data=school_office_dist_df, aes(x=dist_km, y=inputs, color=bi_on_target)) +
#   geom_point() +
#   geom_smooth(method='lm') +
#   theme_bw() +
#   scale_x_log10(labels=scales::comma) +
#   expand_limits(y=c(0,100)) +
#   xlab('Log Distance between School and District Office (km)') +
#   ylab('Average 4th Grade Student Knowledge Scores at School') +
#   scale_color_manual(
#     name="Quality of Bureaucracy Score",
#     labels=c("No"="Caution/Needs Improvement","Yes"="On Target"),
#     values=col_pal,
#     na.translate = F
#   ) +
#   geom_richtext(
#    aes(x = 0.1, y = 5,label = lab2, hjust=0.2), color='#e63946'
#   ) +
#   geom_richtext(
#    aes(x = 10, y = 5,label = lab1, hjust=0.2), color='#457b9d'
#   ) +
#   theme(
#     legend.position = 'bottom'
#   )
# 
# 
# 
# p2

lab2 <- eq_plot_txt('infrastructure_dm', 'dist_log_dm', school_office_dist_df)

p3 <- ggplot(data=school_office_dist_df, aes(x=dist_log_dm, y=infrastructure_dm)) +
  geom_point() + 
  geom_smooth(method='lm') +
  theme_bw() +
  expand_limits(y=c(5)) +
  xlab('Log Distance between School and District Office (km)') +
  ylab('School Infrastructure Availability at School') +

  geom_richtext(
   aes(x = -0.1, y = 1,label = lab2, hjust=0.2)
  ) +
  # geom_richtext(
  #  aes(x = 10, y = 5,label = lab1, hjust=0.2), color='#457b9d'
  # ) +
  theme(
    legend.position = 'bottom'
  ) +
  ggtitle(str_wrap(' Demeaned by Country ', 100))


p1 + p3 +
  plot_annotation(title='Scatterplot of Availability of School Infrastructure Against Distance of School to District Office',
                  caption='Distance is the geodesic distance between the school and office.')


```


```{r eval=FALSE, include=FALSE}
##### Combining de facto and de jure data for each country ----------

########
## Peru
########

#read in anonymized school data
country <- "PER"
year <- "2019"

confidential_folder <- file.path(paste(confidential_dir,"CNT",country,paste(country,year,"GEPD", sep="_"),paste(country,year,"GEPD_v01_RAW", sep="_"),"Data/confidential/", sep="/"))

PER_policy_df <- haven::read_dta(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/Expert_Survey/expert_dta_final.dta", sep="/"))%>% mutate(country = "PER") 

PER_policy_df <- PER_policy_df %>% 
  setNames(gsub("school", "sch", names(.)))




########
## Jordan
########

#read in anonymized school data
country <- "JOR"
year <- "2019"

confidential_folder <- file.path(paste(confidential_dir,"CNT", paste(country, "-2019"),paste(country,year,"GEPD", sep="_"),paste(country,year,"GEPD_v01_RAW", sep="_"),"Data/confidential/", sep="/"))

JOR_policy_df <- haven::read_dta(file=paste(anonymized_dir,"CNT", 'JOR-19',paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/Expert_Survey/expert_dta_final.dta", sep="/"))%>% mutate(country = "JOR") 



########
## Rwanda
########

#read in anonymized school data
country <- "RWA"
year <- "2020"

confidential_folder <- file.path(paste(confidential_dir,"CNT",country,paste(country,year,"GEPD", sep="_"),paste(country,year,"GEPD_v01_RAW", sep="_"),"Data/confidential/", sep="/"))

RWA_policy_df <- haven::read_dta(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/Expert_Survey/expert_dta_final.dta", sep="/"))%>% mutate(country = "RWA") 


########

########
## Ethiopia
########

#read in anonymized school data
country <- "ETH"
year <- "2020_2021"

confidential_folder <- file.path(paste(confidential_dir,"CNT",country,paste(country,year,"GEPD", sep="_"),paste(country,year,"GEPD_v01_RAW", sep="_"),"Data/confidential/", sep="/"))

ETH_policy_df <- haven::read_dta(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/Policy_Survey/expert_dta_final.dta", sep="/"))%>% mutate(country = "ETH")


########

########
## Madagascar
########

#read in anonymized school data
country <- "MDG"
year <- "2021"

confidential_folder <- file.path(paste(confidential_dir,"CNT",country,paste(country,year,"GEPD", sep="_"),paste(country,year,"GEPD_v01_RAW", sep="_"),"Data/confidential/", sep="/"))

MDG_policy_df <- haven::read_dta(file=paste(anonymized_dir,"CNT", country,paste(country,year,"GEPD", sep="_"), paste(country,year,"GEPD_v01_M", sep="_"),"Data/Policy_Survey/expert_dta_final.dta", sep="/")) %>% mutate(country = "MDG")


#######
# Get the main indicators
#######
#get list of de facto indicators
main_indicator_labels<-c( 
                        'Teaching - Attraction',
                         'Teaching - Selection & Deployment',
                         'Teaching - Support', 
                         'Teaching - Evaluation', 
                         'Teaching - Monitoring & Accountability', 
                         'Teaching - Intrinsic Motivation', 
                         'Inputs & Infrastructure - Standards',
                         'Inputs & Infrastructure - Monitoring',
                         'School Management - Attraction' ,                   
                         'School Management - Selection & Deployment'  ,      
                         'School Management - Support' ,                      
                         'School Management - Evaluation'

    )  
    
    indicators_list<-c(
                       'teacher_attraction', 
                       'teacher_selection_deployment', 
                       'teacher_support', 
                       'teaching_evaluation', 
                       'teacher_monitoring',
                        'intrinsic_motivation', 
                       'standards_monitoring',
                       'sch_monitoring', 
                       'sch_management_attraction', 
                       'sch_selection_deployment', 
                       'sch_support', 
                       'principal_evaluation'

    )


  labels_df_policy<-data.frame(indicators=as.character(indicators_list),
                          indicator_labels=as.character(main_indicator_labels)) 
    


###########
# Combined
##########
    
    #get de facto data
      
    de_facto_function <- function(df, Country_acronyme){
      
    ipw<-df %>% pull(ipw)
  
    df_defacto <- df %>%
      select(hashed_school_code, indicators_list, ipw) %>%
      summarise_at(.vars = indicators_list, wtd.mean, w=ipw, na.rm=TRUE) %>%
      mutate(group="De Facto",
             country = !!Country_acronyme) %>%
      select(group=group, everything())
      
      assign(paste0("data_de_facto_", quo_name(enquo(Country_acronyme))), df_defacto, envir = .GlobalEnv)
      
      
    data_policy_2 <- df_defacto %>%
      mutate_at(.vars=indicators_list, ~as.numeric(sample_n(as_tibble(c(1:5)),1)[1,1])) %>%
      mutate(group="De Jure") %>%
      select(group=group, everything())
    
    
      assign(paste0("data_de_jure_", quo_name(enquo(Country_acronyme))), data_policy_2, envir = .GlobalEnv)

      
    }  
      
    
    for (i in countries) {
      
      df_name <- paste(i,"school_anon_df", sep = "_")
      de_facto_function(get(df_name), i)
      
    }
      
  ##Combined
  names <- lapply(ls(pattern = "^data_de_"), function(x) get(x))
  data_policy_combined <- do.call(rbind, names)
 
  
  data_policy_combined <- data_policy_combined %>% 
    pivot_longer(cols = c(2:12), names_to= "indicators", values_to = "value") %>% 
    left_join(labels_df_policy)
```


```{r eval=FALSE, include=FALSE}

## Relating the policy indicators to practices : TEACHING (DE FACTO)-----


defacto <- data_policy_combined %>% filter(str_detect(group, "Facto")) %>% pivot_wider( id_cols = c("country"),names_from = indicators, values_from = value) %>% 
  left_join(combined_school_office_df %>% select(country, student_knowledge, presence_rate, teach_score, content_knowledge)  %>% mutate(student_knowledge = as.numeric(student_knowledge), presence_rate = as.numeric(presence_rate), teach_score = as.numeric(teach_score), content_knowledge = as.numeric(content_knowledge)))


models <- list(
  
'Student Knowledge' = feols(student_knowledge ~ teacher_attraction  + teaching_evaluation + teacher_selection_deployment + teacher_support + intrinsic_motivation + teacher_monitoring , data=defacto, se='hetero'),

'Teacher Presence' =  feols(presence_rate ~  teacher_attraction  + teaching_evaluation + teacher_selection_deployment + teacher_support + intrinsic_motivation + teacher_monitoring , data=defacto, se='hetero'),

'Teacher Pedagogy' =  feols(teach_score ~  teacher_attraction  + teaching_evaluation + teacher_selection_deployment + teacher_support + intrinsic_motivation + teacher_monitoring , data=defacto, se='hetero'),

'Content Knowledge' =  feols(content_knowledge ~  teacher_attraction  + teaching_evaluation + teacher_selection_deployment + teacher_support + intrinsic_motivation + teacher_monitoring , data=defacto, se='hetero')

)

names(defacto)

modelsummary(models,
             estimate= "{estimate}{stars}",
             gof_map = gm,
             escape = FALSE             
             )




```

```{r eval=FALSE, include=FALSE}
  ## Relating the policy indicators to practices : TEACHING (DE JURE)-----


deJure <- data_policy_combined %>% filter(str_detect(group, "Jure")) %>% pivot_wider( id_cols = c("country"),names_from = indicators, values_from = value) %>% left_join(combined_school_office_df %>% select(iso3c, student_knowledge, presence_rate, teach_score, content_knowledge) %>%  rename(country= iso3c) %>% mutate(student_knowledge = as.numeric(student_knowledge), presence_rate = as.numeric(presence_rate), teach_score = as.numeric(teach_score), content_knowledge = as.numeric(content_knowledge)))


models <- list(
  
'Student Knowledge' = feols(student_knowledge ~ teacher_attraction  + teaching_evaluation + teacher_selection_deployment + teacher_support + intrinsic_motivation + teacher_monitoring , data=deJure, se='hetero'),

'Teacher Presence' =  feols(presence_rate ~  teacher_attraction  + teaching_evaluation + teacher_selection_deployment + teacher_support + intrinsic_motivation + teacher_monitoring , data=deJure, se='hetero'),

'Teacher Pedagogy' =  feols(teach_score ~  teacher_attraction  + teaching_evaluation + teacher_selection_deployment + teacher_support + intrinsic_motivation + teacher_monitoring , data=deJure, se='hetero'),

'Content Knowledge' =  feols(content_knowledge ~  teacher_attraction  + teaching_evaluation + teacher_selection_deployment + teacher_support + intrinsic_motivation + teacher_monitoring , data=deJure, se='hetero')

)

names(defacto)

modelsummary(models,
             estimate= "{estimate}{stars}",
             gof_map = gm,
             escape = FALSE             
             )



```


```{r eval=FALSE, include=FALSE}
  ## Relating the policy indicators to practices : INFRASTRUCTURE (DE FACTO)-----


defacto <- data_policy_combined %>% filter(str_detect(group, "Facto")) %>% pivot_wider( id_cols = c("country"),names_from = indicators, values_from = value) %>% left_join(combined_school_office_df %>% select(iso3c, inputs, student_knowledge, principal_knowledge_score) %>%  rename(country= iso3c) %>% mutate(inputs = as.numeric(inputs), student_knowledge = as.numeric(student_knowledge), principal_knowledge_score = as.numeric(principal_knowledge_score)))

models <- list(
  
'Basic Infrastructure' =  feols(infrastructure ~ standards_monitoring  + monitoring_infrastructure + monitoring_inputs + log(GDP) + rural| ADM0_NAME, data=combined_school_office_df, se='hetero'),
  
'Basic Input' = feols(inputs ~ standards_monitoring  + monitoring_infrastructure + monitoring_inputs + log(GDP) + rural| ADM0_NAME, data=combined_school_office_df, se='hetero'),

'Student Knowledge' =  feols(student_knowledge ~ standards_monitoring  + monitoring_infrastructure + monitoring_inputs + log(GDP) + rural| ADM0_NAME, data=combined_school_office_df, se='hetero'),

'School Knowledge' =  feols(principal_knowledge_score ~ standards_monitoring  + monitoring_infrastructure + monitoring_inputs + log(GDP) + rural| ADM0_NAME, data=combined_school_office_df, se='hetero')

)



modelsummary(models,
             estimate= "{estimate}{stars}",
             gof_map = gm,
             escape = FALSE             
             )
```


```{r eval=FALSE, include=FALSE}
  ## Relating the policy indicators to practices : INFRASTRUCTURE (DE JURE)-----

deJure <- data_policy_combined %>% filter(str_detect(group, "Jure")) %>% pivot_wider( id_cols = c("country"),names_from = indicators, values_from = value) %>% left_join(combined_school_office_df %>% select(iso3c, inputs, student_knowledge, principal_knowledge_score) %>%  rename(country= iso3c) %>% mutate(inputs = as.numeric(inputs), student_knowledge = as.numeric(student_knowledge), principal_knowledge_score = as.numeric(principal_knowledge_score)))

models <- list(
  
'Basic Infrastructure' =  feols(infrastructure ~ standards_monitoring  + monitoring_infrastructure + monitoring_inputs + log(GDP) + rural| ADM0_NAME, data=combined_school_office_df, se='hetero'),
  
'Basic Input' = feols(inputs ~ standards_monitoring  + monitoring_infrastructure + monitoring_inputs + log(GDP) + rural| ADM0_NAME, data=combined_school_office_df, se='hetero'),

'Student Knowledge' =  feols(student_knowledge ~ standards_monitoring  + monitoring_infrastructure + monitoring_inputs + log(GDP) + rural| ADM0_NAME, data=combined_school_office_df, se='hetero'),

'School Knowledge' =  feols(principal_knowledge_score ~ standards_monitoring  + monitoring_infrastructure + monitoring_inputs + log(GDP) + rural| ADM0_NAME, data=combined_school_office_df, se='hetero')

)



modelsummary(models,
             estimate= "{estimate}{stars}",
             gof_map = gm,
             escape = FALSE             
             )
```

```{r eval=FALSE, include=FALSE}
  ## Relating the policy indicators to practices : SCHOOL MANAGEMENT (DE FACTO)-----


defacto <- data_policy_combined %>% filter(str_detect(group, "Facto")) %>% pivot_wider( id_cols = c("country"),names_from = indicators, values_from = value) %>% left_join(combined_school_office_df %>% select(iso3c, operational_management, student_knowledge, principal_knowledge_score, instructional_leadership) %>%  rename(country= iso3c) %>% mutate(operational_management = as.numeric(operational_management), student_knowledge = as.numeric(student_knowledge), principal_knowledge_score = as.numeric(principal_knowledge_score), instructional_leadership = as.numeric(instructional_leadership)))


models <- list(
  
'Student Knowledge' =  feols(student_knowledge ~ sch_management_clarity  + sch_selection_deployment + sch_management_attraction + sch_monitoring + sch_support + log(GDP) + rural| ADM0_NAME, data=combined_school_office_df, se='hetero'),
  
'Operational Management' = feols(operational_management ~ sch_management_clarity  + sch_selection_deployment + sch_management_attraction + sch_monitoring + sch_support  + log(GDP) + rural| ADM0_NAME, data=combined_school_office_df, se='hetero'),

'Instructional Leadership' =  feols(instructional_leadership ~ sch_management_clarity  + sch_selection_deployment + sch_management_attraction + sch_monitoring + sch_support   + log(GDP) + rural| ADM0_NAME, data=combined_school_office_df, se='hetero'),

'School Knowledge' =  feols(principal_knowledge_score ~ sch_management_clarity  + sch_selection_deployment + sch_management_attraction + sch_monitoring + sch_support + log(GDP) + rural| ADM0_NAME, data=combined_school_office_df, se='hetero')

)



modelsummary(models,
             estimate= "{estimate}{stars}",
             gof_map = gm,
             escape = FALSE
             )
```

```{r eval=FALSE, include=FALSE}
  ## Relating the policy indicators to practices : SCHOOL MANAGEMENT (DE JURE)-----


deJure <- data_policy_combined %>% filter(str_detect(group, "Jure")) %>% pivot_wider( id_cols = c("country"),names_from = indicators, values_from = value) %>% left_join(combined_school_office_df %>% select(iso3c, operational_management, student_knowledge, principal_knowledge_score, instructional_leadership) %>%  rename(country= iso3c) %>% mutate(operational_management = as.numeric(operational_management), student_knowledge = as.numeric(student_knowledge), principal_knowledge_score = as.numeric(principal_knowledge_score), instructional_leadership = as.numeric(instructional_leadership)))

models <- list(
  
'Student Knowledge' =  feols(student_knowledge ~ sch_management_clarity  + sch_selection_deployment + sch_management_attraction + sch_monitoring + sch_support + log(GDP) + rural| ADM0_NAME, data=combined_school_office_df, se='hetero'),
  
'Operational Management' = feols(operational_management ~ sch_management_clarity  + sch_selection_deployment + sch_management_attraction + sch_monitoring + sch_support  + log(GDP) + rural| ADM0_NAME, data=combined_school_office_df, se='hetero'),

'Instructional Leadership' =  feols(instructional_leadership ~ sch_management_clarity  + sch_selection_deployment + sch_management_attraction + sch_monitoring + sch_support   + log(GDP) + rural| ADM0_NAME, data=combined_school_office_df, se='hetero'),

'School Knowledge' =  feols(principal_knowledge_score ~ sch_management_clarity  + sch_selection_deployment + sch_management_attraction + sch_monitoring + sch_support + log(GDP) + rural| ADM0_NAME, data=combined_school_office_df, se='hetero')

)



modelsummary(models,
             estimate= "{estimate}{stars}",
             gof_map = gm,
             escape = FALSE             
             )
```


